# http://www.proftpd.org/ - Highly configurable GPL-licensed FTP server software
[buildout]
extends = 
  ../openssl/buildout.cfg
  ../zlib/buildout.cfg

[proftpd-environment]
recipe = collective.recipe.environment
# This component depends on https://nexedi.erp5.net/bug_module/20180402-716ACB/ being fixed

[proftpd-grp]
recipe = collective.recipe.grp

[proftpd]
recipe = slapos.recipe.cmmi
md5sum = 13270911c42aac842435f18205546a1b
url = ftp://ftp.proftpd.org/distrib/source/proftpd-1.3.6.tar.gz
configure-options =
  --enable-openssl
  --enable-nls
  --enable-ctrls
  --with-modules=mod_sftp:mod_ban
  --prefix=${buildout:parts-directory}/${:_buildout_section_name_}
environment = 
  CPPFLAGS=-I${zlib:location}/include -I${openssl:location}/include
  LDFLAGS=-L${zlib:location}/lib -Wl,-rpath=${zlib:location}/lib -L${openssl:location}/lib -Wl,-rpath=${openssl:location}/lib
  install_user=${proftpd-environment:USER}
  install_group=${proftpd-grp:GROUP}


[ftpasswd]
recipe = slapos.recipe.build:download
url = https://raw.githubusercontent.com/proftpd/proftpd/v1.3.6/contrib/ftpasswd
md5sum = 4a47df2cab86d8de7077a445bb416f31
download-only = true
mode = 0700
# TODO: make this script use slapos perl


[proftpd-output]
# Shared binary location to ease migration
recipe = plone.recipe.command
stop-on-error = true
update-command = ${:command}
command = ${coreutils-output:test} -x ${:proftpd} -a -x ${:ftpasswd}

ftpasswd = ${ftpasswd:target}
proftpd = ${proftpd:location}/sbin/proftpd
