[buildout]
extends =
# Build dependencies:
  ../coreutils/buildout.cfg
  ../curl/buildout.cfg
  ../depot_tools/buildout.cfg
  ../git/buildout.cfg
  ../gperf/buildout.cfg
  ../patch/buildout.cfg
  ../pkgconfig/buildout.cfg
# Runtime dependencies:
  ../nspr/buildout.cfg
  ../nss/buildout.cfg

parts =
  headless-chromium

# Note that the Chromium project recommends using their own `fetch' tool
# rather than doing a `git clone', but it should work just fine. I'm not
# sure if slapos.recipe.build:gitclone has a way to set the depth.
#
# Setting depth=1000 is a middle ground between cloning no history
# (causes some scripts to break) and cloning the full history (takes a
# really long time).
[chromium-source]
recipe = plone.recipe.command
command =
  export PATH=$PATH:${git:location}/bin
  git clone ${:repository} ${:location} \
    --branch ${:version} \
    --depth 1000
repository = https://chromium.googlesource.com/chromium/src.git
stop-on-error = true

# We should place the .gclient file in the parent directory of the
# checkout/repository itself.
location = ${:gclient-location}/${:name}
gclient-location = ${buildout:parts-directory}/${:_buildout_section_name_}

# Theoretically the checkout can be put anywhere as long as you specify
# "name" appropriately in the .gclient file, but in practice it seems
# that some automated tools break. It's safest to put it in a directory
# called "src".
name = src

# There's nothing special about version 92.0.4515.107. It just happened
# to be the current Chromium stable version at the time of writing.
version = 92.0.4515.107

# We need to patch Chromium so that it knows where SlapOS installed the
# NSS certificate database (i.e. libnssckbi.so). This is needed because
# Chromium internally uses NSPR to load libnssckbi.so, but NSPR doesn't
# have the NSS installation on its RPATH. We could alternatively
# accomplish this by setting LD_LIBRARY_PATH in a wrapper script.
[nssdb-patch-file]
recipe = slapos.recipe.template:jinja2
template =
  inline:201c201
  <     LoadNSSModule("Root Certs", "libnssckbi.so", nullptr);
  ---
  >     LoadNSSModule("Root Certs", "{{ nssckbi_location }}", nullptr);
rendered = ${:_profile_base_location_}/nssdb.patch
context =
  key nssckbi_location :nssckbi-location
nssckbi-location = ${nss:location}/lib/libnssckbi.so

[headless-chromium]
recipe = slapos.recipe.cmmi
path = ${chromium-source:location}
location = ${:path}/out/headless

# Configuration file for GN, the tool to build the actual compilation
# configuration file.
default-gclient-config =
  solutions = [
    {
      "name": "${chromium-source:name}",
      "url": "${chromium-source:repository}",
      "managed": False,
      "custom_deps": {},
      "custom_vars": {},
    },
  ]

# Build configuration options
build-config-options =
  import("//build/args/headless.gn")
  is_debug = false
  symbol_level = 0
  blink_symbol_level = 0

  # We need to unbundle the build toolchain in order to set our own
  # LDFLAGS.
  custom_toolchain = "//build/toolchain/linux/unbundle:default"
  host_toolchain = "//build/toolchain/linux/unbundle:default"
  current_os = "linux"
  current_cpu = "x64"

# Chromium bundles its own LLVM toolchain, so we might as well use it.
llvm-toolchain = ${:path}/third_party/llvm-build/Release+Asserts/bin

configure-command =
# Sync build dependencies---this is a little finnicky.
  echo '${:default-gclient-config}' \
    > ${chromium-source:gclient-location}/.gclient
  gclient sync --no-history
# Apply the NSS patch.
  patch ${path}/crypto/nss_util.cc ${nssdb-patch-file:rendered}
# Generate build configuration files.
  mkdir -p ${:location}
  echo '${:build-config-options}' > ${:location}/args.gn
  gn gen ${:location}

# You can run the headless Chromium shell using
# ${:binary} --remote-debugging-port=1234
make-binary =
  autoninja -C ${:location} headless_shell
environment =
  PATH=${depot_tools:location}:${gperf:location}/bin:${pkgconfig:location}/bin:${coreutils:location}/bin:${git:location}/bin:${curl:location}/bin:${patch:location}/bin:%(PATH)s
  LDFLAGS="-Wl,-rpath=${nss:location}/lib,-rpath=${nspr:location}/lib"
  CC="${:llvm-toolchain}/clang"
  CXX="${:llvm-toolchain}/clang++"
  AR="${:llvm-toolchain}/llvm-ar"
  NM="${:llvm-toolchain}/llvm-nm"

# Expose devtools frontend location.
devtools-frontend = ${:location}/gen/third_party/devtools-frontend/src/front_end

binary = ${:location}/headless_shell
promises = ${:binary}
