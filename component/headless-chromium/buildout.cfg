[buildout]
extends =
  ../bison/buildout.cfg
  ../dbus/buildout.cfg
  ../gperf/buildout.cfg
  ../ninja/buildout.cfg
  ../freetype/buildout.cfg
  ../cmake/buildout.cfg
  ../git/buildout.cfg
  ../mpfr/buildout.cfg
  ../pkgconfig/buildout.cfg
  ../cups/buildout.cfg
  ../coreutils/buildout.cfg
  ../findutils/buildout.cfg
  ../fontconfig/buildout.cfg
  ../gettext/buildout.cfg
  ../glib/buildout.cfg
  ../gtk-2/buildout.cfg
  ../libexpat/buildout.cfg
  ../libffi/buildout.cfg
  ../libpng/buildout.cfg
  ../libxml2/buildout.cfg
  ../mesa/buildout.cfg
  ../nspr/buildout.cfg
  ../nss/buildout.cfg
  ../pcre/buildout.cfg
  ../sqlite3/buildout.cfg
  ../xorg/buildout.cfg
  ../zlib/buildout.cfg

parts +=
  depot_tools
  chromium

[depot_tools]
recipe = plone.recipe.command
location = ${buildout:directory}/parts/depot_tools
depot_tools-repository = https://chromium.googlesource.com/chromium/tools/depot_tools.git
git-binary = ${git:location}/bin/git
command = ([ -d ${:location} ] && ls || ${:git-binary} clone ${:depot_tools-repository} ${:location} && ls ${freetype:location} && ls ${pkgconfig:location} && ls ${dbus:location} && ls ${bison:location} && ls ${gperf:location})
update-command = command

[chromium]
recipe = slapos.recipe.cmmi
path = ${buildout:directory}/parts/chromium
configure-command =
  mkdir ${:path} && cd ${:path}
  fetch --nohooks chromium
  cd src
  gclient runhooks
  mkdir -p out/Headless
  echo 'import("//build/args/headless.gn")' > out/Headless/args.gn
  echo 'is_debug = false' >> out/Headless/args.gn
  gn gen out/Headless

make-binary = cd src && ls && ninja -C out/Headless headless_shell
environment =
  PKG_CONFIG_PATH=${freetype:location}/lib/pkgconfig:${zlib:location}/lib/pkgconfig:${libpng:location}/lib/pkgconfig:$PKG_CONFIG_PATH
  PATH=${depot_tools:location}:${pkgconfig:location}/bin:${ninja:path}/:${bison:location}/bin:${gperf:location}/bin:%(PATH)s
  CPATH=${dbus:location}/include/dbus-1.0:${dbus:location}/lib/dbus-1.0/include/:${freetype:location}/include/freetype2:${libffi:location}/include:${mpfr:location}/include:${ncurses:location}/include:${openssl:location}/include:${readline:location}/include:${sqlite3:location}/include:${zlib:location}/include:${bzip2:location}/include:$CPATH
  LD_LIBRARY_PATH=$LD_LIBRARY_PATH:${atk:location}/lib:${cairo:location}/lib:${cups:location}/lib:${dbus:location}/lib/":${dbus-glib:location}/lib/:${fontconfig:location}/lib/:${gdk-pixbuf:location}/lib:${gettext:location}/lib:${glib:location}/lib:${gtk-2:location}/lib:${harfbuzz:location}/lib:${libX11:location}/lib:${libXau:location}/lib:${libXcomposite:location}/lib:${libXcursor:location}/lib:${libXext:location}/lib:${libXi:location}/lib:${libXrender:location}/lib/:${libXtst:location}/lib:${libexpat:location}/lib:${libffi:location}/lib:${libpng:location}/lib:${libpng12:location}/lib:${libxcb:location}/lib:${libxml2:location}/lib:${mesa:location}/lib:${nspr:location}/lib:${nss:location}/lib:${pango:location}/lib:${pcre:location}/lib:${pixman:location}/lib:${sqlite3:location}/lib:${xdamage:location}/lib:${xfixes:location}/lib:${zlib:location}/lib