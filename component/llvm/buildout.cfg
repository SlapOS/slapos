[buildout]
extends =
    ../xz-utils/buildout.cfg
    ../cmake/buildout.cfg
    ../git/buildout.cfg

parts = llvm

[llvm-version]
version = 15.0.0

[llvm-cmake]
recipe = slapos.recipe.build:download-unpacked
shared = true
url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${llvm-version:version}/cmake-${llvm-version:version}.src.tar.xz
md5sum = e2e69ec36e163293f0b558e0382660cb
environment =
  PATH=${xz-utils:location}/bin:%(PATH)s

[llvm-clang]
recipe = slapos.recipe.build:download-unpacked
shared = true
url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${llvm-version:version}/clang-${llvm-version:version}.src.tar.xz
md5sum = ff48dab9de875ca48736a97fdde60ced
environment =
  PATH=${xz-utils:location}/bin:%(PATH)s

[llvm-lld]
recipe = slapos.recipe.build:download-unpacked
shared = true
url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${llvm-version:version}/lld-${llvm-version:version}.src.tar.xz
md5sum = 5293c1ea3bb76cb0586ae01fb53231a6
environment =
  PATH=${xz-utils:location}/bin:%(PATH)s

[llvm-libunwind]
recipe = slapos.recipe.build:download-unpacked
shared = true
url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${llvm-version:version}/libunwind-${llvm-version:version}.src.tar.xz
md5sum = 9b94d6cb031792b14cbfb58386e68ac2
environment =
  PATH=${xz-utils:location}/bin:%(PATH)s

[llvm]
recipe = slapos.recipe.cmmi
shared = true
url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${llvm-version:version}/llvm-${llvm-version:version}.src.tar.xz
md5sum = 7b406c97f87b94cda4224aa53968c9d5
pre-configure =
  cp ${llvm-cmake:location}/Modules/* ./cmake/modules/
  mkdir ../clang
  cp -r ${llvm-clang:location}/* ../clang/
  # we need to give permission so that at the end of cmmi, we can delete it
  chmod -R u+rw ../clang
  mkdir ../lld
  cp -r ${llvm-lld:location}/* ../lld/
  # we need to give permission so that at the end of cmmi, we can delete it
  chmod -R u+rw ../lld
  mkdir ../libunwind
  cp -r ${llvm-libunwind:location}/* ../libunwind/
  # we need to give permission so that at the end of cmmi, we can delete it
  chmod -R u+rw ../libunwind
configure-command = ${cmake:location}/bin/cmake
configure-options =
    -Bbuild
    -DCMAKE_INSTALL_PREFIX=@@LOCATION@@
    -DCMAKE_BUILD_TYPE=Release
    -DLLVM_INSTALL_UTILS=ON
    -DLLVM_INCLUDE_BENCHMARKS=OFF
    -DCMAKE_C_FLAGS="${:CMAKE_CFLAGS}"
    -DCMAKE_CXX_FLAGS="${:CMAKE_CFLAGS}"
    -DLLVM_ENABLE_PROJECTS="clang;libunwind;lld"
make-options = -C build
CMAKE_CFLAGS = -I${libxml2:location}/include/libxml2 -I${ncurses:location}/include -I${zlib:location}/include
environment =
    PATH=${xz-utils:location}/bin:${git:location}/bin:%(PATH)s
    LDFLAGS=-L${libxml2:location}/lib -L${ncurses:location}/lib -L${zlib:location}/lib -Wl,-rpath=${libxml2:location}/lib -Wl,-rpath=${ncurses:location}/lib -Wl,-rpath=${zlib:location}/lib
