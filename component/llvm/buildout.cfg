[buildout]
extends =
    ../xz-utils/buildout.cfg
    ../cmake/buildout.cfg
    ../git/buildout.cfg

parts = llvm

[llvm-cmake]
recipe = slapos.recipe.build:download-unpacked
shared = true
url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${:version}/cmake-${:version}.src.tar.xz
version = 19.1.1
md5sum = f39c355dd12b8b2034756da6c76cd58a
environment =
  PATH=${xz-utils:location}/bin:%(PATH)s

[llvm-third-party]
recipe = slapos.recipe.build:download-unpacked
shared = true
url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${:version}/third-party-${:version}.src.tar.xz
version = 19.1.1
md5sum = 26a27ac861796f5f7925b1c1ea7ac568
environment =
  PATH=${xz-utils:location}/bin:%(PATH)s

[llvm]
recipe = slapos.recipe.cmmi
shared = false
url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${:version}/llvm-${:version}.src.tar.xz
version = 19.1.1
md5sum = 5bd5e48e5e40b80cd2166f0279b8f38c
pre-configure =
  mkdir ../cmake ./third-party
  cp ${llvm-cmake:location}/Modules/* ./cmake/modules/
  cp -r --no-preserve=mode ${llvm-third-party:location}/* ./third-party/
  ln -sf $(realpath ./cmake/modules/) ../cmake/Modules
  ln -sf $(realpath ./third-party/) ../third-party
configure-command = ${cmake:location}/bin/cmake
configure-options =
    -Bbuild
    -DCMAKE_INSTALL_PREFIX=@@LOCATION@@
    -DCMAKE_BUILD_TYPE=Release
    -DLLVM_INSTALL_UTILS=ON
    -DLLVM_INCLUDE_BENCHMARKS=OFF
    -DCMAKE_MODULE_PATH=./cmake/modules/
    -DCMAKE_C_FLAGS="${:CMAKE_CFLAGS}"
    -DCMAKE_CXX_FLAGS="${:CMAKE_CFLAGS}"
make-options = -C build
#pre-install =
#  chmod -R +w .
#  rm -f ../cmake/Modules ../third-party
CMAKE_CFLAGS = -I${libxml2:location}/include/libxml2 -I${ncurses:location}/include -I${zlib:location}/include
environment =
    PATH=${xz-utils:location}/bin:${git:location}/bin:%(PATH)s
    LDFLAGS=-L${libxml2:location}/lib -L${ncurses:location}/lib -L${zlib:location}/lib -Wl,-rpath=${libxml2:location}/lib -Wl,-rpath=${ncurses:location}/lib -Wl,-rpath=${zlib:location}/lib
