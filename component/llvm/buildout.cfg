[buildout]
extends =
    ../xz-utils/buildout.cfg
    ../cmake/buildout.cfg
    ../git/buildout.cfg

parts = llvm

# ---------------------------------------------------------
[llvm-cmake]
recipe = slapos.recipe.build:download-unpacked
# version = 20.1.4
# md5sum = 0ed9f8df1ab853f86d37ffcc1e464d32
version = 19.1.7
md5sum = 52b5249a06305e19c3bdae2e972c99c3
shared = true
url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${:version}/cmake-${:version}.src.tar.xz
environment =
  PATH=${xz-utils:location}/bin:%(PATH)s


# ---------------------------------------------------------
[llvm]
recipe = slapos.recipe.cmmi
shared = true
# url = https://github.com/llvm/llvm-project/releases/download/llvmorg-${:version}/llvm-${:version}.src.tar.xz
path = ${llvm-src:location}
# version = 19.1.7
# md5sum = 45229744809103ad151e3757a0f21d3d
# pre-configure =
#   mkdir -p ../cmake/Modules && \
#   cp ${llvm-cmake:location}/Modules/* ../cmake/Modules/
pre-configure =
    mkdir -p build
configure-command = ${cmake:location}/bin/cmake
configure-options =
    -Bbuild
    -DCMAKE_INSTALL_PREFIX=@@LOCATION@@
    -DCMAKE_BUILD_TYPE=Release
    -DLLVM_ENABLE_PROJECTS=clang
    -DLLVM_INSTALL_UTILS=ON
    -DLLVM_INCLUDE_BENCHMARKS=OFF
    -DLLVM_INCLUDE_TESTS=OFF
    -DCMAKE_C_FLAGS="${:CMAKE_CFLAGS}"
    -DCMAKE_CXX_FLAGS="${:CMAKE_CFLAGS}"
    -G "Unix Makefiles" llvm
make-options = -C build
CMAKE_CFLAGS = -I${libxml2:location}/include/libxml2 -I${ncurses:location}/include -I${zlib:location}/include
environment =
    PATH=${xz-utils:location}/bin:${git:location}/bin:%(PATH)s
    LDFLAGS=-L${libxml2:location}/lib -L${ncurses:location}/lib -L${zlib:location}/lib -Wl,-rpath=${libxml2:location}/lib -Wl,-rpath=${ncurses:location}/lib -Wl,-rpath=${zlib:location}/lib

[llvm-src]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/llvm/llvm-project.git
branch = release/19.x
depth = 1
location = ${buildout:parts-directory}/${:_buildout_section_name_}
git-executable = ${git:location}/bin/git
