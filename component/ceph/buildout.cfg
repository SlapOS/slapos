[buildout]
extends =
  ../boost-lib/buildout.cfg
  ../cmake/buildout.cfg
  ../cryptsetup/buildout.cfg
  ../curl/buildout.cfg
  ../keyutils/buildout.cfg
  ../libcap/buildout.cfg
  ../libnbd/buildout.cfg
  ../libnl/buildout.cfg
  ../macros/macro.pythonpath.eggs.cfg
  ../ncurses/buildout.cfg
  ../ninja/buildout.cfg
  ../openssl/buildout.cfg
  ../patch/buildout.cfg
  ../python-PyYAML/buildout.cfg
  ../snappy/buildout.cfg
  ../systemd/buildout.cfg
  ../util-linux/buildout.cfg
  ../zlib/buildout.cfg
  ../pkgconfig/buildout.cfg


[librbd-env]
PATH = ${cmake:location}/bin:${ninja:location}/bin:${pkgconfig:location}/bin:%(PATH)s

[librbd-pythonpath]
<= macro.pythonpath.eggs
environment = librbd-env
eggs =
  ${python-PyYAML:egg}

[librbd]
# CEPH only for librbd
recipe = slapos.recipe.cmmi
shared = true
url = https://download.ceph.com/tarballs/ceph_19.2.3.orig.tar.gz
md5sum = 6e7082b1ad93745bb28094ae7d72c77f

# Note: SlapOSifying whole ceph, including it's managers, is an enormous effort
#       so only "librbd" is provided with header files and this requires
#       careful selection and ordering of ninja's targets and also manual
#       copying of common library
configure-command = cmake
make-binary = ninja -C build librbd librados
make-targets = src/librbd/install src/librados/install src/common/install src/include/install ; cp build/lib/libceph-common.so build/lib/libceph-common.so.2 %(location)s/lib ; cd %(location)s/lib

patch-binary = ${patch:location}/bin/patch
patch-options = -p1
patches =
  ${:_profile_base_location_}/ceph-minimal.patch#a84c4d30586c8b8f87a581fed5fbf5d8
# backported fixes for gcc 13 and gcc 14
  https://github.com/ceph/ceph/commit/796ce63667b460ba9b8d40891f30e45981ba237a.patch?full_index=1#84a5fe6ed9682f382be45c3bfb9e9ff2
  https://github.com/ceph/ceph/commit/0eace4ea9ea42412d4d6a16d24a8660642e41173.patch?full_index=1#26b4da331d6140140d020c7846f09137

CMAKE_LIBRARY_PATH="${util-linux:location}/lib;${ncurses:location}/lib;${keyutils:location}/x86_64-linux-gnu;${cryptsetup:location}/lib;${snappy:location}/lib;${systemd:location}/lib64;${zlib:location}/lib;${libnl:location}/lib;${boost-lib:location}/lib;${curl:location}/lib;${openssl:location}/lib;${libcap:location}/lib;${libnbd:location}/lib"
CMAKE_INCLUDE_PATH="${systemd:location}/include;${util-linux:location}/include;${boost-lib:location}/include;${ncurses:location}/include;${keyutils:location}/include;${cryptsetup:location}/include;${snappy:location}/include;${zlib:location}/include;${libnl:location}/include;${curl:location}/include;${openssl:location}/include;${libcap:location}/include;${libnbd:location}/include"

environment = librbd-env
configure-options =
  -DCMAKE_BUILD_TYPE=RelWithDebInfo
  -DCMAKE_INCLUDE_PATH=${:CMAKE_INCLUDE_PATH}
  -DCMAKE_INSTALL_PREFIX=%(location)s
  -DCMAKE_INSTALL_RPATH=%(location)s/lib
  -DCMAKE_LIBRARY_PATH=${:CMAKE_LIBRARY_PATH}
  -DDEBUG_GATHER=OFF
  -DWITH_BABELTRACE=OFF
  -DWITH_BLUESTORE=OFF
  -DWITH_BLUESTORE_PMEM=OFF
  -DWITH_CEPHFS=OFF
  -DWITH_FUSE=OFF
  -DWITH_GRAFANA=OFF
  -DWITH_JAEGER=OFF
  -DWITH_KRBD=OFF
  -DWITH_LIBCEPHFS=OFF
  -DWITH_LIBCEPHSQLITE=OFF
  -DWITH_LIBURING=OFF
  -DWITH_LTTNG=OFF
  -DWITH_LZ4=OFF
  -DWITH_MANPAGE=OFF
  -DWITH_MGR=OFF
  -DWITH_MGR_DASHBOARD_FRONTEND=OFF
  -DWITH_OPENLDAP=OFF
  -DWITH_QATDRV=OFF
  -DWITH_QATLIB=OFF
  -DWITH_QATZIP=OFF
  -DWITH_RADOSGW=OFF
  -DWITH_RADOSGW_AMQP_ENDPOINT=OFF
  -DWITH_RADOSGW_ARROW_FLIGHT=OFF
  -DWITH_RADOSGW_BACKTRACE_LOGGING=OFF
  -DWITH_RADOSGW_BEAST_OPENSSL=OFF
  -DWITH_RADOSGW_D4N=OFF
  -DWITH_RADOSGW_DAOS=OFF
  -DWITH_RADOSGW_DBSTORE=OFF
  -DWITH_RADOSGW_KAFKA_ENDPOINT=OFF
  -DWITH_RADOSGW_LUA_PACKAGES=OFF
  -DWITH_RADOSGW_MOTR=OFF
  -DWITH_RADOSGW_POSIX=OFF
  -DWITH_RADOSGW_SELECT_PARQUET=OFF
  -DWITH_RBD=ON
  -DWITH_RDMA=OFF
  -DWITH_SEASTAR=OFF
  -DWITH_SYSTEMD=OFF
  -DWITH_SYSTEM_BOOST=ON
  -DWITH_SYSTEM_ROCKSDB=OFF
  -DWITH_TESTS=OFF
  -DWITH_XFS=OFF
  -GNinja
  -S . -B build
