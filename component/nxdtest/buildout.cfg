[buildout]
extends =
  ../pygolang/buildout.cfg
  ../util-linux/buildout.cfg
  ../git/buildout.cfg


[nxdtest]
recipe  = zc.recipe.egg:scripts
eggs    = ${pygolang:egg}
          ${nxdtest-egg:egg}
scripts = nxdtest
# convenience for nxdtest users
exe     = ${buildout:bin-directory}/nxdtest

# nxdtest respawns itself via sys.executable and needs recent unshare.
initialization =
    # sys.path -> $PYTHONPATH (see e.g. https://github.com/ipython/ipython/issues/5420)
    # TODO better adjust zc.recipe.egg:scripts to do this automatically
    import os
    pypath  = sys.path[:]
    pypath += os.environ.get('PYTHONPATH', [])
    os.environ['PYTHONPATH'] = ':'.join(pypath)

    # $PATH for unshare and mount
    ospath = os.environ.get('PATH', '')
    if ospath != '':
        ospath = ':' + ospath
    os.environ['PATH'] = '${util-linux:location}/bin' + ospath


[nxdtest-egg]
recipe  = zc.recipe.egg:develop
setup   = ${nxdtest-repository:location}
egg     = nxdtest

[nxdtest-repository]
recipe  = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/nexedi/nxdtest.git
revision = 9f413221
location = ${buildout:parts-directory}/nxdtest
git-executable = ${git:location}/bin/git
