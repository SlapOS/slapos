# HAProxy - The Reliable, High Performance TCP/HTTP Load Balancer
# http://haproxy.1wt.eu/

[buildout]
extends =
  ../lua/buildout.cfg
  ../openssl/buildout.cfg
  ../pcre/buildout.cfg
  ../zlib/buildout.cfg

parts = haproxy

[haproxy]
recipe = slapos.recipe.cmmi
shared = true
url = https://www.haproxy.org/download/3.2/src/haproxy-3.2.10.tar.gz
md5sum = 64415b86e09bf4ae738b9abd4caaca81
configure-command = true
# for Linux kernel 2.6.28 and above, we use "linux-glibc" as the TARGET,
# otherwise use "generic".
TARGET="$(uname -sr 2>/dev/null|grep -Eq '^Linux (2\.6\.2[89]|2\.6\.[3-9]|[3-9])' && echo linux-glibc || echo generic)"
CPU_FLAGS=-march=generic
# For ARCH_FLAGS value the -m32 or -m64 are expected, so select correct one.
ARCH_FLAGS="$(uname -m 2>/dev/null|grep -qE '64' && echo -m64 || echo -m32)"

# By default haproxy is build w/o QUIC support
SSL_INC=${openssl:location}/include
SSL_LIB=${openssl:location}/lib
SSL_ADDLIB=-Wl,-rpath=${openssl:location}/lib
QUIC=

make-options =
  TARGET=${:TARGET}
  CPU_FLAGS=${:CPU_FLAGS}
  ARCH_FLAGS=${:ARCH_FLAGS}
  PREFIX=@@LOCATION@@
  USE_DL=1
  USE_LUA=1
  LUA_INC=${lua:location}/include
  LUA_LIB=${lua:location}/lib
  USE_OPENSSL=1
  SSL_INC=${:SSL_INC}
  SSL_LIB=${:SSL_LIB}
  ${:QUIC}
  USE_PCRE=1
  USE_ZLIB=1
  USE_PROMEX=1
  ZLIB_INC=${zlib:location}/include
  ZLIB_LIB=${zlib:location}/lib
  ADDLIB="${:SSL_ADDLIB} -Wl,-rpath=${pcre:location}/lib -Wl,-rpath=${zlib:location}/lib"
environment =
  PATH=${pcre:location}/bin:%(PATH)s

[haproxy-quic]
<= haproxy

SSL_INC=${openssl-3.6:location}/include
SSL_LIB=${openssl-3.6:location}/lib
SSL_ADDLIB=-Wl,-rpath=${openssl-3.6:location}/lib
QUIC=USE_QUIC=1


