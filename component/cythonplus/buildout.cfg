[buildout]
extends =
  ../defaults.cfg
  ../git/buildout.cfg
  ../numpy/buildout.cfg

parts = cythonplus_env.sh

[gcc]
part = gcc-10.2
min_version = 10.2

[python]
part = python3

# Dependencies for the Cython+ test suite
[eggs]
recipe = zc.recipe.egg
eggs =
  ${numpy:egg}
  coverage
  pycodestyle

[cythonplus-repository]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/nexedi/cython.git
git-executable = ${git:location}/bin/git
sparse-checkout = /.gitignore

[cythonplus_env.sh]
recipe = slapos.recipe.template:jinja2
rendered = ${buildout:directory}/${:_buildout_section_name_}
template =
  inline:{% set path, python = os.path.split(python) -%}
  {% if 'part' in gcc -%}
  {%   set path = path + ':' + gcc.prefix + '/bin' -%}
  {% endif -%}
  export PATH={{ path }}$${PATH:+:$PATH}
  export PYTHON={{ python }}
  export PYTHONPATH={{ cythonplus_repository }}$${PYTHONPATH:+:$PYTHONPATH}
  export PYTHONPATH={{ ':'.join(easy_install.working_set(eggs['eggs'].split(), [
      eggs['develop-eggs-directory'],
      eggs['eggs-directory'],
    ]).entries) }}$${PYTHONPATH:+:$PYTHONPATH}
  {# Set path to libintl needed for cython EmbedTest #}
  export LD_RUN_PATH={{ gettext }}/lib$${LD_RUN_PATH:+:$LD_RUN_PATH}
  export LIBRARY_PATH={{ gettext }}/lib$${LIBRARY_PATH:+:$LIBRARY_PATH}
context =
  section gcc gcc
  section eggs eggs
  key cythonplus_repository cythonplus-repository:location
  key python python:executable
  key gettext gettext:location
  import os os
  import easy_install zc.buildout.easy_install

[versions]
slapos.recipe.template = 4.4
coverage = 4.5.1
pycodestyle = 2.5.0
