# Apache Tomcat - an open source software implementation of the Java Servlet and JavaServer Pages technologies.
# http://tomcat.apache.org/

[buildout]

parts =
  tomcat

[tomcat]
<= tomcat9

[tomcat-base]
recipe = slapos.recipe.build:download-unpacked
shared = true
strip-top-level-dir = true
url = https://archive.apache.org/dist/tomcat/tomcat-${:version-major}/v${:version}/bin/apache-tomcat-${:version}.tar.gz

[tomcat-base:os.path.exists('/nix/store') and os.path.exists('/etc/NIXOS')]
recipe = slapos.recipe.build
shared = true
install =
  import os, subprocess, pathlib

  location = options['location']
  version = options['version-major']

  bin_dir = pathlib.Path(location) / "bin"
  bin_dir.mkdir(parents=True, exist_ok=True)

  lib_dir = pathlib.Path(location) / "lib"
  lib_dir.mkdir(parents=True, exist_ok=True)

  # tomcat7 has been removed from nixpkg
  if version == '7':
    ref = "141439f6f11537ee349a58aaf97a5a5fc072365c"
    subprocess.check_call(["nix", "build", f"github:nixos/nixpkgs/{ref}#tomcat7"])
  else:
    subprocess.check_call(["nix", "build", f"nixpkgs#tomcat{version}"])

  for f in pathlib.Path("result/bin").iterdir():
      target = bin_dir / f.name
      print(f"Linking {f} -> {target}")
      if target.exists() or target.is_symlink():
          target.unlink()
      target.symlink_to(f.resolve())

  for f in pathlib.Path("result/lib").iterdir():
      target = lib_dir / f.name
      print(f"Linking {f} -> {target}")
      if target.exists() or target.is_symlink():
          target.unlink()
      target.symlink_to(f.resolve())

[tomcat7]
<= tomcat-base
version-major = 7
version = 7.0.100
md5sum = 79be4ba5a6e770730a4be3d5cb3c7862

[tomcat7-output]
# Shared binary location to ease migration
recipe = plone.recipe.command
stop-on-error = true
update-command = ${:command}
command = ${coreutils-output:test} -x ${:catalina}
catalina = ${tomcat7:location}/bin/catalina.sh

[tomcat9]
<= tomcat-base
version-major = 9
version = 9.0.12
md5sum = 7283da4a3a6e939adcd8f919be4ba41a

[tomcat10]
<= tomcat-base
version-major = 10
version = 10.0.23
md5sum = 820ca70d01adf99d602615fb8d648162
