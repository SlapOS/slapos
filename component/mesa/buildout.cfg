[buildout]
extends =
  ../bison/buildout.cfg
  ../cmake/buildout.cfg
  ../flex/buildout.cfg
  ../libexpat/buildout.cfg
  ../libtool/buildout.cfg
  ../meson/buildout.cfg
  ../ninja/buildout.cfg
  ../pkgconfig/buildout.cfg
  ../xorg/buildout.cfg
  ../xz-utils/buildout.cfg
  ../zlib/buildout.cfg

parts =
  mesa


[glslang]
recipe = slapos.recipe.cmmi
url = https://github.com/KhronosGroup/glslang/archive/refs/tags/13.1.1.tar.gz
md5sum = 65fc5f9ed3440ff7ccd9760327ba1083
shared = true
configure-command = cmake
configure-options =
  -Bbuild
  -DCMAKE_INSTALL_PREFIX=@@LOCATION@@
  -DCMAKE_BUILD_TYPE=Release
  -DENABLE_OPT=0
make-options = -C build
environment =
  PATH=${cmake:location}/bin:%(PATH)s
patches =
  ${:_profile_base_location_}/glslang-explicitly-add-lstdc-fs-for-gcc-8.patch#f2653242e36444de52d65fee601d8670
patch-options = -p1

[mesa-markupsafe-download]
recipe = slapos.recipe.build:download
shared = true
url = https://files.pythonhosted.org/packages/bf/10/ff66fea6d1788c458663a84d88787bae15d45daa16f6b3ef33322a51fc7e/${:filename}
filename = MarkupSafe-2.0.1.tar.gz
md5sum = 892e0fefa3c488387e5cc0cad2daa523

[mesa-mako-download]
recipe = slapos.recipe.build:download
shared = true
url = https://files.pythonhosted.org/packages/24/3b/11fe92d68c6a42468ddab0cf03f454419b0788fff4e91ba46b8bebafeffd/${:filename}
filename = Mako-1.3.0-py3-none-any.whl
md5sum = 3768c14b8a92597920b2ffd9c9195c82


[mesa-python]
recipe = slapos.recipe.build
shared = true
markupsafe = ${mesa-markupsafe-download:target}
mako = ${mesa-mako-download:target}

install =
  import os, sys
  call([sys.executable, '-m', 'venv', '--clear', location])
  pip = os.path.join(location, 'bin', 'pip')
  # call([pip, 'install', '--no-index', options['markupsafe']])
  # call([pip, 'install', '--no-index', options['mako']])
  call([pip, 'install', '--no-index', options['markupsafe'], options['mako']])
  # selftest
  python = os.path.join(location, 'bin', 'python')
  call([python, '-c', 'from mako.template import Template'])

[mesa]
recipe = slapos.recipe.cmmi
shared = true
url = https://archive.mesa3d.org/mesa-23.2.1.tar.xz
md5sum = 0d89ec154ac9f06a1e876214114ed9af
configure-command = ${meson:location}/bin/meson builddir -Dprefix=@@LOCATION@@ --libdir=lib -Dgallium-drivers=virgl -Dvulkan-drivers=[] -Dplatforms=x11 -Dlibunwind=disabled -Dglx=dri -Dllvm=disabled -Degl=enabled
make-binary = ninja -C builddir
todo =
  Run-time dependency libzstd found: NO (tried pkgconfig and cmake)
  Run-time dependency libomxil-bellagio found: NO (tried pkgconfig and cmake)
  Run-time dependency libtizonia found: NO (tried pkgconfig and cmake)
  Run-time dependency libtizplatform found: NO (tried pkgconfig and cmake)
  Run-time dependency tizilheaders found: NO (tried pkgconfig and cmake)
  Run-time dependency libva found: NO (tried pkgconfig and cmake)

todo =
  --disable-gles1
  --disable-gles2
  --enable-dri
  --disable-dri3
  --enable-gbm
  --enable-sysfs
  --disable-xvmc
  --disable-vdpau
  --disable-va
  --disable-xlib-glx
  --disable-driglx-direct
  --disable-gallium-llvm
  --with-gallium-drivers=
  --with-dri-drivers=
environment =
  PATH=${mesa-python:location}/bin:${bison:location}/bin:${cmake:location}/bin:${flex:location}/bin:${ninja:location}/bin:${pkgconfig:location}/bin:${pkgconfig:location}/bin:${xz-utils:location}/bin:%(PATH)s
  PKG_CONFIG_PATH=${damageproto:location}/lib/pkgconfig:${glproto:location}/lib/pkgconfig:${xorgproto:location}/share/pkgconfig:${libX11:location}/lib/pkgconfig:${libXau:location}/lib/pkgconfig:${libXext:location}/lib/pkgconfig:${libexpat:location}/lib/pkgconfig:${libxcb:location}/lib/pkgconfig:${xdamage:location}/lib/pkgconfig:${xextproto:location}/lib/pkgconfig:${xfixes:location}/lib/pkgconfig:${xorg-libpthread-stubs:location}/lib/pkgconfig:${xproto:location}/lib/pkgconfig:${libdrm:location}/lib/pkgconfig:${zlib:location}/lib/pkgconfig:${libxshmfence:location}/lib/pkgconfig:${xxf86vm:location}/lib/pkgconfig:${libXrandr:location}/lib/pkgconfig:${libXrandr:pkg_config_depends}
  PYTHON2=${buildout:executable}
  LDFLAGS=-Wl,-rpath=${libdrm:location}/lib -Wl,-rpath=${zlib:location}/lib
  CFLAGS=-I${libxcb:location}/include -I${libX11:location}/include -I${xfixes:location}/include

[glu]
recipe = slapos.recipe.cmmi
shared = true
url = https://archive.mesa3d.org/glu/glu-9.0.3.tar.xz
md5sum = 06a4fff9179a98ea32ef41b6d83f6b19
configure-options =
  --disable-static
environment =
  PATH=${pkgconfig:location}/bin:${xz-utils:location}/bin:%(PATH)s
  PKG_CONFIG_PATH=${damageproto:location}/lib/pkgconfig:${glproto:location}/lib/pkgconfig:${xorgproto:location}/share/pkgconfig:${libX11:location}/lib/pkgconfig:${libXau:location}/lib/pkgconfig:${libXext:location}/lib/pkgconfig:${libexpat:location}/lib/pkgconfig:${libxcb:location}/lib/pkgconfig:${mesa:location}/lib/pkgconfig:${xdamage:location}/lib/pkgconfig:${xextproto:location}/lib/pkgconfig:${xfixes:location}/lib/pkgconfig:${xorg-libpthread-stubs:location}/lib/pkgconfig:${xproto:location}/lib/pkgconfig
  LDFLAGS=-Wl,-rpath=${libdrm:location}/lib -Wl,-rpath=${zlib:location}/lib
