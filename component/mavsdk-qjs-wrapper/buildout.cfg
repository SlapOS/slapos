[buildout]
extends =
  ../cmake/buildout.cfg
  ../git/buildout.cfg
  ../quickjs/buildout.cfg

parts = 
  mavsdk-qjs-wrapper

[c-astral-source]
recipe = slapos.recipe.build:gitclone
repository = https://gitlab+deploy-token-25:zShnq8syojDAYaVLVY5y@lab.nexedi.com/slaposdrone/c-astral-c-library.git
branch = master
revision = 023e64d2
git-executable = ${git:location}/bin/git

[mavsdk-source]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/mavlink/MAVSDK.git
branch = master
revision = 3e38b0c6
git-executable = ${git:location}/bin/git

[mavsdk]
recipe = slapos.recipe.cmmi
path = ${mavsdk-source:location}
configure-command =
  ${git:location}/bin/git submodule update --init --recursive
  cp -r ${c-astral-source:location}/* ${mavsdk-source:location}/src/third_party/mavlink/include/mavlink/v2.0/
  echo '#include "mavlink/v2.0/CAstral/mavlink.h"' >> ${mavsdk-source:location}/src/core/mavlink_include.h
  ${cmake:location}/bin/cmake
configure-options =
  -DCMAKE_BUILD_TYPE=Release
  -DCMAKE_INSTALL_PREFIX=@@LOCATION@@
  -H.

[mavsdk-qjs-wrapper]
recipe = slapos.recipe.cmmi
configure-command =
  cp -r ${:_profile_base_location_}/*.cpp ${:_profile_base_location_}/*.c ${:_profile_base_location_}/include ${:_profile_base_location_}/Makefile ${:location}
location = @@LOCATION@@
path = ${:location}
environment =
  C_INCLUDE_PATH=${:location}/include:${quickjs:location}/include:$C_INCLUDE_PATH
  CPLUS_INCLUDE_PATH=${mavsdk:location}/include:${mavsdk:location}/include/mavsdk:${:location}/include:$CPLUS_INCLUDE_PATH
  LDFLAGS=-L${mavsdk:location}/lib -Wl,-rpath=${mavsdk:location}/lib
