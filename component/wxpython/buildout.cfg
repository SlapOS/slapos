[buildout]

extends =
  ../pkgconfig/buildout.cfg
  ../gtk-3/buildout.cfg
  ../pillow/buildout.cfg
  ../numpy/buildout.cfg
  ../freetype/buildout.cfg
  ../fontconfig/buildout.cfg
  ../wxwidgets/buildout.cfg

parts =
    wxPython

[python2.7]
environment =
  PATH=${patch:location}/bin:${xz-utils:location}/bin:%(PATH)s
  CPPFLAGS=-I${zlib:location}/include -I${readline:location}/include -I${libexpat:location}/include -I${libffi:location}/include -I${ncurses:location}/include -I${ncurses:location}/include -I${bzip2:location}/include  -I${gdbm:location}/include -I${openssl:location}/include -I${sqlite3:location}/include -I${gettext:location}/include -fPIC
  LDFLAGS=-L${zlib:location}/lib -L${readline:location}/lib -L${libexpat:location}/lib -L${libffi:location}/lib -L${ncurses:location}/lib -L${bzip2:location}/lib -L${gdbm:location}/lib -L${openssl:location}/lib -L${sqlite3:location}/lib -Wl,-rpath=${zlib:location}/lib -Wl,-rpath=${readline:location}/lib -Wl,-rpath=${libexpat:location}/lib -Wl,-rpath=${libffi:location}/lib -Wl,-rpath=${ncurses:location}/lib -Wl,-rpath=${bzip2:location}/lib -Wl,-rpath=${gdbm:location}/lib -Wl,-rpath=${openssl:location}/lib -Wl,-rpath=${sqlite3:location}/lib -L${gettext:location}/lib -Wl,-rpath=${gettext:location}/lib -Wl,-rpath=${file:location}/lib

[python-path]
recipe = collective.recipe.shelloutput
commands =
  pythonpath = ls -d ${buildout:eggs-directory}/* | tr '\n' ':'

[wxpython-eggs]
recipe = zc.recipe.egg
interpreter = wxpython2.7
eggs =
  ${numpy:egg}
  ${pillow-python:egg}

[wxPython-download]
recipe = slapos.recipe.build:download-unpacked
url = https://files.pythonhosted.org/packages/b0/4d/80d65c37ee60a479d338d27a2895fb15bbba27a3e6bb5b6d72bb28246e99/wxPython-4.1.1.tar.gz
md5sum = 262191ae1c926a58da37fb7a8fabc51e


[wxPython]
recipe = slapos.recipe.build
egg = ${:_buildout_section_name_}
source-location = ${wxPython-download:location}
egg-name = ${:egg}-${versions:wxPython}-py${python:version}-linux-x86_64.egg
location = ${buildout:eggs-directory}/${:egg-name}
python-bin = ${buildout:bin-directory}/${wxpython-eggs:interpreter}
wxwidgets-bin = ${wxWidgets:location}/bin/
LDFLAGS=-L${gtk-3:location}/lib -Wl,-rpath=${gtk-3:location}/lib -L${wxWidgets:location}/lib -Wl,-rpath=${wxWidgets:location}/lib
CPPFLAGS=-I${wxWidgets:location}/include/wx-3.0 -I${wxWidgets:location}/lib/wx/include/gtk3-unicode-3.0 -I${gtk-3:location}/include/gtk-3.0
PYTHONPATH = ${python-path:pythonpath}
pkg-config = ${pkgconfig:location}/bin
PKG_CONFIG_PATH = ${glib:location}/lib/pkgconfig:${gtk-3:location}/lib/pkgconfig:${gtk-3:pkg_config_depends}
install =
  import sys, os, shutil
  from setuptools.archive_util import unpack_archive
  workdir = options['source-location']
  python_bin = options['python-bin']
  env = {'PATH':':'.join([options['pkg-config'],
                          options['wxwidgets-bin'],
                          os.environ['PATH']]),
         'LDFLAGS':options['LDFLAGS'],
         'CPPFLAGS':options['CPPFLAGS'],
         'PYTHONPATH':options['PYTHONPATH'],
         'PKG_CONFIG_PATH': options['PKG_CONFIG_PATH'],
         }
  os.chdir(workdir)
  try:
    call([python_bin, 'build.py', 'build', '--use_syswx', '--release',
          '--nodoc', '--gtk3'], env=env)
    call([python_bin, 'build.py', 'bdist_egg', '--use_syswx', '--release',
          '--nodoc', '--gtk3'], env=env)
    unpack_archive(os.path.join('dist', options['egg-name']), location)
  finally:
    for d in 'build', 'dist':
      if os.path.exists(d):
        shutil.rmtree(d)

[versions]
wxPython = 4.1.1
