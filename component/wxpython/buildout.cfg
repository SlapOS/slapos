[buildout]

extends =
  ../pkgconfig/buildout.cfg
  ../gtk-3/buildout.cfg
  ../pillow/buildout.cfg
  ../numpy/buildout.cfg
  ../wxwidgets/buildout.cfg

parts =
    wxPython

[wxpython-eggs]
recipe = zc.recipe.egg
interpreter = wxpython2.7
eggs =
  requests
  ${numpy:egg}
  ${pillow-python:egg}

[nanosvg]
recipe = slapos.recipe.build:download-unpacked
url = https://github.com/wxWidgets/nanosvg/archive/9dd92bb.tar.gz
md5sum = b9060d6600ebffa4080d1b29c99d1f30

[wxPython-download]
recipe = slapos.recipe.build:download-unpacked
url = https://github.com/wxWidgets/Phoenix/archive/refs/tags/wxPython-4.1.1.tar.gz
md5sum = e72d99cd865c4220b65065079457c6c5

[wxPython]
recipe = slapos.recipe.build
egg = ${:_buildout_section_name_}
source-location = ${wxPython-download:location}
egg-name = ${:egg}-${versions:wxPython}-py${python:version}-linux-x86_64.egg
location = ${buildout:eggs-directory}/${:egg-name}
python-bin = ${buildout:bin-directory}/${wxpython-eggs:interpreter}
wxwloc = ${wxWidgets:location}
LDFLAGS=-L${gtk-3:location}/lib -Wl,-rpath=${gtk-3:location}/lib -L${wxWidgets:location}/lib -Wl,-rpath=${wxWidgets:location}/lib
CPPFLAGS=-I${wxWidgets:location}/include/wx-3.0 -I${wxWidgets:location}/lib/wx/include/gtk3-unicode-3.0 -I${gtk-3:location}/include/gtk-3.0 -I${nanosvg:location}/src
pkg-config = ${pkgconfig:location}/bin
PKG_CONFIG_PATH = ${glib:location}/lib/pkgconfig:${gtk-3:location}/lib/pkgconfig:${gtk-3:pkg_config_depends}
install =
  import os, sys
  from setuptools.archive_util import unpack_archive
  from zc.buildout import easy_install
  workdir = options['source-location']
  python_bin = options['python-bin']
  dist = os.path.join(workdir, 'dist')
  build = os.path.join(workdir, 'build')
  wxpython_eggs = self.buildout['wxpython-eggs']
  egg_list = easy_install.working_set(wxpython_eggs['eggs'].split(), [
    wxpython_eggs['develop-eggs-directory'],
    wxpython_eggs['eggs-directory'],
  ]).entries
  egg_list.append(workdir)
  env = {'PATH': os.pathsep.join([options['pkg-config'],
                          os.path.join(options['wxwloc'], 'bin'),
                          os.environ['PATH']]),
          'LDFLAGS': options['LDFLAGS'],
          'CPPFLAGS': options['CPPFLAGS'],
          'PYTHONPATH': os.pathsep.join(sys.path + egg_list),
          'PKG_CONFIG_PATH': options['PKG_CONFIG_PATH'],
          'WXWIN': options['wxwloc'],
        }
  try:
    call([python_bin, 'build.py', 'dox', 'etg', '--nodoc', 'sip', 'build', '--use_syswx', '--release',
          '--gtk3'], env=env, cwd=workdir)
    call([python_bin, 'build.py', 'bdist_egg', '--use_syswx', '--release',
          '--gtk3'], env=env, cwd=workdir)
    unpack_archive(os.path.join(dist, options['egg-name']), location)
    call([python_bin, 'build.py', 'clean'], env=env, cwd=workdir)
  finally:
    doxygen = os.path.join(workdir, 'bin', 'doxygen-1.8.8-linux')
    sip = os.path.join(workdir, 'bin', 'sip-4.19.24-linux64')
    waf = os.path.join(workdir, 'bin', 'waf-2.0.19')
    self.cleanup_list += build, dist, doxygen, sip, waf

[versions]
wxPython = 4.1.1
