# Go language - https://golang.org/
[buildout]
extends =
  ../findutils/buildout.cfg
  ../git/buildout.cfg

parts = gowork

# ---- Go builds itself ----

[golang-common]
recipe = slapos.recipe.cmmi
configure-command = :
location = ${buildout:parts-directory}/${:_buildout_section_name_}
make-binary =
make-targets= cd src && ./all.bash && cp -alf .. ${:location}
# some testdata files have an issue with slapos.extension.strip.
post-install = ${findutils:location}/bin/find ${:location}/src -type d -name testdata -exec rm -rf {} \; || true
environment =
  GOROOT_FINAL=${:location}
  ${:environment-extra}


[golang14]
<= golang-common
url = https://storage.googleapis.com/golang/go1.4-bootstrap-20170531.tar.gz
md5sum = d2cc61cb9f829b3510ee39c0c5568014
environment-extra =


[golang18]
<= golang-common
url = https://storage.googleapis.com/golang/go1.8.3.src.tar.gz
md5sum = 64e9380e07bba907e26a00cf5fcbe77e

# go1.8 needs go1.4 to bootstrap
environment-extra =
  GOROOT_BOOTSTRAP=${golang14:location}

[golang19]
<= golang-common
url = https://storage.googleapis.com/golang/go1.9.1.src.tar.gz
md5sum = 27bce1ffb05f4f6bd90d90081e5d4169

# go1.9 needs go1.4 to bootstrap
environment-extra =
  GOROOT_BOOTSTRAP=${golang14:location}


# ---- infrastructure to build Go workspaces / projects ----

# gowork is a top-level section representing workspace
#
# users should add `install` field to [gowork] to describe packages they want to
# be installed (+ automatically their dependencies are installed too). e.g.
#
#   [gowork]
#   install =
#       lab.nexedi.com/kirr/neo/go/...  \
#       github.com/pkg/profile          \
#       golang.org/x/perf/cmd/benchstat
[gowork]
directory = ${buildout:directory}/go.work
src	= ${:directory}/src
bin	= ${:directory}/bin
depends = ${gowork.goinstall:recipe}

# go version used for the workspace (possible to override in applications)
golang  = ${golang19:location}

# everything is done by dependent parts
recipe  = plone.recipe.command
command = :

# env.sh for compiling and running go programs
[gowork]
env.sh  = ${gowork-env.sh:output}

[gowork-env.sh]
recipe	= slapos.recipe.template
url     = ${:_profile_base_location_}/goenv.sh.in
output	= ${gowork:directory}/env.sh
depends = ${gowork.mkdir:recipe}
md5sum	= a9a265135931b3da53f4392870748264

[gowork.mkdir]
recipe  = slapos.cookbook:mkdirectory
go.work = ${gowork:directory}

# install go packages
# clients should put package list to install to gowork:install ("..." requests installing everything)
[gowork.goinstall]
recipe  = plone.recipe.command
command = bash -c ". ${gowork:env.sh} && go install -v ${gowork:install}"
update-command = ${:command}
stop-on-error = true


[git-repository]
recipe  = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git

# a go package should:
# 1) <= go-git-package
# 2) provide go.importpath
# 3) provide repository (which is not the same as importpath in general case)
#
# the list of go packages for a go workspace state can be automatically
# generated with the help of go-pkg-snapshot tool.
[go-git-package]
<= git-repository
location = ${gowork:src}/${:go.importpath}
