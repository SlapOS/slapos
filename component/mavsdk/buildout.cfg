[buildout]
extends =
  ../defaults.cfg
  ../bash/defaults.cfg

parts = 
  mavsdk

[mavsdk-source]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/mavlink/MAVSDK.git

[build-mavsdk.sh]
recipe = slapos.recipe.template:jinja2
template = inline:
  #!${bash:location}/bin/bash
  cd ${mavsdk-source:location};
  cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=${mavsdk-source:location}/install -Bbuild/default -H.;
  cmake --build build/default --target install;
  cd ${mavsdk-source:location}/install/lib;
  LIB_LIST=$(for f in $(find .|grep -e "\.a$"|cut -c3-);do echo "addlib $f";done)
  ar -M <<- ENDMRI
  create libmavsdk_full.a
  $LIB_LIST
  save
  end
  ENDMRI
  ranlib libmavsdk_full.a
rendered = ${buildout:directory}/build-mavsdk.sh

[mavsdk]
recipe = plone.recipe.command
command = ${build-mavsdk.sh:location}/${build-mavsdk.sh:filename}
path = ${mavsdk-source:location}/
location = ${buildout:parts-directory}/${:_buildout_section_name_}
lib-name = libmavsdk_full.a
lib-path = ${:location}/lib/${:lib-name}
inc-dir = ${:location}/include
environment =
  MAVSDK_LIB = ${:lib-path}
  MAVSDK_INC = ${:inc-dir}
  CC=${gcc:prefix}/bin/gcc

