[buildout]
extends =
  ../cmake/buildout.cfg
  ../curl/buildout.cfg
  ../git/buildout.cfg
  ../jsoncpp/buildout.cfg
  ../qjs-wrapper/buildout.hash.cfg
  ../tinyxml2/buildout.cfg
  ../zlib/buildout.cfg

parts =
  mavsdk

[autopilot-wrapper-header]
recipe = slapos.recipe.build:download
shared = true
url = ${:_profile_base_location_}/../qjs-wrapper/${:filename}

[c-astral-headers]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/nexedi/c-astral-c-library
revision = v2.0
git-executable = ${git:location}/bin/git

[gcc]
min_version = 7.1

[mavsdk-source]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/mavlink/MAVSDK.git
revision = v0.39.0

git-executable = ${git:location}/bin/git
ignore-cloning-submodules = true

[mavsdk]
recipe = slapos.recipe.cmmi
path = ${mavsdk-source:location}
cmake = ${cmake:location}/bin/cmake
pre-configure =
  ${git:location}/bin/git submodule update --init --recursive
  cp -r ${c-astral-headers:location}/mavlink/v2.0/* ${mavsdk-source:location}/src/third_party/mavlink/include/mavlink/v2.0/
configure-command =
  ${:cmake}
configure-options =
  -DCMAKE_BUILD_TYPE=Release
  -DCMAKE_C_FLAGS="${:CMAKE_CFLAGS}"
  -DCMAKE_CXX_FLAGS="${:CMAKE_CFLAGS}"
  -DCMAKE_INSTALL_PREFIX=@@LOCATION@@
  -DCMAKE_INSTALL_RPATH=${:CMAKE_LIBRARY_PATH}:@@LOCATION@@/lib
  -DPKG_CONFIG_EXECUTABLE=${pkgconfig:location}/bin/pkg-config
  -DSUPERBUILD=OFF
  -Bbuild/default
  -H.
make-binary =
  ${:cmake} --build build/default --target install
environment =
  CMAKE_INCLUDE_PATH=${curl:location}/include:${jsoncpp:location}/include:${tinyxml2:location}/include
  CMAKE_LIBRARY_PATH=${:CMAKE_LIBRARY_PATH}
  CMAKE_PROGRAM_PATH=${cmake:location}/bin
  PATH=${pkgconfig:location}/bin/:%(PATH)s
  LDFLAGS=-L${curl:location}/lib -Wl,-rpath=${curl:location}/lib -L${jsoncpp:location}/lib -Wl,-rpath=${jsoncpp:location}/lib -L${tinyxml2:location}/lib -Wl,-rpath=${tinyxml2:location}/lib -L${zlib:location}/lib -Wl,-rpath=${zlib:location}/lib -Wl,-rpath=@@LOCATION@@/lib

CMAKE_CFLAGS=-I${tinyxml2:location}/include
CMAKE_LIBRARY_PATH=${curl:location}/lib:${jsoncpp:location}/lib:${tinyxml2:location}/lib:${zlib:location}/lib

[mavsdk-wrapper]
recipe = slapos.recipe.cmmi
configure-command = true
url = https://lab.nexedi.com/nexedi/mavsdk-wrapper/-/archive/init/mavsdk-wrapper-init.tar.gz
md5sum = e25ea40950fa5909ac98a51918fd5a01
environment =
  CPLUS_INCLUDE_PATH=${autopilot-wrapper-header:location}:${mavsdk:location}/include:${mavsdk:location}/include/mavsdk
  LDFLAGS=-L${mavsdk:location}/lib -Wl,-rpath=${mavsdk:location}/lib
