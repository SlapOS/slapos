[buildout]
extends =
  ../defaults.cfg
  ../cmake/buildout.cfg
  ../bash/buildout.cfg

parts = 
  mavsdk

[mavsdk-source]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/mavlink/MAVSDK.git

[build-mavsdk.sh]
recipe = slapos.recipe.template:jinja2
template = inline:
  #!${bash:location}/bin/bash
  cd ${mavsdk-source:location};
  cmake -DCMAKE_BUILD_TYPE=Release -DBUILD_SHARED_LIBS=OFF -DCMAKE_INSTALL_PREFIX=${mavsdk-source:location}/install -Bbuild/default -H.;
  cmake --build build/default --target install;
  cp -r build/default/third_party/install/include/* install/include
  cp -r build/default/third_party/install/lib/* install/lib
  cd ${mavsdk-source:location}/install/lib;
  LIB_LIST=$(for f in $(find .|grep -e "\.a$"|cut -c3-);do echo "addlib $f";done)
  ar -M <<- ENDMRI
  create libmavsdk_full.a
  $LIB_LIST
  save
  end
  ENDMRI
  ranlib libmavsdk_full.a
rendered = ${buildout:directory}/build-mavsdk.sh

[mavsdk]
recipe = plone.recipe.command
lib-name = libmavsdk_full.a
lib-path = ${mavsdk-source:location}/install/lib/${:lib-name}
inc-dir = ${mavsdk-source:location}/install/include
command = (export MAVSDK_LIB=${:lib-path};export MAVSDK_INC=${:inc-dir};export CC=${gcc:prefix}/bin/gcc;export PATH=${cmake:location}/bin:$PATH; ${build-mavsdk.sh:rendered})
location = ${buildout:parts-directory}/${:_buildout_section_name_}

