[buildout]
extends =
  ../libxml2/buildout.cfg
  ../zlib/buildout.cfg
  ../icu/buildout.cfg
# for qmake
  ../qt/buildout.cfg

parts +=
  onlyoffice-core

[onlyoffice-core]
recipe = slapos.recipe.cmmi
location = ${buildout:parts-directory}/${:_buildout_section_name_}
# This url contains the hash provided by the DocumentServer core submodule hash.
# https://github.com/ONLYOFFICE/DocumentServer/
url = https://lab.nexedi.com/bk/onlyoffice_core/repository/archive.tar.bz2?ref=b051e75b179b3599c09937668fbbd2d7e2c50683
md5sum = b2713373d687dd1c7121c286fa156626
configure-command = true
make-targets = lib bin
environment =
  PATH=${qt5-qmake:location}/bin:%(PATH)s
  CXXFLAGS=-I${libxml2:location}/include -I${zlib:location}/include -I${icu4c:location}/include -I${onlyoffice-boost:location}/include -Wno-comment -Wno-deprecated-declarations -Wno-endif-labels -Wno-parentheses -Wno-reorder -Wno-sign-compare -Wno-switch -Wno-unknown-pragmas -Wno-unused
  LDFLAGS=-L${libxml2:location}/lib -Wl,-rpath=${libxml2:location}/lib -L${zlib:location}/lib -Wl,-rpath=${zlib:location}/lib -L${icu4c:location}/lib -Wl,-rpath=${icu4c:location}/lib -L${onlyoffice-boost:location}/lib -Wl,-rpath=${onlyoffice-boost:location}/lib -Wl,-rpath=${:location}/lib
post-install =
  set -e -x
  mkdir -p ${:location}/bin ${:location}/lib
  mv -t ${:location}/lib build/lib/*/*.so
  mv -t ${:location}/bin build/bin/*/*
# the binary linux_64 in build/bin/AllFontsGen is renamed AllFontsGen here.
#  mv build/bin/AllFontsGen/* ${:location}/bin/AllFontsGen

[onlyoffice-boost]
recipe = slapos.recipe.cmmi
url = http://downloads.sourceforge.net/sourceforge/boost/boost_1_58_0.tar.bz2
md5sum = b8839650e61e9c1c0a89f371dd475546
location = ${buildout:parts-directory}/${:_buildout_section_name_}
configure-command = ./bootstrap.sh --prefix=${:location} --with-python=${python2.7:location}/bin/python2.7 --with-libraries=regex --with-icu=${icu4c:location}
make-binary =
make-options =
make-targets = ./b2 link=shared dll-path=${:location}/lib:${bzip2:location}/lib:${zlib:location}/lib:${icu4c:location}/lib install
environment =
  BZIP2_INCLUDE=${bzip2:location}/include
  BZIP2_LIBPATH=${bzip2:location}/lib
  ZLIB_INCLUDE=${zlib:location}/include
  ZLIB_LIBPATH=${zlib:location}/lib
