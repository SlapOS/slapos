[buildout]
extends =
  ../librsync/buildout.cfg
  ../python-2.7/buildout.cfg
  ../patch/buildout.cfg

parts =
  rdiff-backup-1.0.5
  rdiff-backup-1.3.4
  rdiff-backup-2.2.4

[rdiff-backup-common]
recipe = slapos.recipe.cmmi
shared = true
patch-options = -p1
patch-binary = ${patch:location}/bin/patch
configure-command = true
make-binary = true
post-install =
  set %(location)s/lib/python2.7
  %(python)s setup.py build_ext -I${librsync:location}/include -L${librsync:location}/lib -R${librsync:location}/lib build install --prefix=%(location)s --install-lib=$1
  cd %(location)s/bin
  sed -i '/^import\b.*\bsys\b/s,$,\nsys.path[0] = '\"$1\", *
  ./rdiff-backup -V
python = ${python2.7:executable}

[rdiff-backup-common:python27]
python = ${buildout:executable}

[rdiff-backup-2.2.4-repository]
recipe = slapos.recipe.build:download-unpacked
url = https://src.fedoraproject.org/repo/pkgs/rdiff-backup/rdiff-backup-2.2.4.tar.gz/sha512/3777038f90a702aaf0d87737ccd79dd6a0bc9d6bd49dc8154fbcd240b9b1971f5a5f3cc0ebffb623f1eeec82cb939fbdee75a813d27ef9eb78d5700ecc2716b5/rdiff-backup-2.2.4.tar.gz
md5sum = beb1ff7e8082932c322be9bd79e84ecb
destination = ${buildout:directory}/rdiff-backup

[rdiff-backup-2.2.4-eggs]
recipe = zc.recipe.egg:custom
egg = rdiff-backup
setup-eggs =
  setuptools-scm
include-dirs =
  ${librsync:location}/include
library-dirs =
  ${librsync:location}/lib
rpath =
  ${librsync:location}/lib

[rdiff-backup-2.2.4]
recipe = zc.recipe.egg:scripts
location = ${buildout:directory}
eggs = ${rdiff-backup-2.2.4-eggs:egg}
entry-points = rdiff-backup=rdiffbackup.run:main
scripts = rdiff-backup

[rdiff-backup-1.0.5]
<= rdiff-backup-common
url = https://pkgs.fedoraproject.org/repo/pkgs/rdiff-backup/rdiff-backup-1.0.5.tar.gz/${:md5sum}/rdiff-backup-1.0.5.tar.gz
md5sum = fa2a165fa07a94be52c52e3545bc7758
patches =
  ${:_profile_base_location_}/rdiff-backup-1.2.8-librsync-1.0.0.patch#5e54a67845edd6942fcf7359c921e003

[rdiff-backup-1.3.4]
<= rdiff-backup-common
# use our own version
url = http://www.nexedi.org/static/packages/source/rdiff-backup-1.3.4nxd6.tar.gz
md5sum = 06b8df2099baebca6086a315b031fd53
patches =
  ${:_profile_base_location_}/rdiff-backup-1.3.4-librsync-1.0.0.patch#31fafc8bc4a00f002f52008a9f3b671f
