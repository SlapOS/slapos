[buildout]
extends =
  common.cfg

[vm-run-base]
vm = ${vm-ubuntu:location}
dist = ${vm-ubuntu:dists}

[vm-ubuntu]
recipe = slapos.recipe.build:vm.install-ubuntu
environment = vm-install-environment
dists = ubuntu-server-2510
size = 6Gi
late-command =
  dpkg -P ubuntu-server ubuntu-server-minimal snapd rsyslog
  ! apt-mark manual ${:keep} |grep -q 'already\|can not'
# Also remove old kernel if any.
  echo '#clear APT::VersionedKernelPackages;' |
    apt-get -c /dev/stdin autopurge -y
  rm -r /etc/cloud
  mount |grep -q 'on / .*\bdiscard\b' || {
    apt-get clean
    sync
    fstrim -v /
  }
keep = eatmydata git htop unattended-upgrades xfsprogs
# dummy identity (cloud-init-main.service would fail
# but we uninstall cloud-init in late-command)
autoinstall.identity.username =
autoinstall.identity.password =

[ubuntu-server-base]
recipe = slapos.recipe.build:download
shared = true
filename = ubuntu-${:version}-live-server-${:arch}.iso

[ubuntu-desktop-base]
recipe = slapos.recipe.build:download
shared = true
filename = ubuntu-${:version}-desktop-${:arch}.iso

[ubuntu-amd64-base]
arch = amd64
url = https://releases.ubuntu.com/${:version}/${:filename}

[ubuntu-amd64-desktop-base]
<= ubuntu-amd64-base
   ubuntu-desktop-base

[ubuntu-amd64-server-base]
<= ubuntu-amd64-base
   ubuntu-server-base

[ubuntu-amd64-desktop-2510.iso]
<= ubuntu-amd64-desktop-base
version = 25.10
md5sum = bdb1181fecec7c2a95aff77ba8e73dc8

[ubuntu-amd64-desktop.iso]
<= ubuntu-amd64-desktop-2510.iso

[ubuntu-amd64-server-2510.iso]
<= ubuntu-amd64-server-base
version = 25.10
md5sum = 73d515cab21409ffe5c4373eefa317c3

[ubuntu-amd64-server.iso]
<= ubuntu-amd64-server-2510.iso


[ubuntu-desktop]
x86_64.iso = ubuntu-amd64-desktop.iso
x86_64.kernel = casper/vmlinuz
x86_64.initrd = casper/initrd

[ubuntu-desktop-2510]
<= ubuntu-desktop
x86_64.iso = ubuntu-amd64-desktop-2510.iso


[ubuntu-server]
x86_64.iso = ubuntu-amd64-server.iso
x86_64.kernel = casper/vmlinuz
x86_64.initrd = casper/initrd

[ubuntu-server-2510]
<= ubuntu-server
x86_64.iso = ubuntu-amd64-server-2510.iso
