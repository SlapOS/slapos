[buildout]
extends =
  ../cmake/buildout.cfg
  ../ninja/buildout.cfg
  ../bzip2/buildout.cfg
  ../libffi/buildout.cfg
  ../gcc-4.9/buildout.cfg
  ../gmp/buildout.cfg
  ../libxml2/buildout.cfg
  ../xz-utils/buildout.cfg
  ../autoconf/buildout.cfg
  ../automake/buildout.cfg
  ../libtool/buildout.cfg
  ../openssl/buildout.cfg
  ../sqlite3/buildout.cfg
  ../mpfr/buildout.cfg
  ../llvm/buildout.cfg
  ../git/buildout.cfg

parts +=
  pyston
  pyston-deps
  pyston-build
  
[pyston-deps]
recipe = plone.recipe.command
# stop-on-error = true
llvm-repository = https://github.com/llvm-mirror/llvm.git
location = ${buildout:directory}/parts/pyston_deps
llvm-location = ${:location}/llvm-trunk
clang-location = ${:llvm-location}/tools/clang
clang-repository = https://github.com/llvm-mirror/clang.git
git-binary = ${git:location}/bin/git
command = ([ -d ${:llvm-location} ] && ls || ${:git-binary} clone ${:llvm-repository} ${:llvm-location} && [ -d ${:clang-location} ] && ls || ${:git-binary} clone ${:clang-repository} ${:clang-location})
update-command = command

[pyston]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/Daetalus/Pyston.git
branch = master
git-executable = ${git:location}/bin/git

[pyston-build]
recipe = slapos.recipe.cmmi
path = ${pyston:location}
configure-command = 
  cp ${libtool:location}/share/aclocal/* ${automake:location}/share/aclocal-1.15/
  git config --global user.email "john-doe@nexedi.com"
  git config --global user.name "John"
  git submodule update --init --recursive build_deps
  make llvm_up && echo "Hello World"
  gcc -v
make-binary = make pyston_release_gcc
make-targets = -v
environment = 
  HOME=${buildout:directory}/parts
  PATH=${gcc-4.9:location}/bin:${git:location}/bin:${cmake:location}/bin:${ninja:path}:${autoconf:location}/bin:${automake:location}/bin:${libtool:location}/bin:%(PATH)s
  CPATH=${gcc-4.9:location}/include:${bzip2:location}/include:${gmp:location}/include:${libffi:location}/include:${mpfr:location}/include:${ncurses:location}/include:${openssl:location}/include:${readline:location}/include:${sqlite3:location}/include:${zlib:location}/include:${bzip2:location}/include:$CPATH
  LD_LIBRARY_PATH=${ncurses:location}/lib:${libffi:location}/lib:${gcc-4.9:location}/lib64:$LD_LIBRARY_PATH
  LIBRARY_PATH=${bzip2:location}/lib:${gmp:location}/lib:${libffi:location}/lib:${mpfr:location}/lib:${ncurses:location}/lib:${openssl:location}/lib:${readline:location}/lib:${sqlite3:location}/lib:${zlib:location}/lib:$LIBRARY_PATH
  CMAKE_PREFIX_PATH=${gmp:location}:${xz-utils:location}:$CMAKE_PREFIX_PATH