[buildout]
extends =
  ../xorg/buildout.cfg
  ../mesa/buildout.cfg

parts =
  qt4-qmake

[qt5-qmake]
# XXX does not work on all systems
# building [qmake] will download the full qt source anyway ~200MB
# qmake binary can be reached directly from ${qt:location}/qtbase/bin/qmake if [qt] is fully built
recipe = slapos.recipe.cmmi
location = ${buildout:parts-directory}/${:_buildout_section_name_}
url = http://download.qt.io/official_releases/qt/5.6/5.6.2/single/qt-everywhere-opensource-src-5.6.2.tar.gz
md5sum = 1b1b1f929d0cd83680354a0c83d8e945
environment =
  CFLAGS=-I${mesa:location}/include
  CPPFLAGS=-I${mesa:location}/include
  CXXFLAGS=-I${mesa:location}/include
  LD_LIBRARY_PATH=${mesa:location}/lib
pre-configure-QMAKE_INCDIR_X11 =
  ${libX11:location}/include
  ${xproto:location}/include
  ${libXext:location}/include
pre-configure-QMAKE_LIBDIR_X11 =
  ${libX11:location}/lib64 ${libX11:location}/lib
  ${xproto:location}/lib64 ${xproto:location}/lib
  ${libXext:location}/lib64 ${libXext:location}/lib
pre-configure =
  set -e -x
  qmake_incdir_x11=$(echo " ${:pre-configure-QMAKE_INCDIR_X11}" | sed ':a;N;$!ba;s/\n/ /g')
  qmake_libdir_x11=$(echo " ${:pre-configure-QMAKE_LIBDIR_X11}" | sed ':a;N;$!ba;s/\n/ /g')
  sed 's:QMAKE_INCDIR_X11\s*=:QMAKE_INCDIR_X11 ='"$qmake_incdir_x11:g" -i qtbase/mkspecs/*/*.conf
  sed 's:QMAKE_LIBDIR_X11\s*=:QMAKE_LIBDIR_X11 ='"$qmake_libdir_x11:g" -i qtbase/mkspecs/*/*.conf
# it helped me : http://stackoverflow.com/questions/24264940/compile-qt5-without-gui-support-on-linux-arm
configure-command = ./configure --prefix=${:location} -v -no-separate-debug-info -release -confirm-license -opensource -no-opengl -nomake examples
make-targets = qmake
post-install =
  cp -rt ${:location} *

[qt5.6-qmake]
<= qt5-qmake
[qt5.6.2-qmake]
<= qt5.6-qmake


[qt4-qmake]
# building [qmake] will download the full qt source anyway ~200MB
# qmake binary can be reached directly from ${qt:location}/bin/qmake if [qt] is fully built
recipe = slapos.recipe.cmmi
location = ${buildout:parts-directory}/${:_buildout_section_name_}
url = http://download.qt.io/official_releases/qt/4.8/4.8.7/qt-everywhere-opensource-src-4.8.7.tar.gz
md5sum = d990ee66bf7ab0c785589776f35ba6ad
# see https://github.com/NixOS/nixpkgs/blob/3e387c3e005c87566b5403d24c86f71f4945a79b/pkgs/development/libraries/qt-4.x/4.8/default.nix#L101
pre-configure =
  set -e -x
  sed 's,/usr/X11R6/lib64,${libX11:location}/lib64 ${xproto:location}/lib64 ${libXext:location}/lib64,g' -i mkspecs/*/*.conf
  sed 's,/usr/X11R6/lib,${libX11:location}/lib ${xproto:location}/lib ${libXext:location}/lib,g' -i mkspecs/*/*.conf
  sed 's,/usr/X11R6/include,${libX11:location}/include ${xproto:location}/include ${libXext:location}/include,g' -i mkspecs/*/*.conf
configure-command = ./configure --prefix=${:location} -v -no-separate-debug-info -release -no-fast -confirm-license -opensource
make-targets = qmake
post-install =
  cp -rt ${:location} *

[qt4.8-qmake]
<= qt4-qmake
[qt4.8.7-qmake]
<= qt4.8-qmake
