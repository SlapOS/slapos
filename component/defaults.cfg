[buildout]
extends =
  python-2.7/buildout.cfg
  python3/buildout.cfg
python = python

[python]
recipe = slapos.recipe.build
part = python2.7
init =
  python = self.buildout[options['part']]
  for x in 'location', 'executable':
    options[x] = python[x]
update =
  import os
  path, os.environ['PYTHON'] = os.path.split(options['executable'])
  PATH = os.environ['PATH']
  if path not in PATH.split(os.pathsep):
    os.environ['PATH'] = path + os.pathsep + PATH
depends = ${gcc:recipe}

[gcc]
recipe = slapos.recipe.build
part = gcc-8.2.0
init =
  import os, subprocess
  parse_version = lambda ver: tuple(map(int, ver.strip().split('.')))
  try:
    current = subprocess.check_output(('gcc', '-dumpfullversion'),
                                      stderr=subprocess.STDOUT)
  except subprocess.CalledProcessError: # BBB: old GCC
    current = subprocess.check_output(('gcc', '-dumpversion'))
  self.system_gcc = (
    parse_version(options.get('min_version') or current)
    <= parse_version(current)
    <= parse_version(options.get('max_version') or current))
  if self.system_gcc:
    for path in os.environ('PATH', '').split(os.pathsep): # PY3: shutil.which
      gcc = os.path.join(path, 'gcc')
      if os.access(gcc, os.X_OK) and not os.path.isdir(gcc):
        options['prefix'] = os.path.dirname(path)
        break
  else:
    options['prefix'] = self.buildout[options['part']]['location']
update =
  if not self.system_gcc:
    import os
    prefix = options['prefix']
    PATH = os.environ['PATH']
    if path not in PATH.split(os.pathsep):
      os.environ['PATH'] = path + os.pathsep + PATH
