[buildout]
parts = poppler
extends =
  ../cmake/buildout.cfg
  ../bzip2/buildout.cfg
  ../fontconfig/buildout.cfg
  ../jbigkit/buildout.cfg
  ../libjpeg/buildout.cfg
  ../libpng/buildout.cfg
  ../libtiff/buildout.cfg
  ../pkgconfig/buildout.cfg
  ../xz-utils/buildout.cfg
  ../zlib/buildout.cfg
  ../freetype/buildout.cfg
  ../boost-lib/buildout.cfg
  ../libgpgme/buildout.cfg
  ../openjpeg/buildout.cfg
  ../nspr/buildout.cfg
  ../nss/buildout.cfg

[poppler]
recipe = slapos.recipe.cmmi
shared = true
url = https://poppler.freedesktop.org/poppler-24.03.0.tar.xz
md5sum = 2d50c3c8e0011d1fa14572c744cd33bb
pre-configure =
  sed -i 's/PkgConfig::NSS3/$${NSS3_LIBRARIES}/' CMakeLists.txt
configure-command =
  cmake
configure-options =
  -Bbuild
  -DCMAKE_BUILD_TYPE=Release
  -DCMAKE_INSTALL_PREFIX=@@LOCATION@@
  -DENABLE_LIBCURL=OFF
  -DBUILD_GTK_TESTS=OFF
  -DENABLE_QT5=OFF
  -DENABLE_QT6=OFF
  -DENABLE_GTK_DOC=OFF
  -DENABLE_ZLIB_UNCOMPRESS=ON
  -DENABLE_CPP=OFF
  -DENABLE_GLIB=OFF
  -DENABLE_LCMS=OFF
  -DFREETYPE_LIBRARY=${freetype:location}/lib/libfreetype.so
  -DFREETYPE_INCLUDE_DIRS=${freetype:location}/include
  -DNSS3_LIBRARIES="-L${nss:location}/lib -lssl3 -lsmime3 -lnss3 -lnssutil3"
  -DNSS3_CFLAGS="-I${nss:location}/include/nss"
  -DTIFF_INCLUDE_DIR=${libtiff:location}/include
  -DTIFF_LIBRARY=${libtiff:location}/lib/libtiff.so
  -DJPEG_LIBRARY=${libjpeg:location}/lib/libjpeg.so
  -DJPEG_INCLUDE_DIR=${libjpeg:location}/include
  -DPNG_LIBRARY=${libpng:location}/lib/libpng.so
  -DPNG_PNG_INCLUDE_DIR=${libpng:location}/include
  -DBoost_INCLUDE_DIR=${boost-lib:location}/include
  -DOpenJPEG_DIR=${openjpeg:location}/lib/cmake/openjpeg-2.5/
  -DCMAKE_INSTALL_RPATH="${libjpeg:location}/lib:${nss:location}/lib:${nspr:location}/lib:${openjpeg:location}/lib:${libgpgme:location}/lib:${libpng:location}/lib:${cairo:location}/lib"
  -DCMAKE_INCLUDE_PATH="${freetype:location}/include;${nspr:location}/include/nspr;${nss:location}/include/nss;${libjpeg:location}/include;${libgpgme:location}/include;${openjpeg:location}/include/openjpeg-2.5"
  -DCMAKE_CXX_FLAGS="${:CMAKE_CFLAGS}"
  -DCMAKE_C_FLAGS="${:CMAKE_CFLAGS}"
  -G"Unix Makefiles"
make-binary = cd build && make

environment =
  PATH=${cmake:location}/bin:${pkgconfig:location}/bin:${xz-utils:location}/bin:%(PATH)s
  PKG_CONFIG_PATH=${fontconfig:location}/lib/pkgconfig:${fontconfig:pkg_config_depends}:${libpng:location}/lib/pkgconfig:${cairo:location}/lib/pkgconfig:${cairo:pkg_config_depends}:${icu4c:location}/lib/pkgconfig:${boost-lib:location}/lib/pkgconfig:${openjpeg:location}/lib/pkgconfig
  CPPFLAGS=-I${nss:location}/include/nss -I${nspr:location}/include/nspr -I${freetype:location}/include -I${libgpgme:location}/include -I${bzip2:location}/include -I${libjpeg:location}/include -I${libpng:location}/include -I${libtiff:location}/include -I${zlib:location}/include
  LDFLAGS=-Wl,-rpath=${:location}/lib -L${libgpg-error:location}/lib -Wl,-rpath=${libgpg-error:location}/lib -L${libgpgme:location}/lib -Wl,-rpath=${libgpgme:location}/lib -L${bzip2:location}/lib -Wl,-rpath=${bzip2:location}/lib -L${jbigkit:location}/lib -Wl,-rpath=${jbigkit:location}/lib -L${libjpeg:location}/lib -Wl,-rpath=${libjpeg:location}/lib -L${libtiff:location}/lib -Wl,-rpath=${libtiff:location}/lib -L${zlib:location}/lib -Wl,-rpath=${zlib:location}/lib -L=${cairo:location}/lib -Wl,-rpath=${cairo:location}/lib -L${nss:location}/lib -Wl,-rpath=${nss:location}/lib
  Gpgmepp_DIR=${libgpgme:location}

CMAKE_CFLAGS = -I${openjpeg:location}/include/openjpeg-2.5 -I${freetype:location}/include -I${nspr:location}/include/nspr -I${nss:location}/include/nss -I${libjpeg:location}/include -I${libgpgme:location}/include -I${libgpg-error:location}/include
location = @@LOCATION@@
