# qmpbackup special download
# qemu.qmp does no work with easy_install, thuss such hacky install

[qemu.qmp-download]
recipe = slapos.recipe.build:download
shared = true
url = https://files.pythonhosted.org/packages/c7/80/85263c535be9f9de8104e567658b0879c063c3d9bde3a39a7d27beea00eb/${:filename}
filename = qemu.qmp-0.0.3-py3-none-any.whl
md5sum = 52e22951d48ea79c7581d636cea86b26

[qmpbackup-download]
recipe = slapos.recipe.build:download
shared = true
url = https://github.com/abbbi/qmpbackup/releases/download/v0.29/${:filename}
filename = qmpbackup-0.29.tar.gz
md5sum = e0b90a79db6446ccf9e1e4ac7ac57a7e

[qmpbackup]
recipe = slapos.recipe.build
shared = true
dependencies =
  ${qemu.qmp-download:target}
  ${qmpbackup-download:target}
init =
  # add the python executable in the options dict so that
  # buildout signature changes if python executable changes
  import sys
  options['python-executable'] = sys.executable

install =
  import os, sys
  call([sys.executable, '-m', 'venv', '--clear', location])
  pip = os.path.join(location, 'bin', 'pip')
  call([pip, 'install', '--no-index', *options['dependencies'].split()])
  call([pip, 'uninstall', '-y', 'pip', 'setuptools'])
  options['qmpbackup'] = os.path.join(location, 'bin', 'qmpbackup')
  options['qmprebase'] = os.path.join(location, 'bin', 'qmprebase')
  # selftest
  call([options['qmpbackup'], '--help'])
  call([options['qmprebase'], '--help'])
