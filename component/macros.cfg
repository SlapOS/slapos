[macro-virtual-env]
recipe = slapos.recipe.build
template = ${macro-virtual-env-script:template}
name = venv
eggs =
install =
  from zc.buildout.easy_install import working_set
  import os
  import errno
  buildout = self.buildout['buildout']

  eggs = tuple(
    egg.strip()
    for egg in options['eggs'].splitlines()
    if egg.strip()
  )
  eggs_set = working_set(
    eggs,
    [buildout['develop-eggs-directory'], buildout['eggs-directory']]
  )
  python_path = ":".join(tuple(dist.location for dist in eggs_set))

  file = options['location']

  try:
    os.makedirs(os.path.abspath(os.path.dirname(file)))
  except OSError as e:
    if e.errno != errno.EEXIST:
      raise

  path = ":".join([os.path.dirname(buildout['executable']) ,buildout['bin-directory']])
  with open(file, "w") as f:
    f.write(options['template'] % {
      "path" : path,
      "pythonpath" : python_path,
      "name" : options['name'],
    })

# Template virtual env for bash shell in posix
[macro-virtual-env-script:posix]
template =
  alias deactivate='export PATH=$_OLD_VIRTUAL_PATH && unset _OLD_VIRTUAL_PATH && export PYTHONPATH=$_OLD_VIRTUAL_PYTHON_PATH && unset _OLD_VIRTUAL_PYTHON_PATH && export PS1=$_OLD_PS1 && unset _OLD_PS1 && unalias deactivate'
  VIRTUAL_ENV=%(path)s
  _OLD_VIRTUAL_PATH=$PATH
  export PATH=$VIRTUAL_ENV:$PATH
  VIRTUAL_PYTHON_PATH=%(pythonpath)s
  _OLD_VIRTUAL_PYTHON_PATH=$PYTHONPATH
  export PYTHONPATH=$VIRTUAL_PYTHON_PATH:$PYTHONPATH
  _OLD_PS1=$PS1
  export PS1='(%(name)s) '$PS1
