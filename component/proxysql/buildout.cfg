[buildout]
extends =
  ../autoconf/buildout.cfg
  ../automake/buildout.cfg
  ../libtool/buildout.cfg
  ../cmake/buildout.cfg
  ../openssl/buildout.cfg
  ../patch/buildout.cfg
  ../git/buildout.cfg
  ../openssl/buildout.cfg
  ../bzip2/buildout.cfg
  ../perl/buildout.cfg
  ../gnutls/buildout.cfg
  ../curl/buildout.cfg
  ../gnutls/buildout.cfg
  ../libzip/buildout.cfg
  ../m4/buildout.cfg
  ../pcre/buildout.cfg
  ../jemalloc/buildout.cfg
  ../libmicrohttpd/buildout.cfg

parts =
  proxysql

[proxysql-repository]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/sysown/proxysql.git
revision = v2.0.12
git-executable = ${git:location}/bin/git

[proxysql]
recipe = slapos.recipe.cmmi
# Use git repository path else, make will fail with $(error GIT_VERSION is not set)
path = ${proxysql-repository:location}
prefix = @@LOCATION@@
# Patch installation path for SlapOS
pre-configure =
  mkdir -p ${:prefix}/bin ${:prefix}/etc/init.d ${:prefix}/lib/systemd/system
  sed -i "
    s#/usr/bin#${:prefix}/bin#
    s# /etc# ${:prefix}/etc#g
    s#/usr/lib#${:prefix}/lib#
    s#/var/lib#${:prefix}/lib#g
    s#useradd#echo useradd#g
    s#systemctl#echo systemctl#g
    s#chkconfig#echo chkconfig#g
    s#update-rc.d#echo update-rc.d#g" Makefile

post-install =
# cleanup compiled libraries in deps/XXX, else testnode will complain with lib not found.
  make clean
  find deps/ -type f ! -size 0 -exec grep -IL . "{}" \;
configure-command = true
environment =
  PKG_CONFIG_PATH=${openssl:location}/lib/pkgconfig:${gnutls:location}/lib/pkgconfig:${libgcrypt:location}/lib/pkgconfig:${zlib:location}/lib/pkgconfig:${pcre:location}/lib/pkgconfig
  PATH=${m4:location}/bin:${libtool:location}/bin:${libgcrypt:location}/bin:${curl:location}/bin:${perl:location}/bin:${pkgconfig:location}/bin:${bzip2:location}/bin:${autoconf:location}/bin:${git:location}/bin:${automake:location}/bin:${patch:location}/bin:${cmake:location}/bin:%(PATH)s
  CXXFLAGS=-I${openssl:location}/include -I${gnutls:location}/include -I${zlib:location}/include
  CFLAGS=-I${gnutls:location}/include
  LDFLAGS=-L${openssl:location}/lib -Wl,-rpath -Wl,${gnutls:location}/lib -L${gnutls:location}/lib -Wl,-rpath=${curl:location}/lib -L${libtool:location}/lib -L${zlib:location}/lib -Wl,-rpath -Wl,${zlib:location}/lib -L${curl:location}/lib -L${pcre:location}/lib -L${jemalloc:location}/lib -L${libmicrohttpd:location}/lib
  CMAKE_INCLUDE_PATH=${openssl:location}/include:${gnutls:location}/include:${curl:location}/include:${pcre:location}/include:${jemalloc:location}/include:${libmicrohttpd:location}/include
  CMAKE_LIBRARY_PATH=${openssl:location}/lib:${gnutls:location}/lib:${curl:location}/lib:${pcre:location}/lib:${jemalloc:location}/lib:${libmicrohttpd:location}/lib
  LIBTOOL=libtool
  ACLOCAL_PATH=${pkgconfig:location}/share/aclocal:${libtool:location}/share/aclocal
