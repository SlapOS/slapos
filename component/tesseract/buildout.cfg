[buildout]
extends =
  ../autoconf/buildout.cfg
  ../automake/buildout.cfg
  ../jbigkit/buildout.cfg
  ../leptonica/buildout.cfg
  ../libpng/buildout.cfg
  ../libtool/buildout.cfg
  ../patch/buildout.cfg
  ../fontconfig/buildout.cfg
  ../lcms/buildout.cfg
  ../pkgconfig/buildout.cfg

parts =
  tesseract
  tesseract-traineddata

[tesseract]
recipe = slapos.recipe.cmmi
url = https://github.com/tesseract-ocr/tesseract/archive/refs/tags/4.1.1.tar.gz
md5sum = 51fe2bcbff1bbce77a25d180fd247f7d
pre-configure = 
  aclocal -I ${libtool:location}/share/aclocal -I${pkgconfig:location}/share/aclocal
  libtoolize -f -c
  libtoolize --automake
  autoheader -f
  automake -c -a -f
  autoconf -Wno-portability

# Generate a wrapper setting $TESSDATA_PREFIX
post-install =
  mv @@LOCATION@@/bin/tesseract @@LOCATION@@/bin/tesseract.bin
  cat > @@LOCATION@@/bin/tesseract <<EOF
  #!/bin/sh
  if [ -z "\$TESSDATA_PREFIX" ]; then
    export TESSDATA_PREFIX=${tesseract-traineddata:location}
  fi
  exec @@LOCATION@@/bin/tesseract.bin "\$@"
  EOF
  chmod +x @@LOCATION@@/bin/tesseract

environment =
  PATH=${autoconf:location}/bin:${automake:location}/bin:${libtool:location}/bin:${m4:location}/bin:${pkgconfig:location}/bin:%(PATH)s
  ACLOCAL_ARGS=-I${libtool:location}/share/aclocal -I${pkgconfig:location}/share/aclocal
  CPPFLAGS=-I${leptonica:location}/include
  PKG_CONFIG_PATH=${leptonica:location}/lib/pkgconfig
  LDFLAGS =-L${leptonica:location}/lib -Wl,-rpath=${leptonica:location}/lib -L${jbigkit:location}/lib -Wl,-rpath=${jbigkit:location}/lib -L${zlib:location}/lib -Wl,-rpath=${zlib:location}/lib


[tesseract-traineddata]
# Download some pre-trained data.
# By default we download eng, osd, fra, jpn and chi_sim.
# This can be extended by softwares, by extending urls option
recipe = slapos.recipe.build
urls =
  https://raw.githubusercontent.com/tesseract-ocr/tessdata/4.1.0/eng.traineddata 57e0df3d84fed9fbf8c7a8e589f8f012
  https://raw.githubusercontent.com/tesseract-ocr/tessdata/4.1.0/osd.traineddata 7611737524efd1ce2dde67eff629bbcf
  https://raw.githubusercontent.com/tesseract-ocr/tessdata/4.1.0/fra.traineddata a73e70c872f262895d93976febeb1638
  https://raw.githubusercontent.com/tesseract-ocr/tessdata/4.1.0/jpn.traineddata af3a30a9bec904e106aa8521e7caaeca
  https://raw.githubusercontent.com/tesseract-ocr/tessdata/4.1.0/chi_sim.traineddata 6965cb3213edd961cb16264e2ea45f5c
install =
  import os
  import shutil
  os.mkdir(options['location'])
  for line in options['urls'].splitlines():
    url, md5sum = line.split()
    shutil.copy(
        self.download(url, md5sum),
        os.path.join(options['location'], os.path.basename(url)))

