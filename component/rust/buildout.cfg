[buildout]
extends =
    ../llvm/buildout.cfg
    ../openssl/buildout.cfg
    ../pkgconfig/buildout.cfg
    ../python3/buildout.cfg
    ../xz-utils/buildout.cfg
    ../ninja/buildout.cfg
    ../cmake/buildout.cfg

parts = rustc

[rustc]
recipe = slapos.recipe.cmmi
shared = true
url = https://static.rust-lang.org/dist/rustc-1.92.0-src.tar.xz
md5sum = 844894a0369725cf1930b5a9b66e8f30
# --sysconfdir is a workaround for https://github.com/rust-lang/rust/issues/63915
configure-options =
    --enable-extended
    --llvm-config=${llvm:location}/bin/llvm-config
    --sysconfdir=@@LOCATION@@/etc
environment =
    PATH=${python3:location}/bin/:${curl:location}/bin/:${git:location}/bin:${pkgconfig:location}/bin:${xz-utils:location}/bin:${ninja:location}/bin:${cmake:location}/bin:%(PATH)s
    PKG_CONFIG_PATH=${openssl:location}/lib/pkgconfig
    RUSTFLAGS=-C link-arg=-Wl,-rpath=${openssl:location}/lib -C link-arg=-L${libxml2:location}/lib -C link-arg=-L${ncurses:location}/lib -C link-arg=-L${zlib:location}/lib -C link-arg=-Wl,-rpath=${libxml2:location}/lib -C link-arg=-Wl,-rpath=${ncurses:location}/lib -C link-arg=-Wl,-rpath=${zlib:location}/lib


[cargo-c]
recipe = slapos.recipe.cmmi
shared = true
url = https://github.com/lu-zero/cargo-c/archive/v0.10.19/cargo-c-0.10.19.tar.gz
md5sum = 6c62e37e21f4ff3a1739b0ed07f78974
configure-command = :
make-binary =
  cargo build --release &&
  mkdir -p @@LOCATION@@/bin &&
  for prog in cargo-capi cargo-cbuild cargo-cinstall cargo-ctest ; do
    cp target/release/$prog @@LOCATION@@/bin/
    chmod 755 @@LOCATION@@/bin/$prog
  done
make-targets =
environment =
  PATH=${rustc:location}/bin:%(PATH)s
  OPENSSL_DIR=${openssl:location}
  RUSTFLAGS=-C link-arg=-Wl,-rpath=${openssl:location}/lib -C link-arg=-Wl,-rpath=${zlib:location}/lib
