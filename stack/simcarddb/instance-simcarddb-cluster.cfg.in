[buildout]
extends = {{ neo_cluster }}

parts += directory
  store-service

[slap-parameter]
# Fetches parameters defined in SlapOS Master for this instance.
# Always the same.
recipe = slapos.cookbook:slapconfiguration.serialised
computer = ${slap-connection:computer-id}
partition = ${slap-connection:partition-id}
url = ${slap-connection:server-url}
key = ${slap-connection:key-file}
cert = ${slap-connection:cert-file}

[directory]
recipe = slapos.cookbook:mkdirectory
srv = ${buildout:directory}/srv
bin = ${buildout:directory}/bin
etc = ${buildout:directory}/etc
run = ${:etc}/run
var = ${buildout:directory}/var
log = ${buildout:directory}/var/log
var_run = ${buildout:directory}/var/run

[ca.crt]
recipe = slapos.recipe.template:jinja2
rendered = ${directory:etc}/ca.crt
template = inline:{{'{{'}}pem}}
context = key pem :pem
pem = ${slap-parameter:configuration._ca}

[neo.crt]
recipe = slapos.recipe.template:jinja2
rendered = ${directory:etc}/neo.crt
template = inline:{{'{{'}}pem}}
context = key pem :pem
pem = ${slap-parameter:configuration._cert}


[neo.key]
recipe = slapos.recipe.template:jinja2
rendered = ${directory:etc}/neo.key
template = inline:{{'{{'}}pem}}
context = key pem :pem
pem = ${slap-parameter:configuration._key}

[slave_db]
recipe = slapos.recipe.template:jinja2
template = {{ instance_slave_db_json }} 
rendered = ${directory:srv}/db.json
extensions = jinja2.ext.do
context =
  import json_module json 
  key slave_instance_list slap-parameter:slave-instance-list 

[store_db]
recipe = slapos.recipe.template:jinja2
template = {{ store_py_in }} 
rendered = ${directory:bin}/neostore
extensions = jinja2.ext.do
store_exectutable = {{ bin_directory }}/pythonwitheggs
context =
  import json_module json 
  key executable store_db:store_exectutable 

[store-service]
recipe = slapos.cookbook:wrapper
command-line = ${store_db:rendered} --ca ${ca.crt:rendered} --cert ${neo.crt:rendered} --name simcarddb --master ${node-0-final:connection-masters} --key ${neo.key:rendered} --json ${slave_db:rendered} --log ${directory:log}/store.log
wrapper-path = ${directory:run}/store_simcarddb
mode = 0775
pidfile = ${directory:var_run}/neo.pid
