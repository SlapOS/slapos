#!{{ python_executable }}
# BEWARE: This file is operated by slapgrid
# BEWARE: It will be overwritten automatically

import os, errno
import subprocess
from datetime import date

base_name = "{{ name }}".strip()
default = "{{ parameter_dict['default_parameter'] }}".strip()
apache_log_list = """{{ parameter_dict['apache-log-list'] }}""".split('\n')
base_list = [base.strip().split(' ') for base in
                """{{ parameter_dict['base-list'] }}""".split('\n') if base]
skip_base_list = [base.strip().split(' ') for base in
                """{{ parameter_dict['skip-base-list'] }}""".split('\n')
                if base]
erp5_base_list = [base.strip().split(' ') for base in
                  """{{ parameter_dict['erp5-base-list'] }}""".split('\n')
                  if base]

output_folder = "{{ output_folder }}".strip()
if not len(apache_log_list):
  exit(1)
if not os.path.exists(output_folder) or not os.path.isdir(output_folder):
  print "ERROR: Output folder is not a directory. Exiting..."
  exit(1)
today = date.today().strftime("%Y-%m-%d")
folder_today = os.path.join(output_folder, 'ApacheDex-%s' % today)

# XXX- don't raise if folder_today exist
try:
  os.makedirs(folder_today)
except OSError as exc:
  if exc.errno == errno.EEXIST and os.path.isdir(folder_today):
    pass
  else: raise

apachedex = "{{ apachedex_executable }}".strip()
argument_list = [apachedex, '--js-embed', '--out',
                  os.path.join(folder_today, 'ApacheDex-%s.html' % base_name)]
if default:
  argument_list += ['--default', default]

log_list = []
for logfile in apache_log_list:
  if not logfile:
    continue
  # Automaticaly replace variable 'date'.
  apache_log = logfile.strip() % {'date': date.today().strftime("%Y%m%d")}
  if not os.path.exists(apache_log):
    print "WARNING: File %s not found..." % apache_log
    continue
  log_list.append(apache_log)
if not log_list:
  print "WARNING: Log file list to analyse is empty or not provided. Exiting..."
  exit(1)

if erp5_base_list:
  argument_list.append('--erp5-base')
  for args_list in erp5_base_list:
    argument_list += args_list

if base_list:
  argument_list.append('--base')
  for args_list in base_list:
    argument_list += args_list

if skip_base_list:
  argument_list.append('--skip-base')
  for args_list in skip_base_list:
    argument_list += args_list

argument_list.append('--error-detail')
argument_list += log_list

subprocess.check_call(argument_list)
