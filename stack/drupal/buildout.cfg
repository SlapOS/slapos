[buildout]

extends =
  ../../component/pytest/buildout.cfg
  ../lamp/buildout.cfg
  buildout.hash.cfg

parts +=
  instance
  composer-bin
  install-drupal

[apache-php]
<= apache-php8.1

[python-interpreter]
eggs +=
  ${pytest:eggs}

[drupal-download]
<= template-download-base
url = ${:_profile_base_location_}/${:filename}

[custom-application-deployment]
db-name = drupal_db
db-user = drupal
publish-list =
  admin-username
  admin-password
enable-php8 = True

[install-drupal]
recipe = slapos.recipe.cmmi
path = ${application:location}
configure-command = true
make-targets =
make-options =
make-binary =
  composer install
#  ${composer-bin:output} update
  composer require drupal/next
  composer require --dev phpunit/phpunit
post-install =
  mkdir -p drush/config
  cp ${pathauto.pattern.article.yml:target} drush/config/
environment =
  COMPOSER_HOME=@@LOCATION@@
  PATH=${composer:location}/bin:${apache-php:location}/bin:%(PATH)s

[template-drupal-instance]
<= drupal-download

[template-settings.php]
<= drupal-download

[template-settings.local.php]
<= drupal-download

[template-drupal-apache.conf]
<= drupal-download

[pathauto.pattern.article.yml]
<= template-download-base
url = ${:_profile_base_location_}/config/${:filename}


# Update stack lamp for drupal
[lamp-instance]
output = ${buildout:directory}/instance-lamp.cfg

[instance]
recipe = slapos.recipe.template:jinja2
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/instance.cfg
extensions = jinja2.ext.do
context =
          key application_deployment_php8 custom-application-deployment:enable-php8
          key buildout_egg_directory buildout:eggs-directory
          key buildout_develop_directory buildout:develop-eggs-directory
          key buildout_directory buildout:directory
          key template_instance_drupal   template-drupal-instance:target
          key instance_lamp              lamp-instance:output
          key composer_location          composer:location
          key php_location               apache-php:location
          key mariadb_location           mariadb:location
          key template_apache_conf       template-drupal-apache.conf:target
          key template_settings_php      template-settings.php:target
          key template_settings_local    template-settings.local.php:target
