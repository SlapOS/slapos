[buildout]

extends =
  {{ template_monitor }}
  {{ logrotate_cfg }}
  {{ nxdtest_template }}
  {{ templace_apache_php }}

parts +=
  drupal-site-install


eggs-directory = {{ eggs_directory }}
develop-eggs-directory = {{ develop_eggs_directory }}
offline = true


[apache-php-configuration]
document-root = ${:default-document-root}/docroot

[template-base]
recipe = slapos.recipe.template:jinja2
context =
  section parameter_dict   instance-parameter

[settings.php]
<= template-base
url = {{ template_settings_php }}
output = ${directory:www}/docroot/sites/settings.base.php

[settings.local.php]
<= template-base
url = {{ template_settings_local }}
output = ${directory:www}/docroot/sites/settings.local.php

[drush-bin]
recipe = slapos.cookbook:wrapper
command-line =
  ${php-bin:wrapper-path} ${directory:www}/vendor/drush/drush/drush  --root ${directory:www}
wrapper-path = ${directory:bin}/drush
environment =
  PATH=${directory:bin}:$PATH

[composer-bin]
recipe = slapos.cookbook:wrapper
command-line =
  ${php-bin:wrapper-path} {{ composer_location }}/bin/composer-bin
wrapper-path = ${directory:bin}/composer

[blt-bin]
recipe = slapos.cookbook:wrapper
command-line =
  ${php-bin:wrapper-path} ${directory:www}/vendor/bin/blt
wrapper-path = ${directory:bin}/blt

[phpunit-bin]
recipe = slapos.cookbook:wrapper
command-line =
  ${php-bin:wrapper-path} ${directory:www}/vendor/bin/phpunit
wrapper-path = ${directory:bin}/phpunit

[mysql-bin]
recipe = slapos.cookbook:wrapper
command-line = "{{ mariadb_location }}/bin/mysql"
wrapper-path = ${directory:bin}/mysql

[mysqldump-bin]
recipe = slapos.cookbook:wrapper
command-line = "{{ mariadb_location }}/bin/mysqldump"
wrapper-path = ${directory:bin}/mysqldump

[env-base]
recipe = collective.recipe.template
input = inline:
  ${:env}
output = ${directory:etc}/.${:env-name}.env
mode = 600

[drupal-env]
<= env-base
env =
  export DRUPAL_PROFILE=${instance-parameter:site-profile}
  export LOCALE=${instance-parameter:site-locale}
  export DB_URL=${mariadb-urlparse:url}
  export SITE_NAME="${instance-parameter:site-name}"
  export SITE_MAIL=${instance-parameter:site-mail}
  export ACCOUNT_NAME="${instance-parameter:account-name}"
  export ACCOUNT_MAIL=${instance-parameter:account-mail}
  export ACCOUNT_PASS=${drupal-admin-passwd:passwd}
  export PATH={{ mariadb_location }}/bin:${directory:bin}:$PATH
env-name = site

[drupal-site-install]
output = ${directory:scripts}/drupal-install
recipe = collective.recipe.template
input = inline:#!/bin/sh
  set -e

  CONFIG_FILE=${directory:www}/docroot/sites/default/settings.php
  INSTALL_FILE=${directory:var}/.install-done
  if [ -s "$INSTALL_FILE" ]; then
    echo "Drupal is installed."
    exit 0;
  fi
  . ${drupal-env:output}
  if [ ! -s "$CONFIG_FILE" ]; then
    cp ${settings.php:output} $CONFIG_FILE
  fi
  drush site:install $DRUPAL_PROFILE \
    --locale=$LOCALE \
    --db-url=$DB_URL \
    --site-name="$SITE_NAME" \
    --site-mail=$SITE_MAIL \
    --account-name="$ACCOUNT_NAME" \
    --account-mail=$ACCOUNT_MAIL \
    --account-pass=$ACCOUNT_PASS \
    --verbose --yes

  # Rebuild all caches.
  drush cache:rebuild
{% if parameter_dict.get('php8') == True %}
  # install modules Next.js and Next.js JSON:API
  drush en next next_jsonapi --verbose --yes
  # install drush configs
  drush config-import --strict=0 --partial \
    --source=${directory:www}/drush/config \
    --uri=default --root=${directory:www} \
    --verbose --yes
  drush cache:rebuild
{%- endif %}

  echo "done" > $INSTALL_FILE
  chmod 440 $INSTALL_FILE
mode = 744
depends =
  ${settings.php:recipe}
  ${settings.local.php:recipe}
  ${composer-bin:recipe}
  ${drush-bin:recipe}
  ${phpunit-bin:recipe}
  ${blt-bin:recipe}
  ${mysql-bin:recipe}
  ${mysqldump-bin:recipe}
  ${cron-entry-drupal:recipe}

[drupal-admin-passwd]
recipe = slapos.cookbook:generate.password
storage-path = ${directory:etc}/.admin_pwd

[cron-entry-base]
recipe = slapos.cookbook:cron.d
cron-entries = ${cron:cron-entries}

[cron-entry-drupal]
<= cron-entry-base
name = drupal-cron
frequency = */20 * * * *
command = cd ${apache-php-configuration:document-root} && ${directory:bin}/drush core-cron

[instance-parameter]
tmp-dir = ${directory:tmp}
trusted-host-list =
  \[${apache-php-configuration:ip}\]
  ${request-frontend:connection-domain}
  ${slap-parameter:instance.trusted-host}
site-profile = ${slap-parameter:instance.site-profile}
site-locale = ${slap-parameter:instance.site-locate}
site-name = ${slap-parameter:instance.site-name}
site-mail = ${slap-parameter:instance.site-mail}
account-name = ${slap-parameter:instance.account-name}
account-mail = ${slap-parameter:instance.account-mail}

[publish-connection-information]
admin-username = ${instance-parameter:account-name}
admin-password = ${drupal-admin-passwd:passwd}

[slap-parameter]
instance.site-profile = standard
instance.site-locate = fr
instance.site-name = Drupal SlapOS
instance.site-mail = admin@example.com
instance.account-name = admin
instance.account-mail = admin@example.com
instance.trusted-host =
