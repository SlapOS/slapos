#!{{ python_executable }}
"""Restarts haproxy and waits for all workers to have been restarted"""
import errno
import contextlib
import socket
import sys
import time
ADMIN_SOCKET = {{ repr(admin_socket_path) }}


def send_command(command, connect_retries=10):
  with contextlib.closing(socket.socket(socket.AF_UNIX, socket.SOCK_STREAM)) as sock:
    while True:
      connect_retries = connect_retries - 1
      try:
        sock.connect(ADMIN_SOCKET)
      except OSError as e:
        if e.errno != errno.ECONNREFUSED:
          raise
        if not connect_retries:
          raise
        time.sleep(1)
      else:
        break
    sock.sendall((command + "\nquit\n").encode())
    response = b""
    while True:
      data = sock.recv(4096)
      if not data:
        break
      response += data
  return response.decode()

send_command("reload")

for _ in range(360):
  time.sleep(1)
  proc = send_command("show proc")
  if "old workers" not in proc:
    sys.exit(0)
print(proc)
sys.exit(1)