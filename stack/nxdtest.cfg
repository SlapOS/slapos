# Stack for creating testnode instances to be run via nxdtest on Nexedi testing
# infrastructure.
#
# Usage:
#
#    ---- 8< ---- (<software>/test.cfg)
#    [buildout]
#    extends = .../stack/nxdtest.cfg
#
#    parts =
#       ...
#
#    #  for instance
#       slapos-cookbook
#       instance.cfg
#
#    ...
#
#    [instance.cfg]
#    <= jinja2-template
#    template = inline:
#      [buildout]
#      extends = ${nxdtest-instance.cfg:rendered}
#
#      [runTestSuite]
#      env.sh  = ...
#      workdir = ...
#
# Created instance will have bin/runTestSuite that sources env.sh and runs
# nxdtest in workdir.

[buildout]
extends =
    slapos.cfg
    ../component/git/buildout.cfg
    nxdtest/buildout.hash.cfg

[jinja2-template]
recipe   = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/${:filename}
rendered = ${buildout:directory}/${:_buildout_section_name_}
mode     = 0644
context  =
  section buildout  buildout

[nxdtest-instance.cfg]
<= jinja2-template
template = ${:_profile_base_location_}/nxdtest/${:filename}
# NOTE += does not work
context =
  section buildout  buildout
  section nxdtest   nxdtest


[nxdtest]
recipe  = zc.recipe.egg:scripts
eggs    = ${nxdtest-egg:egg}
scripts = nxdtest
# convenience for nxdtest users
exe     = ${buildout:bin-directory}/nxdtest

[nxdtest-egg]
recipe  = zc.recipe.egg:develop
setup   = ${nxdtest-repository:location}
egg     = nxdtest

[nxdtest-repository]
recipe  = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/kirr/nxdtest.git
revision = bd91f6f1579a
location = ${buildout:parts-directory}/nxdtest
git-executable = ${git:location}/bin/git


[versions]
slapos.recipe.template = 4.4
