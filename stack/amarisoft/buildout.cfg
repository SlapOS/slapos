[buildout]

extends =
  ../slapos.cfg
  ../monitor/buildout.cfg
  ../../component/logrotate/buildout.cfg
  ../../component/gzip/buildout.cfg
  ../../component/msgpack-python/buildout.cfg
  ../../component/cython-zstd/buildout.cfg
  ../../component/python-mysqlclient/buildout.cfg
  ../../component/python-mysqlclient/buildout.cfg
  ../../component/nghttp2/buildout.cfg

parts =
  slapos-cookbook
  directory
  python-with-eggs
  monitor2-template
  ltelogs.jinja2.sh
# copy all configs by default
  mme.jinja2.cfg
  ims.jinja2.cfg
  enb.jinja2.cfg
  mbms.jinja2.cfg
#  license.jinja2.cfg
# sdr driver is dependent on ENB thus should be added explicitely by software.cfg
  sdr-driver
# unimplemented parts - the http monitor and better log handling using logrotate
#  apache-php
#  logrotate
  gzip

[neoppod-repository]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/nexedi/neoppod.git
git-executable = ${git:location}/bin/git

[neoppod-setup-env]
PATH = ${git:location}/bin:%(PATH)s

[neoppod-develop]
recipe = zc.recipe.egg:develop
setup = ${neoppod-repository:location}
environment = neoppod-setup-env

[python-with-eggs]
recipe = zc.recipe.egg
interpreter = ${:_buildout_section_name_}
eggs =
  neoppod[client]
  BTrees
  ZODB

[directory]
recipe = plone.recipe.command
config = ${buildout:directory}/config
command = mkdir -p ${buildout:directory}/config
stop-on-error = true

[amarisoft]
path = /opt/amarisoft

[copy-to-instance]
recipe  = slapos.recipe.build:download
url     = ${amarisoft:path}/${:_buildout_section_name_}

[copy-config-to-instance]
recipe  = slapos.recipe.build:download
url     = ${amarisoft:path}/config/${:_buildout_section_name_}
filename = ${:_buildout_section_name_}

[unpack-to-instance]
recipe = slapos.recipe.build:download-unpacked
lte-version = 2020-09-14
url = ${amarisoft:path}/${:lte-version}/lte${:_buildout_section_name_}-linux-${:lte-version}.tar.gz
destination = ${buildout:directory}/${:_buildout_section_name_}
strip-top-level-dir = true
ignore-existing = true
on-update = true

[enb.jinja2.cfg]
<= copy-config-to-instance
md5sum = 1716acb27dec624613eed7a8fe3fb499

[ltelogs.jinja2.sh]
<= copy-to-instance
md5sum = 1ba2e065bdf14a6411e95e80db17dcfd

[mme.jinja2.cfg]
<= copy-config-to-instance
md5sum = 295435feabd729c85eba4f2beeb33cbe

[ims.jinja2.cfg]
<= copy-config-to-instance
md5sum = 0dfa8f76838d9287ebe18e1276e21a80

[mbms.jinja2.cfg]
<= copy-config-to-instance
md5sum = d0a30c80ea8b0060db6a52320048549a

[license.jinja2.cfg]
<= copy-config-to-instance
md5sum = 1fd59d9f593122ab243881155e01c4f6

[enb]
<= unpack-to-instance
md5sum = ${lteenb-linux-2020-09-14:md5sum}

[mbmsgw]
<= unpack-to-instance
md5sum = ${ltembmsgw-linux-2020-09-14:md5sum}

[mme]
<= unpack-to-instance
md5sum = ${ltemme-linux-2020-09-14:md5sum}

[md5sum]
enb = ${enb.jinja2.cfg:md5sum}
mme = ${mme.jinja2.cfg:md5sum}
mbms = ${mbms.jinja2.cfg:md5sum}
ims = ${ims.jinja2.cfg:md5sum}

[sdr]
<= unpack-to-instance
url = ${amarisoft:path}/${:lte-version}/trx_${:_buildout_section_name_}-linux-${:lte-version}.tar.gz
destination = ${enb:destination}/x86_64
md5sum = ${trx_sdr-linux-2020-09-14:md5sum}

[lms]
<= unpack-to-instance
url = ${amarisoft:path}/${:lte-version}/trx_${:_buildout_section_name_}-linux-${:lte-version}.tar.gz
destination = ${enb:destination}/x86_64
md5sum = ${trx_lms-linux-2020-09-14:md5sum}

[sdr-driver]
# move trx_sdr.so next to lteenb binary
recipe  = slapos.recipe.build:download
url = ${sdr:destination}/trx_sdr.so
destination = ${enb:destination}/trx_sdr.so
#md5sum = 16cd39307bc85c17dcb7ff05157e2cff

[lteenb-linux-2020-09-14]
filename = 2020-09-14/lteenb-linux-2020-09-14.tar.gz
md5sum = afa275e8c16512d55f63690abeb08372

[ltembmsgw-linux-2020-09-14]
filename = 2020-09-14/ltembmsgw-linux-2020-09-14.tar.gz
md5sum = 0ac8c5fa4a0161a44d88ce406c548f7b

[ltemme-linux-2020-09-14]
filename = 2020-09-14/ltemme-linux-2020-09-14.tar.gz
md5sum = bb5dd3456f616d045dc2f207df03d2f7

[ltewww-linux-2020-09-14]
filename = 2020-09-14/ltewww-linux-2020-09-14.tar.gz
md5sum = a251e7a3f1584d5ee4d8c8bb496b1bb8

[trx_sdr-linux-2020-09-14]
filename = 2020-09-14/trx_sdr-linux-2020-09-14.tar.gz
md5sum = 19a11cdc49473cb91e21dc47459f575a


# this archive contains symbolic links
#[www]
#<= unpack-to-instance
#url = ${amarisoft:path}/ltewww-linux-${:lte-version}.tar.gz
