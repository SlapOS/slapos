# Selenium server
# https://seleniumhq.github.io/docs/grid.html

[buildout]
extends =
   ../../component/xorg/buildout.cfg
   ../../component/lxml-python/buildout.cfg
   ../../component/firefox/buildout.cfg
   ../../component/chromium/buildout.cfg
   ../../component/chromedriver/buildout.cfg
   ../../component/coreutils/buildout.cfg
   ../../component/java/buildout.cfg
   ../../component/caddy/buildout.cfg
   ../../component/openssh/buildout.cfg
   ../../component/fonts/buildout.cfg
   ../../component/fontconfig/buildout.cfg
   ../../stack/slapos.cfg
   ./buildout.hash.cfg
   ../../stack/monitor/buildout.cfg
  ../../component/headless-chromium/buildout.cfg
  ../../component/openssl/buildout.cfg
  ../../component/nginx/buildout.cfg

parts =
  slapos-cookbook
  collective.recipe.shelloutput
  template
  template-cfg

[collective.recipe.shelloutput]
recipe = zc.recipe.egg

[selenium-server]
recipe = slapos.recipe.build:download
version = 3.14.0
md5sum = 376450bd517510442b60018646deadfe
filename = selenium-server-standalone-${:version}.jar
url = https://selenium-release.storage.googleapis.com/3.14/${:filename}

[macro-template]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:filename}

[template]
<= macro-template
output = ${buildout:directory}/template.cfg

[template-selenium]
<= macro-template
output = ${buildout:directory}/template-selenium.cfg


# XXX firefox 62 and firefox 68 does not seem to honor <dir> from
# fonts.conf and only loads from system locations and from the fonts
# folder located in firefox part, so we copy (actually, symlink) some
# fonts there, otherwise firefox cannot find its standard fonts.
[symlink-extra-fonts-to-firefox-fonts-dir]
extra-fonts =
  ${android-fonts:location}
  ${dejavu-fonts:location}
  ${ipa-fonts:location}
  ${ipaex-fonts:location}
  ${liberation-fonts:location}
  ${ocrb-fonts:location}
install =
  import os
  for extra_font_dir in '''${:extra-fonts}'''.splitlines():
    dst = os.path.join(location, 'fonts', os.path.basename(extra_font_dir))
    os.symlink(extra_font_dir, dst)

[firefox-60]
post-install =
  ${symlink-extra-fonts-to-firefox-fonts-dir:install}

[firefox-68]
post-install =
  ${symlink-extra-fonts-to-firefox-fonts-dir:install}

[firefox-78]
post-install =
  ${symlink-extra-fonts-to-firefox-fonts-dir:install}

#for headless chromium

[template-cfg]
recipe = slapos.recipe.template:jinja2
output = ${buildout:directory}/template-headless.cfg
url = ${:_profile_base_location_}/${:filename}
context =
  section buildout buildout
  key openssl_location openssl:location
  key nginx_location nginx:location
  key liberation_fonts_location liberation-fonts:location
  key fontconfig_location fontconfig:location
  key chromium_wrapper headless-chromium-wrapper:output
  key devtools_frontend headless-chromium:devtools-frontend
  key template_nginx_config_target template-nginx-conf:target
  key template_mime_types_target template-mime-types:target
  key template_fonts_conf_target template-fonts-conf:output
  key template_instance_headless_chromium_target instance-headless-chromium:target
  key template_monitor monitor2-template:output

[download-base]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:_update_hash_filename_}

[instance-headless-chromium]
<= download-base

[template-nginx-conf]
<= download-base

[template-mime-types]
<= download-base
