# instance-ors-enb translates ORS enb/gnb into generic enb with 1 SDR RU and 1 CELL.

{#- enb_mode indicates with which mode ors' enb is instantiated with - enb | gnb #}
{%- set enb_mode = slap_configuration['slap-software-type'] %}
{%- do assert(enb_mode in ('enb-gnb', 'enb', 'gnb'), enb_mode) %}

# code of generic enb
{%  include 'instance-enb-base.jinja2.cfg' %}

# let all templates know we are running in ORS mode
[config-base]
context -=
   json ors false
context +=
   json ors true
   key sdr100 :sdr100
sdr100 = {{ slapparameter_dict.sdr100 }}


# add ORS-specific bits to published information
[publish-connection-information]
{%- for p in publish %}
{{ p }} = {{ publish[p] }}
{%- endfor %}

# hide ru-list, cell-list, peer-list and peer-cell-list from published information
[publish-connection-information]
depends += ${publish-connection-information-ors-cleanup:recipe}
[publish-connection-information-ors-cleanup]
recipe = slapos.recipe.build
init =
  publish = self.buildout['publish-connection-information']
  del publish['NODEB.ru-list']
  del publish['NODEB.cell-list']
  del publish['NODEB.peer-list']
  del publish['NODEB.peer-cell-list']
  del publish['depends']

{%- if slapparameter_dict.cell1.enable_cell %}
# Add custom promise to check if /dev/sdr0 is busy
[check-frequency-outofbounds.py]
<= macro.promise
promise = check_frequency_outofbounds
config-frequency    = {{ slapparameter_dict.cell1.dl_frequency }}
config-range-rating = {{ slapparameter_dict.cell1.range }}
{%- endif %}

{%- if slapparameter_dict.cell2.enable_cell %}
# Add custom promise to check if /dev/sdr1 is busy
[check-frequency-outofbounds-sdr1.py]
<= macro.promise
promise = check_frequency_outofbounds
config-frequency    = {{ slapparameter_dict.cell2.dl_frequency }}
config-range-rating = {{ slapparameter_dict.cell2.range }}
{%- endif %}

[buildout]
extra-parts +=
{%- if slapparameter_dict.cell1.enable_cell %}
  check-frequency-outofbounds.py
{%- endif %}
{%- if slapparameter_dict.cell2.enable_cell %}
  check-frequency-outofbounds-sdr1.py
{%- endif %}
