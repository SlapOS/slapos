[buildout]
extends =
  buildout.hash.cfg
  ../../stack/slapos.cfg
  ../../component/cmake/buildout.cfg
  ../../component/bison/buildout.cfg
  ../../component/flex/buildout.cfg

parts =
  slapos-cookbook
  fluentbit-source
  fluentbit
  instance-profile

[instance-profile]
recipe = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/instance.cfg.in
rendered = ${buildout:directory}/instance.cfg
context =
  section buildout buildout
  key fluentbit_source_location fluentbit-source:location

[fluentbit-source]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/fluent/fluent-bit.git
revision = f247c179baccfacc88103b033cb744ae21879466

[fluentbit]
recipe = slapos.recipe.cmmi
path=${fluentbit-source:location}
environment =
  M4=${m4:location}/bin/m4
  PATH=${bison:location}/bin:${fluentbit-source:location}:%(PATH)s
location = ${buildout:parts-directory}/${:_buildout_section_name_}
configure-command =
  cd build && ${cmake:location}/bin/cmake .. -DFLB_CONFIG_YAML=Off .
make-targets =
make-binary =
  cd build && make
