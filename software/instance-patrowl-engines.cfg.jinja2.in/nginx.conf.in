worker_processes {{ parameter_dict['nb-workers'] }};

pid {{ parameter_dict['path-pid'] }};
error_log {{ parameter_dict['access-log' ] }};

daemon off;

events {
  worker_connections 1024;
  accept_mutex off;
}

http {
    include {{ parameter_dict['nginx-mime-types'] }};
    default_type  application/octet-stream;
    types_hash_bucket_size 64;
    access_log {{ parameter_dict['access-log' ] }} combined;

    server {
        listen [{{ parameter_dict['nginx-ip' ] }}]:{{ parameter_dict['nginx-port' ] }} ssl http2;
        autoindex off;
        server_name _;

        ssl_certificate {{ parameter_dict['cert-file'] }};
        ssl_certificate_key {{ parameter_dict['key-file'] }};
        ssl_session_timeout 1d;
        ssl_session_cache shared:MozSSL:10m;
        ssl_session_tickets off;
        ssl_protocols TLSv1.3;
        ssl_prefer_server_ciphers off;

        # Protects against Clickjacking attacks.
        add_header X-Frame-Options "SAMEORIGIN";

        # Protects against Clickjacking attacks.
        add_header Strict-Transport-Security "max-age=63072000; includeSubdomains";

        # Protects against XSS injections.
        add_header X-XSS-Protection "1; mode=block";

        # Protects against MIME-type confusion attack.
        add_header X-Content-Type-Options "nosniff";

        # CSP modern XSS directive-based defence, used since 2014.
        add_header Content-Security-Policy "default-src 'self'; font-src *;img-src * data:; script-src *; style-src *;";

        # Prevents from leaking referrer data over insecure connections.
        add_header Referrer-Policy 'strict-origin';

        # Disable any limits to avoid HTTP 413 for large image uploads
        client_max_body_size 0;

        location / {
            proxy_pass {{ parameter_dict['gunicorn-url'] }};

            proxy_set_header                        X-Forwarded-Proto https;
            proxy_set_header                        X-Forwarded-For   $proxy_add_x_forwarded_for;
            proxy_set_header                        X-Forwarded-Host  $http_host;
            proxy_set_header                        X-Real-IP         $remote_addr;
            proxy_set_header                        Host              $http_host;
            proxy_set_header                        X-Forwarded-Ssl   on;

            proxy_set_header Proxy                  "";

            add_header 'Cache-Control' 'no-store, no-cache, must-revalidate, proxy-revalidate, max-age=0';
            expires off;

            # Custom headers
            proxy_connect_timeout                   75s;
            proxy_read_timeout                      300s;

            proxy_redirect                          off;
            proxy_buffering                         off;
            proxy_buffer_size                       "4k";
        }

        location /static {
            alias {{ parameter_dict['patrowl-directory'] }}/staticfiles;
        }
    #    location /media {
    #        alias /opt/patrowl-manager/media;
    #    }
    }
}
