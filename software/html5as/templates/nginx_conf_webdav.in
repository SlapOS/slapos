worker_processes {{ param_html5as['nb_workers'] }};

pid {{ param_html5as['path_pid'] }};
error_log {{ param_html5as['path_error_log'] }};

daemon off;

events {
	worker_connections 1024;
	accept_mutex off;
}

http {
	include {{ param_html5as['path_mime_types'] }};
	default_type application/octet-stream;
	types_hash_bucket_size 64;
  access_log {{ param_html5as['path_access_log'] }} combined;
	index index.html;

  server {
    listen [{{ param_html5as['ip'] }}]:{{ param_html5as['port'] }};
    server_name _;

    keepalive_timeout 5;
    client_body_temp_path {{ param_tempdir['client_body_temp_path'] }};
    proxy_temp_path {{ param_tempdir['proxy_temp_path'] }};
    fastcgi_temp_path {{ param_tempdir['fastcgi_temp_path'] }};
    uwsgi_temp_path {{ param_tempdir['uwsgi_temp_path'] }};
    scgi_temp_path {{ param_tempdir['scgi_temp_path'] }};

    # path for static files
    root {{ webdav_dir }};

    auth_basic              realm_name;
    auth_basic_user_file    {{ password_file }};
    dav_methods PUT DELETE MKCOL COPY MOVE;
    dav_ext_methods PROPFIND OPTIONS;
    dav_access user:rw group:rw all:rw;
    autoindex on;
    client_max_body_size    0;
    create_full_put_path    on;
    location / {
      add_header 'Access-Control-Allow-Origin' '*' always;
      add_header 'Access-Control-Allow-Credentials' 'true' always;
      add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, PUT, OPTIONS, MOVE, DELETE, COPY, LOCK, UNLOCK' always;
      add_header 'Access-Control-Allow-Headers' 'Authorization,DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,X-Accept-Charset,X-Accept,origin,accept,if-match,destination,overwrite' always;
      add_header 'Access-Control-Expose-Headers' 'ETag' always;
      add_header 'Access-Control-Max-Age' 1728000 always;
      if ($request_method = 'OPTIONS') {
        add_header 'Content-Type' 'text/plain charset=UTF-8';
        add_header 'Content-Length' 0;
        add_header 'Access-Control-Allow-Origin' '*';
        add_header 'Access-Control-Allow-Credentials' 'true';
        add_header 'Access-Control-Allow-Methods' 'GET, HEAD, POST, PUT, OPTIONS, MOVE, DELETE, COPY, LOCK, UNLOCK';
        add_header 'Access-Control-Allow-Headers' 'Authorization,DNT,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,X-Accept-Charset,X-Accept,origin,accept,if-match,destination,overwrite';
        add_header 'Access-Control-Expose-Headers' 'ETag';
        add_header 'Access-Control-Max-Age' 1728000;
        return 204;
      }
    }
  }
}
