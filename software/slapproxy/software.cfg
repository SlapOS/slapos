[buildout]
extends =
  ../../component/git/buildout.cfg
  ../../stack/haproxy/default-backend.cfg
  ../../stack/monitor/buildout.cfg
  ../../stack/slapos.cfg
  buildout.hash.cfg
parts =
  instance.cfg


# Until slapproxy_offline_ui is merged and released
# --->
[slapos.core-repository]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/romain/slapos.core.git
branch = slapproxy_offline_ui
git-executable = ${git:location}/bin/git

[slapos.core-dev]
recipe = zc.recipe.egg:develop
egg = slapos.core
setup = ${slapos.core-repository:location}

[slapos-command]
depends = ${slapos.core-dev:recipe}
# <---


[directory]
recipe = slapos.recipe.build:mkdirectory
json-schema = ${buildout:directory}/json-schema
monitor-app = ${buildout:directory}/monitor-app


[monitor.app]
recipe = slapos.recipe.build
location = ${directory:monitor-app}
url = https://officejs.erp5.net/document_module/20241218-47F9BCC3/Base_download
md5sum = a1694f4cc29d00c32f78790a4ac073e1
install =
  import zipfile
  archive = self.download(options['url'], options['md5sum'])
  with zipfile.ZipFile(archive, 'r') as z:
    z.extractall(location)


[macro.download.template]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:_buildout_section_name_}.in
output = ${buildout:directory}/${:_buildout_section_name_}


[instance.cfg]
<= macro.download.template
depends = ${slapos-cookbook:recipe}

[instance-slapproxy.cfg.jinja]
<= macro.download.template


[macro.download.jsonschema]
recipe = slapos.recipe.build
url = ${:_profile_base_location_}/${:_buildout_section_name_}
location = ${directory:json-schema}/${:_buildout_section_name_}
install =
  import shutil
  shutil.copyfile(self.download(options['url'], options['md5sum']), location)


[software.cfg.json]
<= macro.download.jsonschema
depends =
  ${instance-slapproxy-input-schema.json:recipe}

[instance-slapproxy-input-schema.json]
<= macro.download.jsonschema
