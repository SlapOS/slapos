[buildout]
extends =
  buildout.hash.cfg
  ../../stack/monitor/buildout.cfg

parts +=
  template

[httpbin-requirements]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:filename}

[httpbin]
# Install in separate venv, as there are unsolvable version conflitcs
# with SlapOS eggs
recipe = slapos.recipe.build
shared = true
init =
  # add the python executable in the options dict so that
  # buildout signature changes if python executable changes
  import sys
  options['python-executable'] = sys.executable

httpbin-requirements = ${httpbin-requirements:target}

install =
  import os, sys
  call([sys.executable, '-m', 'venv', '--clear', location])
  pip = os.path.join(location, 'bin', 'pip')
  call([pip, 'install', '--requirement', options['httpbin-requirements']])
  # selftest
  python = os.path.join(location, 'bin', 'python')
  call([python, '-c', 'import httpbin'])

[template]
recipe = slapos.recipe.template:jinja2
url = ${:_profile_base_location_}/instance.cfg.in
output = ${buildout:directory}/template.cfg
flask = ${httpbin:location}/bin/flask
context =
  key flask :flask
  key develop_eggs_directory buildout:develop-eggs-directory
  key eggs_directory buildout:eggs-directory
  key profile_monitor monitor-template:output
