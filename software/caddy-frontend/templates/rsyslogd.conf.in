module(
  load="imuxsock"
  SysSock.Name="{{ configuration['log-socket'] }}")

# Just simply output the raw line without any additional information, as
# haproxy emits enough information by itself
$template rawoutput,"%msg%\n"
$ActionFileDefaultTemplate rowaoutput

$FileCreateMode 0600
$DirCreateMode 0700
$Umask 0022

$WorkDirectory {{ configuration['spool-directory'] }}

{%- for slave_instance in backend_slave_list %}
{#-   matching the way how haproxy emits information regarding the backend #}
{%-   set match = "backend " ~ slave_instance['slave_reference'] ~ "-http" %}
:msg, contains, "{{ match }}"
*.* {{ slave_instance['backend_log'] }}
{#- after emitting, discard the message, especially to clean up catch-all filter #}
:msg, contains, "{{ match}}" ~
{% endfor %}

{#- emit all not catched messages to full log file #}
*.* {{ configuration['log-file'] }}
