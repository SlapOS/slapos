#!/bin/sh

RUN_DIR={{ directory_run }}
ETC_DIR={{ directory_etc }}
BIN_DIR={{ directory_bin }}

NGINX_SIGNATURE_FILE=$RUN_DIR/nginx_configuration.signature
NNGINX_SIGNATURE_FILE=$RUN_DIR/nnginx_configuration.signature

touch $NGINX_SIGNATURE_FILE
sha256sum $ETC_DIR/nginx.cfg $ETC_DIR/nginx-slave-conf.d/*.conf | sort -k 66 > $NNGINX_SIGNATURE_FILE

# If no diff, no restart for now
if diff "$NGINX_SIGNATURE_FILE" "$NNGINX_SIGNATURE_FILE"; then
  echo "Nothing Changed, so nothing to reload"
  exit 0
fi
echo "Reloading nginx.."

{{ nginx_graceful_reload_command }}

mv "$NNGINX_SIGNATURE_FILE" "$NGINX_SIGNATURE_FILE"
