module(
  load="imuxsock"
  SysSock.Name="{{ configuration['log-socket'] }}")

$FileCreateMode 0600
$DirCreateMode 0700
$Umask 0022

$WorkDirectory {{ configuration['spool-directory'] }}

# Setup logging per slave, by extracting the slave name from the log stream
{%- set regex = "^\\\\s*(.*)-https{0,1} (.*)" %}
# Extract file name part from 1st match
template(name="extract_slave_name" type="string" string="%msg:R,ERE,1,FIELD:{{ regex }}--end%")
set $!slave_name = exec_template("extract_slave_name");
template(name="slave_output" type="string" string="{{ configuration['slave-log-directory'] }}/%$!slave_name%_frontend_log")
# Output only 2nd match
template(name="rawoutput" type="string" string="%msg:R,ERE,2,FIELD:{{ regex }}--end%")
$ActionFileDefaultTemplate rawoutput
# React on match
if (re_match($msg, "{{ regex }}")) then {
 action(type="omfile" dynaFile="slave_output")
 stop
}

{#- emit all not catched messages to full log file #}
*.* {{ configuration['log-file'] }}
