# NON PROD CONFIG
global
  maxconn 4096
log stderr local0
defaults
  log global
  mode http
  option httplog
  option dontlognull
  retries 1
  option redispatch
  maxconn 2000
  cookie SERVERID rewrite
  balance roundrobin
  stats uri /haproxy
  stats realm Global\ statistics
  timeout server 305s
  timeout queue 60s
  timeout connect 5s
  timeout client 305s
  option httpclose

frontend http-backend
  bind {{ configuration['local_ipv4'] }}:{{ configuration['backend_haproxy_port'] }}
  capture request header Host len 300 {# XXX-DEBUG #}
{%- for slave_instance in backend_slave_list %}
{%-   set host_list = slave_instance.get('server-alias', '').split() %}
{%-   if slave_instance.get('custom_domain') not in host_list %}
{%-     do host_list.append(slave_instance.get('custom_domain')) %}
{%-   endif %}
{%-   for host in host_list %}
  acl is_{{ slave_instance['slave_reference'] }} hdr_dom(host) -i {{ host }}
{%-   endfor %}
  use_backend {{ slave_instance['slave_reference'] }} if is_{{ slave_instance['slave_reference'] }}
{%- endfor %}

frontend https-backend
  bind {{ configuration['local_ipv4'] }}:{{ configuration['backend_haproxy_https_port'] }}
  capture request header Host len 300 {# XXX-DEBUG #}
{%- for slave_instance in backend_slave_list %}
{%-   set host_list = slave_instance.get('server-alias', '').split() %}
{%-   if slave_instance.get('custom_domain') not in host_list %}
{%-     do host_list.append(slave_instance.get('custom_domain')) %}
{%-   endif %}
{%-   for host in host_list %}
  acl is_{{ slave_instance['slave_reference'] }}-https hdr_dom(host) -i {{ host }}
{%-   endfor %}
  use_backend {{ slave_instance['slave_reference'] }}-https if is_{{ slave_instance['slave_reference'] }}-https
{%- endfor %}
{%- for slave_instance in backend_slave_list %}
{%-   set url = slave_instance.get('backend_url', slave_instance.get('url', '')) %}
{%-   set parsed = urlparse_module.urlparse(url) %}
{%-   set backend_host = parsed.hostname %}
{%-   set backend_port = parsed.port %}
{%-   if parsed.scheme == 'https' %}
{#-     support ssl_proxy_verify #}
{%-     set ssl = 'ssl verify none' %}
{%-   else %}
{%-     set ssl = '' %}
{%-   endif %}
{%-   set https_url = slave_instance.get('https_backend_url', slave_instance.get('https-url', '')) %}
{%-   set https_parsed = urlparse_module.urlparse(https_url) %}
{%-   set https_backend_host = https_parsed.hostname %}
{%-   set https_backend_port = https_parsed.port %}
{%-   if https_parsed.scheme == 'https' %}
{#-     support ssl_proxy_verify #}
{%-     set https_ssl = 'ssl verify none' %}
{%-   else %}
{%-   set https_ssl = '' %}
{%-   endif %}

backend {{ slave_instance['slave_reference'] }}
{%-   if backend_host and backend_port %}
  server backend {{ backend_host }}:{{ backend_port }} {{ ssl }}
{%-   endif %}

backend {{ slave_instance['slave_reference'] }}-https
{%-   if https_backend_host and https_backend_port %}
  server backend {{ https_backend_host }}:{{ https_backend_port }} {{ https_ssl }}
{%-   endif %}
{%- endfor %}
