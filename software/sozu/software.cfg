[buildout]

extends =
  ../../component/rust/buildout.cfg
  ../../stack/monitor/buildout.cfg
  buildout.hash.cfg

parts =
  slapos-cookbook
  instance.cfg

[sozu]
recipe = plone.recipe.command
stop-on-error = true
update-command = ${:command}
location = ${buildout:parts-directory}/${:_buildout_section_name_}
command =
  INSTALL_DIR=${:location}
  mkdir -p $INSTALL_DIR && cd $INSTALL_DIR
  PATH=${rustc:location}/bin:$PATH
  cargo install --root=${:location} sozu

[sozu-d]
recipe = slapos.recipe.cmmi
url = https://github.com/sozu-proxy/sozu/archive/refs/tags/0.15.6.tar.gz
md5sum = 4cd4386b64c652af5ad416b10b6ca246
configure-command = :
make-binary = cargo install --root=%(location)s --path . --locked
make-targets =
environment =
  PATH=${rustc:location}/bin:%(PATH)s

[dl-template]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:filename}

[instance.cfg]
recipe = slapos.recipe.template:jinja2
output = ${buildout:directory}/instance.cfg
url = ${:_profile_base_location_}/${:filename}
context =
    key buildout_bin_directory buildout:bin-directory
    key buildout_egg_directory buildout:eggs-directory
    key buildout_develop_directory buildout:develop-eggs-directory
    key buildout_directory buildout:directory
    key template_monitor_cfg monitor2-template:output
    key logrotate_cfg template-logrotate-base:output
    key config_toml   config.toml:target
    key openssl_location openssl:location
    key sozu_location  sozu:location
    key template_sozu_cfg template-sozu:target
    key template_publish_slave publish-sozu-slave-parameters.cfg:target

[template-sozu]
<= dl-template

[config.toml]
<= dl-template

[publish-sozu-slave-parameters.cfg]
<= dl-template
