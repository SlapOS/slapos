[buildout]
extends = {{ instance_common_cfg }}
parts = 
  neoctl-shortcut
  directory

[jinja2-template-base]
rendered = ${buildout:parts-directory}/${:_buildout_section_name_}.cfg

[neo-cluster]
<= jinja2-template-base
template = {{ cluster }}
extra-context =
    import urlparse urlparse
import-list =
    rawfile root_common {{ root_common }}

[neo-storage-mysql]
extra-context +=
    raw runTestSuite_in {{ runTestSuite_in }}

[switch-softwaretype]
recipe = slapos.cookbook:switch-softwaretype
override = {{ dumps(override_switch_softwaretype |default) }}
default = neo-cluster:rendered
# BBB
RootSoftwareInstance = ${:default}
neo = neo-storage-mysql:rendered

[instance-parameter]
recipe = slapos.cookbook:slapconfiguration
computer = ${slap_connection:computer_id}
partition = ${slap_connection:partition_id}
url = ${slap_connection:server_url}
key = ${slap_connection:key_file}
cert = ${slap_connection:cert_file}

[directory]
recipe = slapos.cookbook:mkdirectory
bin = ${buildout:directory}/bin
etc = ${buildout:directory}/etc

[neoctl-shortcut]
recipe = slapos.cookbook:wrapper
key = ${buildout:directory}/etc/neo.key
cert = ${buildout:directory}/etc/neo.crt
ca = ${buildout:directory}/etc/ca.crt
target-script-dir = {{ script_directory }}/bin

command-line =
   python ${:target-script-dir}/neoctl -a [${instance-parameter:ipv6-random}]:2050 
         --ca ${:ca} --cert ${:cert} --key ${:key}
parameters-extra = True
wrapper-path = ${directory:bin}/neoctl