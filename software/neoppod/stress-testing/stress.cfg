[buildout]
extends =
  ../../../component/vm-img/debian.cfg
parts =
  stress

[stress]
<= vm-run-base
smp = 8
# NEO processes take ~2G with default settings,
# the rest is mainly for the DB (which is in tmpfs)
mem = 4096
duration = 3600
stress-args =
run-args = -L .24 -r 0
mount.slapos = ${:_profile_base_location_}/../../..
NetfilterQueue = 1.1.0
python = python3
software = software-py3.cfg
command =
  mkdir log software
  cd software
  cat <<EOF >buildout.cfg
  [buildout]
  extends =
    /mnt/slapos/software/neoppod/${:software}
    /mnt/slapos/software/neoppod/sqlite-mixin.cfg
  parts =
    neoppod-develop
    neoppod
  develop = /mnt/slapos
  extensions -= slapos.rebootstrap
  [slapos-cookbook-develop]
  recipe =
  setup =
  [NetfilterQueue]
  # It was released on PyPI with a too old version of Cython for Python 3.11+
  # and we already build Cython for cython-zstd.
  recipe = zc.recipe.egg:custom
  egg = \$${:_buildout_section_name_}
  setup-eggs = \$${cython:egg}
  [neoppod-repository]
  repository = /mnt/neoppod
  revision =
  shared = true
  [neoppod]
  eggs +=
    \$${NetfilterQueue:egg}
    gevent
  interpreter = py
  [versions]
  slapos.cookbook =
  NetfilterQueue = ${:NetfilterQueue}
  [zodbtools]
  recipe =
  egg =
  setup =
  depends =
  # use the following components from the OS
  # and don't build dependencies for nothing
  [git]
  recipe =
  location = /usr
  environment =
  configure-options =
  [libffi]
  recipe =
  location = /usr
  [openssl]
  recipe =
  location = /usr
  configure-options =
  make-options =
  make-targets =
  environment =
  [patch]
  recipe =
  location = /usr
  [perl]
  recipe =
  location = /usr
  configure-command =
  environment =
  [pkgconfig]
  recipe =
  location = /usr
  environment =
  [${:python}]
  recipe =
  location = /usr
  environment =
  [xz-utils]
  recipe =
  location = /usr
  [zstd]
  recipe =
  location = /usr
  environment =
  EOF
  python -S /mnt/buildout/bin/buildout bootstrap
  MAKEFLAGS=-j${:smp} bin/buildout
  df ~ /tmp >&2
  screen -L -Logfile $PARTDIR/stdout -D -m sudo /mnt/slapos/software/neoppod/stress-testing/stress $PARTDIR ${:duration} ${:stress-args} -- ${:run-args}
  df ~ /tmp >&2

[stress:python2]
NetfilterQueue = 0.9.0
python = python2.7
software = software.cfg
