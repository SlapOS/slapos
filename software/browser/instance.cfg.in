#############################
#
# Browser as a service
#
#############################
[buildout]
parts =
  publish-connection-parameter
  xvfb-instance
  browser
  cron-entry-logrotate
  cron-entry-browser


[instance]
# Fetch arbitrary parameters defined by the user in SlapOS Master for his instance.
# We use the slapconfiguration recipe with a few parameters (partition id,
# computer id, certificate, etc).
# It will then authenticate to SlapOS Master and fetch the instance parameters.
# The parameters are accessible from ${instance-parameter:configuration.name-of-parameter}
# Always the same. Just copy/paste.
# See docstring of slapos.cookbook:slapconfiguration for more information.
recipe = slapos.cookbook:slapconfiguration
computer = ${slap_connection:computer_id}
partition = ${slap_connection:partition_id}
url = ${slap_connection:server_url}
key = ${slap_connection:key_file}
cert = ${slap_connection:cert_file}

# All configuration parameters should have a default.
configuration.browser-url = https://www.signal5g.com/portal_tests/lte_request_ui_zuite/core/TestRunner.html?test=..%2Ftest_suite_html&auto=true&resultsUrl=..%2FpostResults
configuration.browser-timeout = 300
configuration.browser-period = 2

# Create all needed directories, depending on your needs
[directory]
recipe = slapos.cookbook:mkdirectory
home = ${buildout:directory}
bin = ${:home}/bin
etc = ${:home}/etc
var = ${:home}/var
log = ${:var}/log
run = ${:var}/run
# Executables put here will be started but not monitored (for startup scripts)
script = ${:etc}/run
# Executables put here will be started and monitored (for daemons)
service = ${:etc}/service
# Executables to be periodically run
promise = ${:etc}/promise
# Software-specific folders
# Xserver
framebuffer = ${directory:srv}/framebuffer
# Dcron
cron-entries = ${:etc}/cron.d
crontabs = ${:etc}/crontabs
cronstamps = ${:var}/cronstamps
# Logrotate
logrotate = ${:var}/logrotate
logrotate-entries = ${:logrotate}/entries
logrotate-backup = ${:logrotate}/backup

[browser]
recipe = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/browse-url.sh.in
# md5sum = <TODO>
rendered = ${directory:bin}/browse-url.sh
mode = 0744
context =
  raw dash {{ dash['location'] }}/bin/dash
  key browser firefox-instance:runner-path
  key url instance:configuration.browser-url
  key timeout instance:configuration.browser-timeout

[cron-entry-browser]]
<= cron
recipe = slapos.cookbook:cron.d
name = browser
frequency = 0 */${instance:configuration.browser-period} * * *
command = ${browser:rendered}

[cron]
recipe = slapos.cookbook:cron
dcrond-binary = {{ dcron['location'] }}/sbin/crond
cron-entries = ${directory:cron-entries}
crontabs = ${directory:crontabs}
cronstamps = ${directory:cronstamps}
catcher = ${cron-simplelogger:wrapper}
binary = ${directory:service}/crond

[cron-simplelogger]
recipe = slapos.cookbook:simplelogger
wrapper = ${directory:bin}/cron_simplelogger
log = ${directory:log}/crond.log

[cron-entry-logrotate]
<= cron
recipe = slapos.cookbook:cron.d
name = logrotate
frequency = 0 0 * * *
command = ${logrotate:wrapper}

[firefox-instance]
recipe = slapos.cookbook:firefox
firefox-path = {{ firefox['location'] }}/firefox-slapos
runner-path = ${directory:bin}/firefox-sandboxed
prefsjs-path = ${directory:etc}/prefs.js
shell-path = {{ dash['location'] }}/bin/dash
tmp-path = ${directory:run}

[xvfb-instance]
recipe = slapos.cookbook:xvfb
xvfb-path = {{ xserver['location'] }}/bin/Xvfb
runner-path = ${directory:service}/xvfb
fbdir-path = ${directory:framebuffer}
tmp-path = ${directory:run}
shell-path = ${dash:location}/bin/dash
xwd-path = {{ xwd['location'] }}/bin/xwd
xwd-hook-path = ${directory:bin}/xwd

[logrotate]
recipe = slapos.cookbook:logrotate
# Binaries
logrotate-binary = {{ logrotate['location'] }}/usr/sbin/logrotate
gzip-binary = {{ gzip['location'] }}/bin/gzip
gunzip-binary = {{ gzip['location'] }}/bin/gunzip
# Directories
wrapper = ${directory:bin}/logrotate
conf = ${directory:etc}/logrotate.conf
logrotate-entries = ${directory:logrotate-entries}
backup = ${directory:logrotate-backup}
state-file = ${directory:srv}/logrotate.status
