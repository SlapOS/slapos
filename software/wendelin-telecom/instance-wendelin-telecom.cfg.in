[buildout]
extends =
  {{ instance_erp5 }}

parts +=
  ors-register

[ors-register]
recipe = slapos.recipe.build
slave-instance-list = {{ dumps(slave_instance_list) }}
site-id = ${publish:site-id}
inituser-login = ${publish:inituser-login}
inituser-password = ${publish-early:inituser-password}
update =
  import json
  import logging
  import requests
  import slapos

  log = logging.getLogger('SLAPOS-WENDELIN-TELECOM')
  logging.basicConfig(level=logging.INFO)

  slap = slapos.slap.slap()
  slap_connection = self.buildout['slap-connection']
  self.computer_id = slap_connection['computer-id']
  self.computer_partition_id = slap_connection['partition-id']
  self.server_url = slap_connection['server-url']
  self.key_file = slap_connection.get('key-file')
  self.cert_file = slap_connection.get('cert-file')
  self.slave_instance_list = list(options['slave-instance-list'])

  # Redeploy instance to update published information
  slap.initializeConnection(self.server_url, self.key_file, self.cert_file)
  computer_partition = slap.registerComputerPartition(self.computer_id, self.computer_partition_id)

  request_balancer = self.buildout['request-balancer']
  zope_family_name_list = ['ingestion', 'web', 'default']
  wendelin_telecom_backend_url = None
  for family_name in zope_family_name_list:
    connection_name = 'connection-%s-v6' % family_name
    if connection_name in request_balancer:
      wendelin_telecom_backend_url = request_balancer[connection_name]
      break
  if not wendelin_telecom_backend_url:
    log.fatal("Wendelin Telecom backend URL not found, cannot register")
  else:
    wendelin_telecom_site_id = options['site-id']
    inituser_login = options['inituser-login']
    inituser_password = options['inituser-password']

    for slave in self.slave_instance_list:
      slave_reference = slave['slave_reference']

      try:
        ors_tag = slave['ors-tag']
      except KeyError as err:
        log.fatal("%s: Parameter %s not found, skipping registration" % (slave_reference, err))
        continue

      request_url = "%s/%s/ERP5Site_registerOrs?ors_tag=%s" % (wendelin_telecom_backend_url, wendelin_telecom_site_id, ors_tag)

      response = requests.get(request_url, verify=False, auth=(inituser_login, inituser_password))
      response = response.json()

      error_msg_key = "error_msg"
      if error_msg_key in response:
        error_msg = response[error_msg_key]
        log.info(error_msg)
      else:
        log.info("ORS successfully registered: %s" % slave_reference)

[publish]
slave-amount = {{ len(slave_instance_list) }}
