[buildout]
extends = ${template:output}

[re6stnet]
<= download-source
repository = ${re6stnet-repository:location}

[re6stnet-test-runner]
recipe = slapos.recipe.template:jinja2
template = inline:#!/bin/sh
  #change #!/usr/bin/python2 -> #!/real_python_path/bin/python2
  sed '1s?/usr/bin/python2?${python2.7:location}/bin/python2?' -i ${re6stnet-repository:location}/re6st/ovpn-*
  # update files in /sys/class/net
  mount -t sysfs sysfs /sys

  python -m unittest discover -v
rendered = $${re6stnet:location}/test-runner.sh

[slapos-test-runner-nxdtest-environment-py2.sh]
<= slapos-test-runner-nxdtest-environment.sh
inline +=
  export PATH=${iptables:location}/sbin:${miniupnpd:location}/usr/sbin:${brctl:location}/sbin:${openvpn:location}/sbin:${babeld:location}/bin:$PATH

[slapos-test-runner-dot-nxdtest-py2]
<= slapos-test-runner-dot-nxdtest
inline +=
  TestCase(
      "re6stnet",
      ['unshare', '-Umnr', '$${re6stnet-test-runner:rendered}'],
      cwd="""$${re6stnet:location}/re6st/tests""",
      summaryf=UnitTest.summary,
  )

[runTestSuite]
env.sh = $${slapos-test-runner-nxdtest-environment-py2.sh:output}
workdir = $${slapos-test-runner-dot-nxdtest-py2:workdir}

[slapos-local-development-environment.sh]
recipe = slapos.recipe.template
output = $${create-directory:etc}/$${:_buildout_section_name_}
inline =
  source $${slapos-test-runner-nxdtest-environment-py2.sh:output}
  echo "Environment loaded."
  echo "To work on a test, execute:"
  echo "   $${runTestSuite:wrapper-path} -k test_name"
  echo "replacing test_name by the name of the test."
  echo
