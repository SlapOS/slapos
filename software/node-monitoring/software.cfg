[buildout]
extends =
# Python components
  ../../component/pandas/buildout.cfg
  ../../component/scipy/buildout.cfg
  ../../component/statsmodels/buildout.cfg
# Generics
  ../../component/defaults.cfg
  ../../stack/monitor/buildout.cfg
  ../../stack/slapos.cfg

parts =
  slapos-cookbook
  instance.cfg

# >>>>>>>>>>>>
[slapos.toolbox-repository]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/Just1/slapos.toolbox
branch = json-promise
git-executable = ${git:location}/bin/git

[slapos-toolbox-dependencies]
eggs +=
  ${pandas:egg}
  ${statsmodels:egg}
  ${scipy:egg}

[slapos-toolbox-dev]
<= slapos-toolbox
recipe = zc.recipe.egg:develop
setup = ${slapos.toolbox-repository:location}

[slapos-toolbox]
prerequisite = ${slapos-toolbox-dev:recipe}
eggs = slapos.toolbox

[versions]
slapos.toolbox =
# <<<<<<<<<<<<

# Build GCC with Fortran for OpenBLAS (scipy & numpy)
[gcc]
max_version = 0

[macro.mkdir]
recipe = slapos.recipe.build
install =
  import os
  os.mkdir(location)
[promise-dir]
<= macro.mkdir
location = ${buildout:directory}/promise

[macro.download.promise]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/promise/${:_buildout_section_name_}
destination = ${promise-dir:location}/${:_buildout_section_name_}

[storage.py]
<= macro.download.promise

[instance.cfg]
recipe = slapos.recipe.template
output = ${buildout:directory}/${:_buildout_section_name_}
requires = ${slapos-toolbox:recipe}
inline =
  [buildout]
  eggs-directory = ${buildout:eggs-directory}
  develop-eggs-directory = ${buildout:develop-eggs-directory}

  extends =
    ${monitor-template:output}

  parts =
    publish
    monitor-base
    check-disk-space.py
    check-partition-space.py
    check-cpu-temperature.py
    check-ram-usage.py
    check-network-errors.py
    check-network-transit.py
    check-cpu-load.py

  [publish]
  <= monitor-publish
  recipe = slapos.cookbook:publish

  [macro.promise]
  <= monitor-promise-base
  name = $${:_buildout_section_name_}

  [check-disk-space.py]
  <= macro.promise
  eggs = slapos.toolbox[prediction]
  promise = check_free_disk_space
  config-collectordb = $${monitor-instance-parameter:collector-db}
  config-threshold =
  config-nb-days-predicted =
  config-display-partition = 1
  config-display-prediction = 1

  [check-partition-space.py]
  <= macro.promise
  eggs = slapos.toolbox[pandas]
  promise = monitor_partition_space
  config-collectordb = $${monitor-instance-parameter:collector-db}
  config-threshold-ratio =

  [check-cpu-temperature.py]
  <= macro.promise
  promise = check_cpu_temperature
  config-testing = false
  config-max-spot-temp = 90
  config-max-avg-temp = 80
  config-avg-temp-duration = 15
  config-last-avg-computation-file = $${directory:var}/promise_cpu_temperature_last_avg_file

  [check-ram-usage.py]
  <= macro.promise
  promise = check_ram_usage
  # config-min-threshold-ram =
  # config-min-avg-ram =
  # config-avg-ram-period-sec =
  # config-avg-ram-period
  config-last-avg-ram-file = $${directory:var}/promise_ram_space_last_avg_file

  [check-network-errors.py]
  <= macro.promise
  promise = check_network_errors_packets
  # config-max-lost-packets =
  # config-max_error_messages =

  [check-network-transit.py]
  <= macro.promise
  promise = check_network_transit
  # config-min-threshold-recv =
  # config-min-threshold-sent =
  # config-transit-period-minutes =
  config-last-transit-file = $${directory:var}/promise_network_last_transit_file

  [check-cpu-load.py]
  <= macro.promise
  promise = check_server_cpu_load
  # config-cpu-load-threshold =


[versions]
statsmodels = 0.11.1
patsy = 0.5.1
