[buildout]
extends =
# Python components
  ../../component/pandas/buildout.cfg
  ../../component/scipy/buildout.cfg
  ../../component/statsmodels/buildout.cfg
# Generics
  ../../component/defaults.cfg
  ../../stack/monitor/buildout.cfg
  ../../stack/slapos.cfg
  buildout.hash.cfg

parts =
  slapos-cookbook
  instance.cfg

# >>>>>>>>>>>>
[slapos.toolbox-repository]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/xavier_thompson/slapos.toolbox.git
branch = json-promise
git-executable = ${git:location}/bin/git

[slapos-toolbox-dev]
<= slapos-toolbox
recipe = zc.recipe.egg:develop
setup = ${slapos.toolbox-repository:location}

[slapos-toolbox]
prerequisite = ${slapos-toolbox-dev:recipe}

[versions]
slapos.toolbox =
# <<<<<<<<<<<<

# Build GCC with Fortran for OpenBLAS (scipy & numpy)
[gcc]
max_version = 0

[macro.mkdir]
recipe = slapos.recipe.build
install =
  import os
  os.mkdir(location)
  
[promise-dir]
<= macro.mkdir
location = ${buildout:directory}/promise

[macro.download.promise]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/promise/${:_buildout_section_name_}
destination = ${promise-dir:location}/${:_buildout_section_name_}

[storage.py]
<= macro.download.promise

[eggs]
recipe = zc.recipe.egg:eggs
eggs =
  ${slapos-toolbox:eggs}
  ${pandas:egg}
  ${scipy:egg}
  ${statsmodels:egg}

[instance.cfg]
recipe = slapos.recipe.template
output = ${buildout:directory}/${:_buildout_section_name_}
inline =
  [buildout]
  eggs-directory = ${buildout:eggs-directory}
  develop-eggs-directory = ${buildout:develop-eggs-directory}

  extends =
    ${monitor-template:output}

  parts =
    publish
    monitor-base
    check-storage.py

  [publish]
  <= monitor-publish
  recipe = slapos.cookbook:publish

  [check-storage.py]
  recipe = slapos.cookbook:promise.plugin
  depends = ${eggs:recipe}
  eggs =
    ${slapos-toolbox:eggs}
    ${pandas:egg}
    ${scipy:egg}
    ${statsmodels:egg}
  file = ${storage.py:destination}
  output = $${directory:plugins}/$${:_buildout_section_name_}
  config-collectordb = $${monitor-instance-parameter:collector-db}
  # config-threshold =
  config-nb-days-predicted = 10
  config-display-prediction = 1
  config-display-partition = 1


[versions]
statsmodels = 0.11.1
patsy = 0.5.1
