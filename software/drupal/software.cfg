[buildout]
extends =
  ../../component/redis/buildout.cfg
  ../../component/nodejs/buildout.cfg
  ../../component/python-2.7/buildout.cfg
  ../../component/pytest/buildout.cfg
  ../../component/java-jdk/buildout.cfg
  ../../stack/lamp/buildout.cfg
  buildout.hash.cfg

parts +=
  composer-setup
  install-drupal

[nodejs]
<= nodejs-8.9.4

[apache-php]
<= apache-php8.1

[python-interpreter]
eggs +=
  ${pytest:eggs}

[drupal-download]
<= template-download-base
url = ${:_profile_base_location_}/${:filename}

[custom-application-deployment]
path = ${template-drupal-instance:output}
part-list = drupal-site-install
db-name = drupal_db
db-user = drupal
#default-frontend = False

[composer]
recipe = slapos.recipe.build:download
url = https://getcomposer.org/installer
filename = composer-setup.php

[composer-php.ini]
# A minimal php.ini that will be used to install druplal
recipe = collective.recipe.template
input =
  inline:[PHP]
  engine = On
  safe_mode = Off
  expose_php = Off
  error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
  display_errors = On
  display_startup_errors = Off
  log_errors = On

  zend_extension=opcache
  extension=apcu
  extension=redis
  extension=imagick
  apc.enabled=1

  [opcache]
  opcache.enable=1
  opcache.enable_cli=1

output = ${composer:location}/php.ini

[composer-setup]
recipe = plone.recipe.command
command =
  INSTAL_DIR=${composer:location}/bin
  PATH=${apache-php:location}/bin:$PATH
  mkdir -p $INSTAL_DIR
  php ${composer:location}/composer-setup.php --install-dir=$INSTAL_DIR --filename=composer
stop-on-error = true
update-command = ${:command}

[composer-bin]
recipe = collective.recipe.template
input = inline:
  #!/bin/sh
  export PATH=${apache-php:location}/bin:$PATH
  php -c ${composer-php.ini:output} ${composer:location}/bin/composer "$@"
output = ${composer:location}/composer
mode = 755

# Download drupal composer
[application]
recipe  = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git
repository = https://lab.nexedi.com/alain.takoudjou/drupal-composer.git
branch = master

[install-drupal]
recipe = slapos.recipe.cmmi
path = ${application:location}
configure-command = true
#  ${composer-bin:output} config vendor-dir docroot/vendor
make-targets =
make-options =
make-binary =
  ${composer-bin:output} install
  ${composer-bin:output} update
environment =
  COMPOSER_HOME=@@LOCATION@@
  PATH=${apache-php:location}/bin:%(PATH)s


[template-drupal-instance]
recipe = slapos.recipe.template:jinja2
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/instance-drupal.cfg
extensions = jinja2.ext.do
context =
          key php_location               apache-php:location
          key mariadb_location           mariadb:location
          key nodejs_location            nodejs:location

[template]
recipe =
context =

[perl-DBD-mariadb]
recipe =
perl-PATH =
