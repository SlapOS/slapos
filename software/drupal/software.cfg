[buildout]
extends =
  ../../component/nodejs/buildout.cfg
  ../../component/python-2.7/buildout.cfg
  ../../component/pytest/buildout.cfg
  ../../stack/lamp/buildout.cfg
  buildout.hash.cfg

parts +=
  composer-setup
  install-drupal

[apache-php]
<= apache-php8.1

[python-interpreter]
eggs +=
  ${pytest:eggs}

[drupal-download]
<= template-download-base
url = ${:_profile_base_location_}/${:filename}

[custom-application-deployment]
path = ${template-drupal-instance:output}
part-list = drupal-site-install
db-name = drupal_db
db-user = drupal

[create-next-app]
recipe = plone.recipe.command
location = ${buildout:parts-directory}/nextjs
command =
  mkdir -p ${:location}
  cd ${:location}
  ${nodejs:location}/bin/npm install create-next-app
stop-on-error = true

[next.js-app]
recipe = plone.recipe.command
location = ${create-next-app:location}/app
command =
  cd ${create-next-app:location}
  ${nodejs:location}/bin/npx create-next-app app --use-npm -e ${:project-url}
stop-on-error = true
project-url = https://github.com/chapter-three/next-drupal-basic-starter

# Download drupal composer
[application]
recipe  = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git
repository = https://lab.nexedi.com/alain.takoudjou/drupal-composer.git
branch = master

[install-drupal]
recipe = slapos.recipe.cmmi
path = ${application:location}
configure-command = true
#  ${composer-bin:output} config vendor-dir docroot/vendor
make-targets =
make-options =
make-binary =
  ${composer-bin:output} install
  ${composer-bin:output} update
  ${composer-bin:output} require drupal/next
post-install =
  mkdir -p drush/config
  cp ${pathauto.pattern.article.yml:target} drush/config/
environment =
  COMPOSER_HOME=@@LOCATION@@
  PATH=${apache-php:location}/bin:%(PATH)s

[template-drupal-instance]
recipe = slapos.recipe.template:jinja2
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/instance-drupal.cfg
extensions = jinja2.ext.do
context =
          key composer_location          composer:location
          key php_location               apache-php:location
          key mariadb_location           mariadb:location
          key nodejs_location            nodejs:location
          key nextjs_app_location        next.js-app:location
          key template_apache_conf       template-drupal-apache.conf:target
          key template_settings_php      template-settings.php:target
          key template_settings_local    template-settings.local.php:target

[template-settings.php]
<= drupal-download

[template-settings.local.php]
<= drupal-download

[template-drupal-apache.conf]
<= drupal-download

[pathauto.pattern.article.yml]
<= template-download-base
url = ${:_profile_base_location_}/config/${:filename}
