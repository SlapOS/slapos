[buildout]
extends =
  https://lab.nexedi.com/nexedi/slapos/raw/netframe/component/redis/buildout.cfg
  https://lab.nexedi.com/nexedi/slapos/raw/netframe/component/nodejs/buildout.cfg
  https://lab.nexedi.com/nexedi/slapos/raw/netframe/component/python-2.7/buildout.cfg
  https://lab.nexedi.com/nexedi/slapos/raw/netframe/component/pytest/buildout.cfg
  https://lab.nexedi.com/nexedi/slapos/raw/netframe/component/java-jdk/buildout.cfg
  /srv/slapgrid/slappart54/srv/project/netframe-slapos/slapos/stack/lamp/buildout.cfg
#  https://lab.nexedi.com/nexedi/slapos/raw/netframe/stack/lamp/buildout.cfg
#  buildout.hash.cfg

parts +=
  composer-setup
  application

[nodejs]
<= nodejs-8.9.4

[apache-php]
<= apache-php8.1

[python-interpreter]
eggs +=
  ${pytest:eggs}

[netframe-download]
<= template-download-base
url = ${:_profile_base_location_}/${:filename}

[custom-application-deployment]
path = ${template-drupal-instance:output}
part-list =
db-name = drupal_db
db-user = drupal
#default-frontend = False

[composer]
recipe = slapos.recipe.build:download
url = https://getcomposer.org/installer
filename = composer-setup.php

[composer-php.ini]
# A minimal php.ini that will be used to install druplal
recipe = collective.recipe.template
input =
  inline:[PHP]
  engine = On
  safe_mode = Off
  expose_php = Off
  error_reporting = E_ALL & ~E_DEPRECATED & ~E_STRICT
  display_errors = On
  display_startup_errors = Off
  log_errors = On

  zend_extension=opcache
  extension=apcu
  extension=redis
  extension=imagick
  apc.enabled=1

  [opcache]
  opcache.enable=1
  opcache.enable_cli=1

output = ${composer:location}/php.ini

[composer-setup]
recipe = plone.recipe.command
command =
  INSTAL_DIR=${composer:location}/bin
  PATH=${apache-php:location}/bin:$PATH
  mkdir -p $INSTAL_DIR
  php ${composer:location}/composer-setup.php --install-dir=$INSTAL_DIR --filename=composer
stop-on-error = true
update-command = ${:command}

[x-application]
recipe = plone.recipe.command
location = ${buildout:parts-directory}/app
command =
  mkdir -p ${:location} &&
  COMPOSER_HOME=${:location} \
  PATH=${apache-php:location}/bin:$PATH \
  ${composer:location}/bin/composer global require laravel/installer -vvv
stop-on-error = true
depends =
  ${composer-setup:recipe}

# Download drupal
[drupal]
recipe  = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git
repository = https://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@github.com/HappySeedIndia/genero.jp.git
branch = d9


[application]
recipe = slapos.recipe.cmmi
path = ${drupal:location}
configure-command = true
make-targets =
make-options =
make-binary =
  php -c ${composer-php.ini:output} ${composer:location}/bin/composer install
# python-2.7 is required to install some nodejs modules
environment =
  PATH=${nodejs:location}/bin:${apache-php:location}/bin:%(PATH)s
depends =
  ${composer-setup:recipe}

[template-drupal-instance]
recipe = slapos.recipe.template:jinja2
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/instance-netframe.cfg
extensions = jinja2.ext.do
context =
          key gzip_location              gzip:location
          key python3_location           python3:location
          key php_location               apache-php:location
          key nodejs_location            nodejs:location
filename = drupal-instance.cfg.in
md5sum = 8db32256b628ae384909d8982923f936


[template-configure-neframe.sh]
<= netframe-download

[template-laravel-echo-server.json]
<= netframe-download

[template-DatabaseSeeder.php.in]
<= netframe-download

[template-netframe-apache.conf]
<= netframe-download

[template]
recipe =
context =

[perl-DBD-mariadb]
recipe =
perl-PATH =
