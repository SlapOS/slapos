[buildout]
extends =
  ${monitor-template:output}

parts =
  service-redis
  promise-redis
  postgresql
  nginx-service
  nginx-listen-promise
  peertube-default-yaml
  peertube-production-yaml
  peertube-service

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[directory]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc
srv = $${buildout:directory}/srv
var = $${buildout:directory}/var
log = $${:var}/log
run = $${:var}/run
www = $${:var}/www
nginx = $${:etc}/nginx
peertube_nginx_log = $${:log}/nginx
varnginx = $${:var}/nginx
services = $${:etc}/service
peertube_directory = $${:www}/peertube
config = $${:peertube_directory}/config
storage = $${:peertube_directory}/storage
versions = $${:peertube_directory}/versions
ssl = $${:etc}/ssl

[peertube-default-yaml]
recipe = slapos.recipe.template
url = ${template-peertube-default:output}
output = $${directory:config}/default.yaml

[peertube-production-yaml]
recipe = slapos.recipe.template
url = ${template-peertube-production:output}
output = $${directory:config}/production.yaml

[peertube-service]
recipe = slapos.recipe.template
url = ${template-peertube-service:output}
output = $${directory:services}/peertube

[postgresql-password]
recipe = slapos.cookbook:generate.password

[postgresql]
recipe = slapos.cookbook:postgres
bin = ${postgresql10:location}/bin/
services = $${directory:services}
dbname  = peertube_prod
superuser = peertube
password = $${postgresql-password:passwd}
pgdata-directory = $${directory:srv}/postgresql

ipv4 = $${instance-parameter:ipv4-random}
# disable listening on ipv6
ipv6 =
port = 5432

[service-postgresql]
recipe  = slapos.cookbook:postgres
bin     = ${postgresql10:location}/bin
services= $${directory:service}

#################################
# Nginx service
#################################
[nginx-service]
recipe = slapos.recipe.template
url = ${template-nginx-service:output}
output = $${directory:services}/nginx
virtual-depends =
  $${nginx-configuration:ip}

[nginx-listen-promise]
<= monitor-promise-base
promise = check_url_available
name = nginx_listen.py
config-host = [$${nginx-configuration:ip}]
config-port = $${nginx-configuration:port}
config-url = https://$${:config-host}:$${:config-port}

[nginx-configuration]
recipe = slapos.recipe.template
url = ${template-nginx-configuration:output}
output = $${directory:etc}/nginx.cfg
access_log = $${directory:log}/nginx-access.log
error_log = $${directory:log}/nginx-error.log
ip = $${instance-parameter:ipv6-random}
port = 9443
ssl_key = $${directory:ssl}/nginx.key
ssl_csr = $${directory:ssl}/nginx.csr
ssl_crt = $${directory:ssl}/nginx.crt

#############
#   Redis   #
#############
[redis]
recipe  = slapos.cookbook:mkdirectory
srv     = $${directory:srv}/redis
log     = $${directory:log}/redis


[service-redis]
recipe  = slapos.cookbook:redis.server
wrapper = $${directory:services}/redis
promise-wrapper = $${directory:bin}/redis-promise

server-dir  = $${redis:srv}
config-file = $${directory:etc}/redis.conf
log-file    = $${redis:log}/redis.log
pid-file    = $${directory:run}/redis.pid
use-passwd  = false
unixsocket  = $${:server-dir}/redis.socket
# port = 0 means "don't listen on TCP at all" - listen only on unix socket
ipv6    = ::1
port    = 0

# server-bin  = ${buildout:parts-directory}/redis/bin/redis-server
server-bin = ${redis28:location}/bin/redis-server
cli-bin  = ${redis28:location}/bin/redis-cli
depend  =
    $${logrotate-entry-redis:recipe}

[promise-redis]
<= monitor-promise-base
promise = check_command_execute
name = promise-redis.py
config-command = $${service-redis:promise-wrapper}

[logrotate-entry-redis]
<= logrotate-entry-base
log     = $${redis:log}/*.log
name = redis

#################################
# SlapOS service
#################################
[instance-parameter]
recipe = slapos.cookbook:slapconfiguration
computer = $${slap-connection:computer-id}
partition = $${slap-connection:partition-id}
url = $${slap-connection:server-url}
key = $${slap-connection:key-file}
cert = $${slap-connection:cert-file}
configuration._ = {}

[publish-connection-parameter]
recipe = slapos.cookbook:publish
# url = $${peertube-instance:url}
