[buildout]
parts =
  publish-connection-parameter

[peertube-instance]
recipe = slapos.cookbook:wrapper
wrapper-path = $${directory:service}/$${:_buildout_section_name_}
command-line = cd $${directory:versions}; cp -r ${peertube-download:location} ./
  echo $${directory:versions}
environment =
  PATH=%(PATH)s

[directory]
recipe = slapos.cookbook:mkdirectory
srv = $${buildout:directory}/srv
peertube_directory = $${:srv}/var/www/peertube
config = $${:srv}/var/www/peertube/config
storage = $${:srv}/var/www/peertube/storage
versions = $${:srv}/var/www/peertube/versions

[postgresql-password]
recipe = slapos.cookbook:generate.password
bytes = 24

[postgresql]
recipe = slapos.cookbook:postgres
bin = ${postgresql10:location}/bin/
services = $${directory:service}
dbname  = peertube_prod
superuser = peertube
password = $${postgresql-password:passwd}
pgdata-directory = $${directory:srv}/postgresql

ipv4 = $${instance-parameter:ipv4-random}
# disable listening on ipv6
ipv6 =
port = 5432

[postgresql-extension]
recipe = slapos.cookbook:wrapper
wrapper-path = $${directory:bin}/$${:_buildout_section_name_}
command-line =
    $${postgresql:bin}/psql -c "CREATE EXTENSION pg_trgm;" $${postgresql:dbname}
    $${postgresql:bin}/psql -c "CREATE EXTENSION unaccent;" $${postgresql:dbname}

[publish-connection-parameter]
recipe = slapos.cookbook:publish
url = $${peertube-instance:url}
