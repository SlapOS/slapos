[buildout]
extends =
  ${monitor-template:output}

parts =
  service-redis
  promise-redis
  postgresql
  postgresql-extension
  peertube-configuration-1
  nginx-service
  nginx-listen-promise

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[directory]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc
srv = $${buildout:directory}/srv
var = $${buildout:directory}/var
log = $${:var}/log
run = $${:var}/run
www = $${:srv}/www
varnginx = $${:var}/nginx
services = $${:etc}/service
peertube_directory = $${:srv}/var/www/peertube
config = $${:var}/www/peertube/config
storage = $${:var}/www/peertube/storage
versions = $${:var}/www/peertube/versions
ssl = $${:etc}/ssl

[peertube-configuration-1]
recipe = slapos.recipe.build
production_config_template = ${peertube:location}/config/production.yaml.example
production_config_prod = $${directory:config}/production.yaml
install =
  import shutil
  shutil.copyfile(options['production_config_template'],  options['production_config_prod'])
  with open(options['production_config_prod'], encoding='UTF-8') as f:
    content = f.read()
    print(content)
    f.close()
# content = content.replace(old_content, new_content)


[peertube-configuration]
recipe = slapos.cookbook:wrapper
wrapper-path = $${directory:services}/$${:_buildout_section_name_}
command-line = echo "Hello!"
  cd ${peertube:location}
  cp ${peertube:location}/config/production.yaml.example ${peertube:location}/config/production.yaml

# Change config/production.yaml

environment =
  PATH=${unzip:location}/bin:${vim:location}/bin:${nodejs:location}/bin:${yarn:location}/bin:${python3:location}/bin:${nginx:location}/sbin:${postgresql:location}/sbin:${gcc-10.2:location}/bin:${redis:location}/bin:{git:location}/bin:{wget:location}/bin:%(PATH)s
  CPPFLAGS=-I${openssl:location}/include
  LDFLAGS=-L${curl:location}/lib -Wl,-rpath -Wl,${openssl:location}/lib -Wl,-rpath -Wl

[postgresql-password]
recipe = slapos.cookbook:generate.password

[postgresql]
recipe = slapos.cookbook:postgres
bin = ${postgresql10:location}/bin/
services = $${directory:services}
dbname  = peertube_prod
superuser = peertube
password = $${postgresql-password:passwd}
pgdata-directory = $${directory:srv}/postgresql

ipv4 = $${instance-parameter:ipv4-random}
# disable listening on ipv6
ipv6 =
port = 5432

[postgresql-extension]
recipe = slapos.cookbook:wrapper
wrapper-path = $${directory:bin}/$${:_buildout_section_name_}
command-line =
    $${postgresql:bin}/psql -c "CREATE EXTENSION pg_trgm;" $${postgresql:dbname}
    $${postgresql:bin}/psql -c "CREATE EXTENSION unaccent;" $${postgresql:dbname}

[service-postgresql]
recipe  = slapos.cookbook:postgres
bin     = {{ postgresql_location }}/bin
services= $${directory:service}

#################################
# Nginx service
#################################
[nginx-service]
recipe = slapos.recipe.template
url = ${template-nginx-service:output}
output = $${directory:services}/nginx
virtual-depends =
  $${nginx-configuration:ip}

[nginx-listen-promise]
<= monitor-promise-base
promise = check_url_available
name = nginx_listen.py
config-host = [$${nginx-configuration:ip}]
config-port = $${nginx-configuration:port}
config-url = https://$${:config-host}/$${:config-port}

[nginx-configuration]
recipe = slapos.recipe.template
url = ${template-nginx-configuration:output}
output = $${directory:etc}/nginx.cfg
access_log = $${directory:log}/nginx-access.log
error_log = $${directory:log}/nginx-error.log
ip = $${instance-parameter:ipv6-random}
port = 9443
ssl_key = $${directory:ssl}/nginx.key
ssl_csr = $${directory:ssl}/nginx.csr
ssl_crt = $${directory:ssl}/nginx.crt

#############
#   Redis   #
#############
[redis]
recipe  = slapos.cookbook:mkdirectory
srv     = $${directory:srv}/redis
log     = $${directory:log}/redis


[service-redis]
recipe  = slapos.cookbook:redis.server
wrapper = $${directory:services}/redis
promise-wrapper = $${directory:bin}/redis-promise

server-dir  = $${redis:srv}
config-file = $${directory:etc}/redis.conf
log-file    = $${redis:log}/redis.log
pid-file    = $${directory:run}/redis.pid
use-passwd  = false
unixsocket  = $${:server-dir}/redis.socket
# port = 0 means "don't listen on TCP at all" - listen only on unix socket
ipv6    = ::1
port    = 0

server-bin  = {{ redis_binprefix }}/redis-server
cli-bin  = {{ redis_binprefix }}/redis-cli
depend  =
    $${logrotate-entry-redis:recipe}

[promise-redis]
<= monitor-promise-base
promise = check_command_execute
name = promise-redis.py
config-command = $${service-redis:promise-wrapper}

[logrotate-entry-redis]
<= logrotate-entry-base
log     = $${redis:log}/*.log
name = redis

#################################
# SlapOS service
#################################
[instance-parameter]
recipe = slapos.cookbook:slapconfiguration
computer = $${slap-connection:computer-id}
partition = $${slap-connection:partition-id}
url = $${slap-connection:server-url}
key = $${slap-connection:key-file}
cert = $${slap-connection:cert-file}
configuration._ = {}

[publish-connection-parameter]
recipe = slapos.cookbook:publish
# url = $${peertube-instance:url}
