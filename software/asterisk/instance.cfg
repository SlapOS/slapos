[buildout]
parts =
  asterisk-service
  asterisk-promise
  publish-connection-parameter
  pjsip.conf
  modules.conf
  pjproject.conf

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true
extends = ${monitor2-template:output}

[directory]
recipe = slapos.cookbook:mkdirectory
home = $${buildout:directory}
etc = $${:home}/etc/
etc_asterisk = $${:home}/etc/asterisk
var = $${:home}/var/
lib_asterisk = $${:var}/lib/asterisk
spool_asterisk =$${:var}/spool/asterisk
run = $${:var}/run/
bin = $${:home}/bin/
services = $${:etc}/service/

[instance-parameter]
recipe = slapos.cookbook:slapconfiguration
computer = $${slap-connection:computer-id}
partition = $${slap-connection:partition-id}
url = $${slap-connection:server-url}
key = $${slap-connection:key-file}
cert = $${slap-connection:cert-file}

[user-info]
recipe = slapos.cookbook:userinfo

[slap-configuration]
<= slap-connection
recipe = slapos.cookbook:slapconfiguration.jsonschema
jsonschema = ${software.json:target}
set-default = main
validate-parameters = main
unstringify = none

[slap-network-information]
local-ipv4 = $${slap-configuration:ipv4-random}
global-ipv6 = $${slap-configuration:ipv6-random}

[bind-ip-parameter]
recipe = slapos.recipe.build
slapparameter-dict = $${slap-configuration:configuration}
home = $${buildout:directory}
init =
  import json
  user_parameters = options.get('slapparameter-dict')
  # Default value if no bind IP is specified
  options['bind-ip'] = user_parameters.get('bind-ip', '$${slap-network-information:local-ipv4}')

[publish-connection-parameter]
recipe = slapos.cookbook:publish
asterisk-ip = $${slap-network-information:global-ipv6}:$${asterisk-port:port}

# Deploy asterisk
[asterisk-port]
recipe = slapos.cookbook:free_port
minimum = 2222
maximum = 2232
ip = $${instance-parameter:ipv6-random}

[asterisk.conf]
recipe = slapos.recipe.template
output = $${directory:etc_asterisk}/asterisk.conf
inline =
  [directories]
  astcachedir => /tmp
  astetcdir => $${directory:etc_asterisk}
  astmoddir => ${asterisk:location}/lib/asterisk/modules
  astvarlibdir => $${directory:home}/var/lib/asterisk
  astdbdir => $${directory:home}/var/lib/asterisk
  astkeydir => $${directory:home}/var/lib/asterisk
  astdatadir => $${directory:home}/var/lib/asterisk
  astagidir => $${directory:home}/var/lib/asterisk/agi-bin
  astspooldir => $${directory:home}/var/spool/asterisk
  astrundir => $${directory:home}/var/run/asterisk
  astlogdir => $${directory:home}/var/log/asterisk
  astsbindir => ${asterisk:location}/sbin

[modules.conf]
recipe = slapos.recipe.template
output = $${directory:etc_asterisk}/modules.conf
inline =
  [modules]
  load = res_sorcery_config
  load = res_sorcery_memory
  load = res_sorcery_astdb
  load = res_pjproject
  load = res_pjsip
  load = res_pjsip_session
  load = res_pjsip_pubsub
  load = chan_pjsip
  load = res_pjsip_outbound_registration

[pjproject.conf]
recipe = slapos.recipe.template
output = $${directory:etc_asterisk}/pjproject.conf
inline =
  [startup]
  log_level	= 5

[pjsip.conf]
recipe = slapos.recipe.template:jinja2
output = $${directory:etc_asterisk}/pjsip.conf
context =
  key slapparameter_dict slap-configuration:configuration
inline =
  [transport-udp]
  type=transport
  protocol=udp
  bind=$${bind-ip-parameter:bind-ip}
  [transport-tcp]
  type=transport
  protocol=tcp
  bind=$${bind-ip-parameter:bind-ip}
  tcp_keepalive_enable=yes        ; Enable TCP keepalive (yes/no)
  tcp_keepalive_idle_time=30      ; Time in seconds the connection needs to remain idle before TCP starts sending keepalive probes
  tcp_keepalive_interval_time=10  ; The time in seconds between individual keepalive probes
  tcp_keepalive_probe_count=5     ; The maximum number of keepalive probes TCP should send before dropping the connection
  [amarisoft]
  type=endpoint
  context=call-ovh
  disallow=all
  allow=amrwb
  transport=transport-tcp
  aors=amarisoft
  force_rport=yes
  direct_media=no
  ice_support=yes
  [amarisoft]
  type=aor
  contact=sip:01274@172.24.64.1
  [amarisoft]
  type=identify
  endpoint=amarisoft
  match=172.24.0.0/16
  [ovh-reg]
  type=registration
  transport=transport-udp
  outbound_auth=ovh_auth
  server_uri=sip:{{slapparameter_dict['sip-trunk-server']}}
  client_uri=sip:{{slapparameter_dict['sip-trunk-number']}}@{{slapparameter_dict['sip-trunk-server']}}
  contact_user={{slapparameter_dict['sip-trunk-number']}}
  retry_interval=60
  forbidden_retry_interval=600
  expiration=3600
  line=yes
  endpoint=ovh
  [ovh]
  type=endpoint
  context=call-amarisoft
  disallow=all
  allow=ulaw
  allow=alaw
  transport=transport-udp
  outbound_auth=ovh_auth
  aors=0033972100409
  from_user=0033972100409
  [ovh_auth]
  type=auth
  auth_type=userpass
  username=0033972100409
  password=Z34ny98KSMJYmLJCApQM
  realm=sbc6.fr.sip.ovh
  [ovh]
  type=identify
  endpoint=ovh
  match=sbc6.fr.sip.ovh
  [0033972100409]
  type=aor
  contact=sip:0033972100409@sbc6.fr.sip.ovh
  max_contacts=1

[asterisk-service]
recipe = slapos.cookbook:wrapper
command-line = ${asterisk:location}/sbin/asterisk -fvC $${asterisk.conf:output}
hash-existing-files = $${buildout:directory}/buildout.cfg
wrapper-path = $${directory:services}/asterisk
environment =
  HOME=$${directory:home}


[asterisk-promise]
<= monitor-promise-base
promise = check_socket_listening
name = asterisk.py
config-host = $${slap-network-information:global-ipv6}
config-port = $${asterisk-port:port}
