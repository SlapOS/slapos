#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Auto-generated by slapos.recipe.template:jinja2 from huggingface-cli-download.py.in

Inputs (via Jinja):
- hfc_bin:    absolute path to 'huggingface-cli'
- models_dir: directory to place downloaded files
- cache_dir:  HF cache directory (also provided via env HF_HOME)
- log_file:   path to append-only log file
- state_file: path to state file (empty => success, non-empty => error/pending)
- repo_id:    huggingface repository id (e.g. 'unsloth/Seed-OSS-36B-Instruct-GGUF')
- filename:   target filename under models_dir (e.g. 'Seed-OSS-36B-Instruct-IQ4_NL.gguf')
"""

import os
import sys
import time
import tempfile
import subprocess

HFC_BIN    = "{{ hfc_bin }}"
MODELS_DIR = "{{ models_dir }}"
CACHE_DIR  = "{{ cache_dir }}"
LOG_FILE   = "{{ log_file }}"
STATE_FILE = "{{ state_file }}"
REPO_ID    = "{{ repo_id }}"
FILENAME   = "{{ filename }}"

ATTEMPTS = 3
RETRY_DELAY_SEC = 10

def _ensure_parent(p: str) -> None:
    d = os.path.dirname(os.path.abspath(p))
    if d:
        os.makedirs(d, exist_ok=True)

def _log(msg: str) -> None:
    _ensure_parent(LOG_FILE)
    ts = time.strftime("%Y-%m-%d %H:%M:%S")
    with open(LOG_FILE, "a", buffering=1) as f:
        f.write(f"[{ts}] {msg}\n")

def _write_state_empty(path: str) -> None:
    _ensure_parent(path)
    fd, tmp = tempfile.mkstemp(prefix=".ok", dir=os.path.dirname(path))
    os.close(fd)
    os.replace(tmp, path)

def _write_state_error(path: str, text: str) -> None:
    _ensure_parent(path)
    with open(path, "w") as f:
        f.write(text)

def main() -> int:
    # Prepare dirs
    os.makedirs(MODELS_DIR, exist_ok=True)
    os.makedirs(CACHE_DIR,  exist_ok=True)

    target = os.path.join(MODELS_DIR, FILENAME)

    if os.path.exists(target) and os.path.getsize(target) > 0:
        try:
            if not os.path.exists(STATE_FILE) or os.path.getsize(STATE_FILE) != 0:
                _write_state_empty(STATE_FILE)
        except Exception as e:
            _write_state_error(STATE_FILE, f"ERR: cannot mark success: {e}")
            _log(f"mark success failed: {e}")
            return 1
        _log(f"skip: already present {FILENAME}")
        return 0
    else:
        _write_state_error(STATE_FILE, f"PENDING: downloading {REPO_ID}:{FILENAME}")

    env = os.environ.copy()
    env.setdefault("HF_HOME", CACHE_DIR)

    last_rc = 1
    for i in range(1, ATTEMPTS + 1):
        _log(f"start download (try {i}/{ATTEMPTS}): repo={REPO_ID} file={FILENAME}")
        cmd = [HFC_BIN, "download", REPO_ID, FILENAME, "--local-dir", MODELS_DIR]
        # Stream output to LOG_FILE
        with open(LOG_FILE, "a") as lf:
            proc = subprocess.Popen(cmd, stdout=lf, stderr=subprocess.STDOUT, env=env)
            rc = proc.wait()
        last_rc = rc

        if rc == 0 and os.path.exists(target) and os.path.getsize(target) > 0:
            try:
                _write_state_empty(STATE_FILE)  # empty => success
            except Exception as e:
                _write_state_error(STATE_FILE, f"ERR: cannot mark success: {e}")
                _log(f"mark success failed: {e}")
                return 1
            _log(f"done: {REPO_ID}:{FILENAME}")
            return 0

        _write_state_error(STATE_FILE, f"ERR: huggingface-cli exit={rc}")
        _log(f"failed exit={rc}")
        time.sleep(RETRY_DELAY_SEC)

    return last_rc

if __name__ == "__main__":
    sys.exit(main())
