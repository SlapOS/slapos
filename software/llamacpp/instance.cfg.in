[buildout]
eggs-directory = {{ buildout['eggs-directory'] }}
develop-eggs-directory = {{ buildout['develop-eggs-directory'] }}

extends =
  {{ monitor_template_cfg }}

parts =
  directory
  llamacpp
  request-parameters

[directory]
recipe = slapos.cookbook:mkdirectory
home = ${buildout:directory}
bin = ${:home}/bin
var = ${:home}/var
log = ${:var}/log
run = ${:var}/run
cache = ${:var}/hf-cache

[slap-configuration]
<= slap-connection
recipe = slapos.cookbook:slapconfiguration.jsonschema
jsonschema = ${software.json:target}
set-default = main
validate-parameters = main

[llamacpp]
recipe = slapos.cookbook:wrapper
command-line = {{ LLAMA_SERVER_BIN }} \
  -hf ${slap-configuration:configuration-hf_repo_id}:${slap-configuration:configuration-hf_filename} \
  --host ${slap-configuration:configuration-host} --port ${slap-configuration:configuration-port} \
  --ngl ${slap-configuration:configuration-ngl} -t ${slap-configuration:configuration-threads} -c ${slap-configuration:configuration-ctx}
wrapper-path = ${directories:bin}/service-llama
environment =
  LD_LIBRARY_PATH=/usr/local/cuda/lib64:%(LD_LIBRARY_PATH)s
  HF_HOME=${directories:cache}
  HUGGING_FACE_HUB_TOKEN=${slap-configuration:configuration-hf_token}

[request-parameters]
recipe = slapos.cookbook:publish
url = http://${slap-configuration:configuration-host}:${slap-configuration:configuration-port}/
binary = {{ LLAMA_SERVER_BIN }}
model = ${slap-configuration:configuration-hf_repo_id}:${slap-configuration:configuration-hf_filename}
ctx = ${slap-configuration:configuration-ctx}
ngl = ${slap-configuration:configuration-ngl}
