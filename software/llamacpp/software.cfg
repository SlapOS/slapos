[buildout]
extends =
  buildout.hash.cfg
  ../../stack/slapos.cfg
  ../../stack/monitor/buildout.cfg
  ../../component/huggingface_hub/buildout.cfg
  ../../component/cmake/buildout.cfg
  ../../component/curl/buildout.cfg
  ../../component/git/buildout.cfg
  ../../component/golang/buildout.cfg
  ../../component/gcc/buildout.cfg
  ../../component/huggingface_hub/buildout.cfg
  ../../component/nginx/buildout.cfg

parts =
  cmake
  curl
  git
  gcc-12.3
  huggingface-hub
  software.json
  instance-input.json
  instance-default
  llama-source
  instance.cfg
  slapos-cookbook

[llama-source]
recipe = slapos.recipe.build:gitclone
repository = https://github.com/ggerganov/llama.cpp.git
branch = master
git-clone-depth = 1
location = ${buildout:parts-directory}/llama.cpp
revision = 043fb27d3808766d8ea8195bbd12359727264402

[directory]
recipe = slapos.recipe.build:mkdirectory
json-schema = ${buildout:directory}/json-schema

[download-base]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:filename}

[download-json-base]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:filename}
destination = ${directory:json-schema}/${:filename}

[template-base]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:filename}

[software.json]
<= download-json-base

[instance-input.json]
<= download-json-base

[instance-default]
<= template-base
output = ${buildout:directory}/instance-default.cfg.jinja

[instance.cfg]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/instance.cfg.in
output = ${buildout:directory}/instance.cfg
