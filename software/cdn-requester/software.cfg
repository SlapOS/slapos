[buildout]
extends =
  buildout.hash.cfg
  ../../stack/slapos.cfg
  ../../component/openssl/buildout.cfg
  ../../component/coreutils/buildout.cfg

parts +=
  slapos-cookbook
  instance.cfg.in
  software-install

#allow-picked-versions = true

[software-prepare]
recipe = plone.recipe.command
stop-on-error = True
location = ${buildout:parts-directory}/${:_buildout_section_name_}
command =
  rm -fr ${:location} &&
  mkdir -p ${:location} &&
  cp ${setup.py:target} ${:location}/ &&
  cp ${software.py:target} ${:location}/

[software-develop]
recipe = zc.recipe.egg:develop
setup = ${software-prepare:location}

[software-install]
depends = ${software-develop:recipe}
recipe = zc.recipe.egg
eggs =
  software

[instance-common.cfg.in]
<= copy-to-instance
recipe = slapos.recipe.template:jinja2
output = ${buildout:directory}/instance-common.cfg
context =
  key develop_eggs_directory buildout:develop-eggs-directory
  key eggs_directory buildout:eggs-directory

[instance.cfg.in]
<= copy-to-instance
recipe = slapos.recipe.template:jinja2
output = ${buildout:directory}/template.cfg
context =
  section software_parameter_dict software-parameter-section

[software-parameter-section]
# profiles
instance-master.cfg.in = ${instance-master.cfg.in:target}
instance-common.cfg.in = ${instance-common.cfg.in:output}
instance-requester-input-schema.json = ${instance-requester-input-schema.json:target}
instance-requester-output-schema.json = ${instance-requester-output-schema.json:target}
instance-slave-input-schema.json = ${instance-slave-input-schema.json:target}
instance-slave-output-schema.json = ${instance-slave-output-schema.json:target}
software.cfg.json = ${software.cfg.json:target}

[copy-to-instance]
recipe   = slapos.recipe.build:download
url      = ${:_profile_base_location_}/${:_buildout_section_name_}
filename = ${:_buildout_section_name_}
_update_hash_filename_ = ${:_buildout_section_name_}

[copy-at-root]
<= copy-to-instance
destination = ${buildout:directory}/${:_buildout_section_name_}

[instance.cfg.in]
<= copy-at-root

[instance-common.cfg.in]
<= copy-at-root

[instance-master.cfg.in]
<= copy-at-root

[setup.py]
<= copy-to-instance

[software.py]
<= copy-to-instance

[instance-requester-input-schema.json]
<= copy-at-root

[instance-requester-output-schema.json]
<= copy-at-root

[instance-slave-input-schema.json]
<= copy-at-root

[instance-slave-output-schema.json]
<= copy-at-root

[software.cfg.json]
<= copy-at-root

[versions]
furl = 2.1.4
validators = 0.35.0
orderedmultidict = 1.0.1