[buildout]
extends = 
  {{ software_parameter_dict['instance-common.cfg.in'] }}
  {{ software_parameter_dict['template_monitor'] }}

parts =
  slap-configuration
  cdn-request-cron



[software-parameter-section]
{%- for key,value in software_parameter_dict.items() %}
{{ key }} = {{ dumps(value) }}
{%- endfor %}



[slap-configuration]
# Fetches parameters defined in SlapOS Master for this instance.
# Always the same.
recipe = slapos.cookbook:slapconfiguration.jsonschema.localdb
jsonschema = {{ software_parameter_dict['software.cfg.json'] }}
depends = 
  {{ software_parameter_dict['instance-requester-input-schema.json'] }}
  {{ software_parameter_dict['instance-slave-input-schema.json'] }}
set-default = main
validate-parameters = all
instance-db-path = ${buildout:directory}/slapconfiguration-shared-instance.sqlite
computer = ${slap-connection:computer-id}
partition = ${slap-connection:partition-id}
url = ${slap-connection:server-url}
key = ${slap-connection:key-file}
cert = ${slap-connection:cert-file}

[cdn-request]
recipe = slapos.recipe.template
url = {{ software_parameter_dict['instancenode.cfg.in'] }}
output = ${buildout:directory}/instancenode.cfg

[cdn-request-cron]
recipe = slapos.cookbook:cron.d
cron-entries = ${cron:cron-entries}
name = cdn-request
frequency = */2 * * * *
command = {{ software_parameter_dict['cdnrequest-bin'] }} --cfg ${cdn-request:output} --pidfile ${buildout:directory}/cdn-request.pid