[buildout]
extends = 
  {{ software_parameter_dict['instance-common.cfg.in'] }}
  {{ software_parameter_dict['template_monitor'] }}

parts =
  slap-configuration
  cdn-request-cron
  logrotate-entry-cdn-requester


[software-parameter-section]
{%- for key,value in software_parameter_dict.items() %}
{{ key }} = {{ dumps(value) }}
{%- endfor %}

[cdn-requester-configuration]
cdn-requester-log = ${directory:log}/cdn-request.log
instance-db-path = ${slap-configuration:instance-db-path}
requestinstance-db-path = ${directory:srv}/requestinstance-db.sqlite
domainvalidation-db-path = ${directory:srv}/domainvalidation-db.sqlite


[slap-configuration]
# Fetches parameters defined in SlapOS Master for this instance.
# Always the same.
recipe = slapos.cookbook:slapconfiguration.jsonschema.localdb
jsonschema = {{ software_parameter_dict['software.cfg.json'] }}
depends = 
  {{ software_parameter_dict['instance-requester-input-schema.json'] }}
  {{ software_parameter_dict['instance-slave-input-schema.json'] }}
set-default = main
validate-parameters = all
instance-db-path = ${directory:srv}/slapconfiguration-shared-instance.sqlite
computer = ${slap-connection:computer-id}
partition = ${slap-connection:partition-id}
url = ${slap-connection:server-url}
key = ${slap-connection:key-file}
cert = ${slap-connection:cert-file}

[cdn-request]
recipe = slapos.recipe.template
url = {{ software_parameter_dict['instancenode.cfg.in'] }}
output = ${directory:etc}/instancenode.cfg

[cdn-request-cron]
recipe = slapos.cookbook:cron.d
cron-entries = ${cron:cron-entries}
name = cdn-request
frequency = */2 * * * *
command = {{ software_parameter_dict['cdnrequest-bin'] }} --cfg ${cdn-request:output} --pidfile ${buildout:directory}/cdn-request.pid --logfile ${cdn-requester-configuration:cdn-requester-log}

[logrotate-entry-cdn-requester]
<= logrotate-entry-base
name = cdn-request
log = ${cdn-requester-configuration:cdn-requester-log}
