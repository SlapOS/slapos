{#- SlapOS Master (but not slapproxy!) merges slave's instance and connection parameters, so the slave information passed to nodes have to be limited only to instance related keys #}
{#- Note: As a result, this feature is very hard to be tested with slapproxy, as it does not pollute the slave information, this kind of whitelist is implemented #}
{%- set FRONTEND_NODE_SLAVE_PASSED_KEY_LIST_SCHEMA = [
      'authenticate-to-backend',
      'backend-connect-retries',
      'backend-connect-timeout',
      'ciphers',
      'custom_domain',
      'default-path',
      'disable-no-cache-request',
      'disable-via-header',
      'disabled-cookie-list',
      'enable-http2',
      'enable-http3',
      'enable_cache',
      'health-check',
      'health-check-authenticate-to-failover-backend',
      'health-check-failover-https-url',
      'health-check-failover-https-url-netloc-list',
      'health-check-failover-ssl-proxy-ca-crt',
      'health-check-failover-ssl-proxy-verify',
      'health-check-failover-url',
      'health-check-failover-url-netloc-list',
      'health-check-fall',
      'health-check-http-method',
      'health-check-http-path',
      'health-check-interval',
      'health-check-rise',
      'health-check-timeout',
      'https-only',
      'https-url',
      'https-url-netloc-list',
      'path',
      'prefer-gzip-encoding-to-backend',
      'request-timeout',
      'server-alias',
      'ssl-proxy-verify',
      'ssl_ca_crt',
      'ssl_crt',
      'ssl_key',
      'ssl_proxy_ca_crt',
      'strict-transport-security',
      'strict-transport-security-preload',
      'strict-transport-security-sub-domains',
      'type',
      'url',
      'url-netloc-list',
      'virtualhostroot-http-port',
      'virtualhostroot-https-port',
      'websocket-path-list',
      'websocket-transparent',
    ]
%}
{%- set FRONTEND_NODE_SLAVE_PASSED_KEY_LIST_INTERNAL = [
      'slave_reference',
    ]
%}
{%- set FRONTEND_NODE_SLAVE_PASSED_KEY_LIST = FRONTEND_NODE_SLAVE_PASSED_KEY_LIST_SCHEMA + FRONTEND_NODE_SLAVE_PASSED_KEY_LIST_INTERNAL %}
[jinja2-template-base]
recipe = slapos.recipe.template:jinja2
output = ${buildout:directory}/${:filename}
extra-context =
context =
    import json_module json
    raw profile_common {{ software_parameter_dict['profile_common'] }}
    ${:extra-context}

{%- set popen = functools_module.partial(subprocess_module.Popen, stdout=subprocess_module.PIPE, stderr=subprocess_module.STDOUT, stdin=subprocess_module.PIPE) %}
{%- set part_list = [] %}
{%- set single_type_key = 'single-' %}
{%- set slave_list_name = 'extra_slave_instance_list' %}
{%- set frontend_section_list = [] %}
{%- set NODE_DEFAULT_KEY_VALUE = {
  'enable-http3': 'false',
  'http3-port': '443'
} %}

{%- set authorized_slave_string_list = [] %}
{%- set authorized_slave_list = [] %}
{%- set rejected_slave_dict = {} %}
{%- set critical_rejected_slave_dict = {} %}
{%- set warning_slave_dict = {} %}
{%- set used_host_list = [] %}
{%- for slave in sorted(instance_parameter_dict['slave-instance-list'], key=operator_module.itemgetter('slave_reference')) %}
{%-   set slave_error_list = [] %}
{%-   set slave_critical_error_list = [] %}
{%-   set slave_warning_list = [] %}
{%-   set slave_server_alias_unclashed = [] %}
{%-   set slave_type = slave.get('type') %}
{%-   if slave_type not in [None, '', 'default', 'zope', 'redirect', 'notebook', 'websocket'] %}
{%-     do slave_error_list.append('type:%s is not supported' % (slave_type,)) %}
{%-   endif %}
{#-   Check health-check-* #}
{%-   set health_check = (str(slave.get('health-check', False)) or 'false').lower() %}
{#-   Check virtualhostroot-http-port and virtualhostroot-https-port #}
{%-   for key in ['virtualhostroot-http-port', 'virtualhostroot-https-port'] %}
{%-     set value = (slave.get(key) or '1') | int(false) %}
{%-     if value is false or value < 0 %}
{%-       do slave_error_list.append('Wrong %s %r' % (key, slave.get(key))) %}
{%-     endif %}
{%-   endfor %}
{#-   Check ciphers #}
{%-   set slave_cipher_list = slave.get('ciphers', '').strip().split() %}
{%-   if slave_cipher_list %}
{%-     for cipher in slave_cipher_list %}
{%-       if cipher not in GOOD_CIPHER_LIST %}
{%-         if cipher in CIPHER_TRANSLATION_DICT %}
{#-           Real translation happens in instance-slave-list.cfg.in #}
{%-           do slave_warning_list.append('Cipher %r translated to %r' % (cipher, CIPHER_TRANSLATION_DICT[cipher])) %}
{%-         else %}
{%-           do slave_error_list.append('Cipher %r is not supported.' % (cipher,)) %}
{%-         endif %}
{%-       endif %}
{%-     endfor %}
{%-   endif %}
{#-   Check strict-transport-security #}
{%-     set strict_transport_security = (slave.get('strict-transport-security') or '0') | int(false) %}
{%-     if strict_transport_security is false or strict_transport_security < 0 %}
{%-       do slave_error_list.append('Wrong strict-transport-security %s' % (slave.get('strict-transport-security'),)) %}
{%-     endif %}
{%-   set custom_domain = slave.get('custom_domain') %}
{%-   if custom_domain and custom_domain in used_host_list %}
{%-      set message = 'custom_domain %r clashes' % (custom_domain,) %}
{%-      do slave_error_list.append(message) %}
{%-      do slave_critical_error_list.append(message) %}
{%-   else %}
{%-      do used_host_list.append(custom_domain) %}
{%-   endif %}
{%-   if slave.get('server-alias') %}
{%-     for slave_alias in ('' ~ slave['server-alias']).split() %}
{%-       if slave_alias.startswith('*.') %}
{%-         set clean_slave_alias = slave_alias[2:] %}
{%-       else %}
{%-         set clean_slave_alias = slave_alias %}
{%-       endif %}
{%-       if not validators.domain(clean_slave_alias) %}
{%-         do slave_error_list.append('server-alias \'%s\' not valid' % (slave_alias,)) %}
{%-       else %}
{%-         if slave_alias in slave_server_alias_unclashed or slave_alias == custom_domain %}
{#-           optionally do something about reporting back that server-alias has been unclashed #}
{%-         elif slave_alias in used_host_list %}
{%-           set message = 'server-alias \'%s\' clashes' % (slave_alias,) %}
{%-           do slave_error_list.append(message) %}
{%-           do slave_critical_error_list.append(message) %}
{%-         else %}
{%-           do slave_server_alias_unclashed.append(slave_alias) %}
{%-           do used_host_list.append(slave_alias) %}
{%-         endif %}
{%-       endif %}
{%-     endfor %}
{%-     do slave.__setitem__('server-alias', ' '.join(slave_server_alias_unclashed)) %}
{%-   endif %}
{%-   for url_key in ['url', 'https-url', 'health-check-failover-url', 'health-check-failover-https-url'] %}
{%-     if url_key in slave %}
{%-       set url = (slave[url_key] or '').strip() %}
{%-       if not validators.url(url) %}
{%-         do slave_error_list.append('slave %s %r invalid' % (url_key, url)) %}
{%-       elif url != slave[url_key] %}
{%-         do slave_warning_list.append('slave %s %r has been converted to %r' % (url_key, slave[url_key], url)) %}
{%-       endif %}
{%-     endif %}
{%-   endfor %}
{%-   for url_key in ['url-netloc-list', 'https-url-netloc-list', 'health-check-failover-url-netloc-list'] %}
{%-     if url_key in slave %}
{%-       for netloc in slave[url_key].split() %}
{%-         if not software.validate_netloc(netloc) %}
{%-           do slave_error_list.append('slave %s %r invalid' % (url_key, netloc)) %}
{%-         endif %}
{%-       endfor %}
{%-     endif %}
{%-   endfor %}
{%-   for k in ['ssl_proxy_ca_crt', 'health-check-failover-ssl-proxy-ca-crt'] %}
{%-     if k in slave %}
{#-       Be very cautious -- some master implementations are returning None for empty strings #}
{#-       Thus get can return None so convert it to a string #}
{%-       set crt = slave.get(k, '') or '' %}
{%-       set check_popen = popen([software_parameter_dict['openssl'], 'x509', '-noout']) %}
{%-       do check_popen.communicate(crt.encode()) %}
{%-       if check_popen.returncode != 0 %}
{%-         do slave_error_list.append('%s is invalid' % (k,)) %}
{%-       endif %}
{%-     endif %}
{%-   endfor %}
{#- BBB: SlapOS Master non-zero knowledge BEGIN #}
{%-   for key in ['ssl_key', 'ssl_crt', 'ssl_ca_crt'] %}
{%-     if key in slave %}
{%-       do slave_warning_list.append('%s is obsolete, please use key-upload-url' % (key,)) %}
{%-     endif %}
{%-   endfor %}
{%-   if slave.get('ssl_ca_crt') and not (slave.get('ssl_crt') and slave.get('ssl_key')) %}
{%-     do slave_error_list.append('ssl_ca_crt is present, so ssl_crt and ssl_key are required')  %}
{%-   endif %}
{%-   if slave.get('ssl_key') and slave.get('ssl_crt') %}
{%-     set key_popen = popen([software_parameter_dict['openssl'], 'rsa', '-noout', '-modulus']) %}
{%-     set crt_popen = popen([software_parameter_dict['openssl'], 'x509', '-noout', '-modulus']) %}
{%-     set key_modulus = key_popen.communicate(slave['ssl_key'].encode())[0] | trim %}
{%-     set crt_modulus = crt_popen.communicate(slave['ssl_crt'].encode())[0] | trim %}
{%-     if not key_modulus or key_modulus != crt_modulus  %}
{%-       do slave_error_list.append('slave ssl_key and ssl_crt does not match')  %}
{%-     endif %}
{%-   endif %}
{#- BBB: SlapOS Master non-zero knowledge END #}
{%-   if slave.get('custom_domain') %}
{%-     set slave_custom_domain = '' ~ slave['custom_domain'] %}
{%-     if slave_custom_domain.startswith('*.') %}
{%-       set clean_custom_domain = slave_custom_domain[2:] %}
{%-     else %}
{%-       set clean_custom_domain = slave_custom_domain %}
{%-     endif %}
{%-     if not validators.domain(clean_custom_domain) %}
{%-       do slave_error_list.append('custom_domain %r invalid' % (slave['custom_domain'],)) %}
{%-     endif %}
{%-   endif %}
{%-   if len(slave_error_list) == 0 %}
{#-   Cleanup slave from not needed keys which come from implementation of SlapOS Master #}
{#-   Send only controlled information about the slave to node #}
{%-     set authorized_slave = {} %}
{%-     for key in FRONTEND_NODE_SLAVE_PASSED_KEY_LIST + FRONTEND_NODE_SLAVE_PASSED_KEY_LIST %}
{%-       if key in slave %}
{%-         do authorized_slave.__setitem__(key, slave[key]) %}
{%-       endif %}
{%-     endfor %}
{%-     do authorized_slave_list.append(authorized_slave) %}
{%-   else %}
{%-     do rejected_slave_dict.__setitem__(slave.get('slave_reference'), sorted(slave_error_list)) %}
{%-   endif %}
{%-   if len(slave_critical_error_list) > 0 %}
{%-     do critical_rejected_slave_dict.__setitem__(slave.get('slave_reference'), sorted(slave_critical_error_list)) %}
{%-   endif %}
{%-   if len(slave_warning_list) > 0 %}
{%-     do warning_slave_dict.__setitem__(slave.get('slave_reference'), sorted(slave_warning_list)) %}
{%-   endif %}
{%- endfor %}
{%- do authorized_slave_list.sort(key=operator_module.itemgetter('slave_reference')) %}

[request-shared-instance-base]
<= slap-connection
recipe = slapos.cookbook:requestoptional
software-type = {{ slapparameter_dict.get('cdn-software-type', "default") }}
software-url = {{ slapparameter_dict.get('cdn-software-url', "http://git.erp5.org/gitweb/slapos.git/blob_plain/HEAD:/software/apache-frontend/software.cfg")  }}
return = domain key-generate-auth-url key-upload-url log-access-url replication_number secure_access site_url url request-error-list warning-list kedifa-caucase-url backend-client-caucase-url
{%- set sla_key = "-sla-" %}
{%- set sla_key_length = sla_key | length %}
{%- for key in list(slapparameter_dict.keys()) %}
{%-   if key.startswith(sla_key) %}
sla-{{ key[sla_key_length:] }} = {{ slapparameter_dict.pop(key) }}
{%-   endif %}
{%- endfor %}

{%-  set warning_list = [] %}
{%- set requested_shared_instance_list = [] %}
{% for shared_instance_parameters in authorized_slave_list %}
{%- set request_section_name = "cdn-request-" + shared_instance_parameters["slave_reference"] %}
{%- do requested_shared_instance_list.append(request_section_name) %}
[{{ request_section_name }}]
<= request-shared-instance-base
name = {{ shared_instance_parameters.pop('slave_reference') }}
{%-   for shared_instance_key, shared_instance_value in shared_instance_parameters.items() %}
config-{{ shared_instance_key }} = {{ shared_instance_value }}
{%-   endfor %}
{% endfor %}

[publish-information]
<= monitor-publish
recipe = slapos.cookbook:publish
domain = {{ slapparameter_dict.get('domain') }}
slave-amount = {{ instance_parameter_dict['slave-instance-list'] | length }}
accepted-slave-amount = {{ authorized_slave_list | length }}
rejected-slave-amount = {{ rejected_slave_dict | length }}
{# sort_keys are important in order to avoid shuffling parameters on each run #}
rejected-slave-dict = {{ dumps(json_module.dumps(rejected_slave_dict, sort_keys=True)) }}
rejected-slave-promise-url = ${rejected-slave-promise:config-url}
publish-failsafe-error-promise-url = ${publish-failsafe-error-promise:config-url}
{%- if len(warning_list) > 0 %}
{#- sort_keys are important in order to avoid shuffling parameters on each run #}
warning-list = {{ dumps(json_module.dumps(warning_list, sort_keys=True)) }}
{%- endif %}
{%- if len(warning_slave_dict) > 0 %}
{#- sort_keys are important in order to avoid shuffling parameters on each run #}
warning-slave-dict = {{ dumps(json_module.dumps(warning_slave_dict, sort_keys=True)) }}
{%- endif %}

{# Publish slave information #}
[publish-slave-information]
recipe = slapos.cookbook:switch-softwaretype
default = instance-publish-slave-information:output
replicate = instance-publish-slave-information:output
custom-personal = instance-publish-slave-information:output
custom-group = instance-publish-slave-information:output

[rejected-slave-information]
rejected-slave-dict = {{ dumps(rejected_slave_dict) }}

[warning-slave-information]
warning-slave-dict = {{ dumps(warning_slave_dict) }}

[slave-information]
{%- for frontend_section in frontend_section_list %}
{{ frontend_section }} = {{ "${%s:connection-slave-instance-information-list}" % frontend_section }}
{%- endfor %}

[active-slave-instance]
{%- set active_slave_instance_list = [] %}
{%- for slave_instance in instance_parameter_dict['slave-instance-list'] %}
{#- Provide a list of slave titles send by master, in order to filter out already destroyed slaves #}
{#- Note: This functionality is not yet covered by tests, please modify with care #}
{%-   do active_slave_instance_list.append(slave_instance['slave_reference']) %}
{%- endfor %}
{#- sort_keys are important in order to avoid shuffling parameters on each run #}
active-slave-instance-list = {{ json_module.dumps(active_slave_instance_list, sort_keys=True) }}

[instance-publish-slave-information]
< = jinja2-template-base
url = {{ software_parameter_dict['profile_master_publish_slave_information'] }}
filename = instance-publish-slave-information.cfg
extensions = jinja2.ext.do
extra-context =
    section slave_information slave-information
    section rejected_slave_information rejected-slave-information
    section active_slave_instance_dict active-slave-instance
    section warning_slave_information warning-slave-information
{%- for requested_instance_section in requested_shared_instance_list %}
    section {{requested_instance_section.replace("-", "_")}} {{requested_instance_section}}
{%- endfor %}


[monitor-base-url-dict]
{% for frontend in frontend_section_list %}
{{ frontend }} = {{ '${' + frontend + ':connection-monitor-base-url}' }}
{% endfor %}

[directory]
recipe = slapos.cookbook:mkdirectory
bin = ${buildout:directory}/bin/
srv = ${buildout:directory}/srv/
tmp = ${buildout:directory}/tmp/
backup = ${:srv}/backup

promise-output = ${:srv}/promise-output

[rejected-slave-json]
recipe = slapos.recipe.template:jinja2
filename = rejected-slave.json
directory = ${directory:promise-output}
output = ${:directory}/${:filename}
{% if critical_rejected_slave_dict %}
{# sort_keys are important in order to avoid shuffling parameters on each run #}
content = {{ dumps(json_module.dumps(critical_rejected_slave_dict, indent=2, sort_keys=True)) }}
{% else %}
content =
{% endif %}
context =
  key content :content

[buildout]
extends =
  {{ software_parameter_dict['profile_common'] }}
parts =
  publish-slave-information
{%- for part in part_list %}
{{ '  %s' % part }}
{%- endfor %}
