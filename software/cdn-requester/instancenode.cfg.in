[buildout]
extends = 
  {{ master_instance_profile }}

parts +=
  cdn-request-cron
  logrotate-entry-cdn-requester
  cdn-request-activity-promise


[software-parameter-section]
{%- for key,value in software_parameter_dict.items() %}
{{ key }} = {{ dumps(value) }}
{%- endfor %}

[publish-slave-information]
requester = instance-publish-slave-information:output

[cdn-requester-configuration]
cdn-requester-log = ${directory:log}/cdn-request.log
instance-db-path = {{ instancedb_path }}
requestinstance-db-path = {{ validated_instance_db_path }}
domainvalidation-db-path = ${directory:srv}/domainvalidation-db.sqlite

[cdn-request]
recipe = slapos.recipe.template
url = {{ software_parameter_dict['instancenode.cfg.in'] }}
output = ${directory:etc}/instancenode.cfg

[cdn-request-cron]
recipe = slapos.cookbook:cron.d
cron-entries = ${cron:cron-entries}
name = cdn-request
frequency = * * * * *
command = {{ software_parameter_dict['cdnrequest-bin'] }} --cfg ${cdn-request:output} --pidfile ${buildout:directory}/cdn-request.pid --logfile ${cdn-requester-configuration:cdn-requester-log}

[logrotate-entry-cdn-requester]
<= logrotate-entry-base
name = cdn-request
log = ${cdn-requester-configuration:cdn-requester-log}

[cdn-request-activity-sense]
recipe = slapos.recipe.template
output = ${directory:bin}/${:_buildout_section_name_}
inline =
  from datetime import datetime
  import os
  import re

  from zope.interface import implementer
  from slapos.grid.promise import interface
  from slapos.grid.promise.generic import GenericPromise

  log_file = '${cdn-requester-configuration:cdn-requester-log}'
  max_age_seconds = 300  # 5 minutes

  @implementer(interface.IPromise)
  class RunPromise(GenericPromise):
    def sense(self):
      if not os.path.exists(log_file):
        self.logger.error(
          "CDN request log file does not exist: %s",
          log_file
        )
        return

      # Read the log file and find the latest entry
      latest_timestamp = None
      try:
        with open(log_file, 'r') as f:
          # Read file in reverse to get the last line efficiently
          # For small files, reading all lines is fine
          lines = f.readlines()
          if not lines:
            self.logger.error(
              "CDN request log file is empty: %s",
              log_file
            )
            return

          # Parse the last line that matches the log format
          # Format: "2025-12-08 10:58:03,572 - cdn-request - INFO - ..."
          log_pattern = re.compile(
            r'^(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}),(\d{3})'
          )
          for line in reversed(lines):
            match = log_pattern.match(line.strip())
            if match:
              timestamp_str = match.group(1)  # "2025-12-08 10:58:03"
              milliseconds = match.group(2)  # "572"
              # Parse datetime (format: "YYYY-MM-DD HH:MM:SS")
              latest_timestamp = datetime.strptime(
                timestamp_str,
                '%Y-%m-%d %H:%M:%S'
              )
              break

        if latest_timestamp is None:
          self.logger.error(
            "Could not find a valid timestamp in CDN request log file: %s",
            log_file
          )
          return

        # Calculate age of the latest entry
        now = datetime.now()
        age_seconds = (now - latest_timestamp).total_seconds()

        if age_seconds < 0:
          # Log file has a future timestamp (clock skew or log rotation)
          self.logger.warning(
            "Latest log entry timestamp is in the future: %s (age: %.1f seconds)",
            latest_timestamp.strftime('%Y-%m-%d %H:%M:%S'),
            age_seconds
          )
          return

        if age_seconds > max_age_seconds:
          self.logger.error(
            "CDN request log has no recent activity. "
            "Latest entry is from %s (%.1f minutes ago, threshold: %.1f minutes)",
            latest_timestamp.strftime('%Y-%m-%d %H:%M:%S'),
            age_seconds / 60.0,
            max_age_seconds / 60.0
          )
        else:
          self.logger.info(
            "CDN request log is active. Latest entry is from %s (%.1f minutes ago)",
            latest_timestamp.strftime('%Y-%m-%d %H:%M:%S'),
            age_seconds / 60.0
          )

      except IOError as e:
        self.logger.error(
          "Failed to read CDN request log file %s: %s",
          log_file,
          e
        )
      except ValueError as e:
        self.logger.error(
          "Failed to parse timestamp in CDN request log file %s: %s",
          log_file,
          e
        )
      except Exception as e:
        self.logger.error(
          "Unexpected error checking CDN request log file %s: %s",
          log_file,
          e
        )

[cdn-request-activity-promise]
recipe = slapos.cookbook:promise.plugin
eggs =
  slapos.core
file = ${cdn-request-activity-sense:output}
output = ${directory:plugins}/cdn_request_activity.py
config-bang-on-failure = false
