[buildout]
extends =
  ../../stack/slapos.cfg
parts =
  slapos-cookbook
  template

[slapos.buildout-repository]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/xavier_thompson/slapos.buildout.git
branch = testing/buildout
git-executable = ${git:location}/bin/git

[runTestSuite_py]
recipe = zc.recipe.egg
eggs =
  erp5.util
  zc.buildout[test]
  zope.exceptions
  zope.interface
  zope.testing
  zope.testrunner
scripts = ${:interpreter}
interpreter = ${:_buildout_section_name_}

[egg-list]
recipe = slapos.recipe.build
eggs = ${runTestSuite_py:eggs}
init =
  options['egg-list'] = '\n  '.join(options['eggs'].split())


[template]
recipe = slapos.recipe.template
# XXX: "template.cfg" is hardcoded in instanciation recipe
output = ${buildout:directory}/template.cfg
inline =
  [buildout]
  eggs-directory = ${buildout:eggs-directory}
  develop-eggs-directory = ${buildout:develop-eggs-directory}
  parts = runTestSuite

  [slap-configuration]
  recipe = slapos.cookbook:slapconfiguration.serialised
  computer = $${slap-connection:computer-id}
  partition = $${slap-connection:partition-id}
  url = $${slap-connection:server-url}
  key = $${slap-connection:key-file}
  cert = $${slap-connection:cert-file}

  [directory]
  recipe = slapos.cookbook:mkdirectory
  bin = $${buildout:directory}/bin
  tmp = $${buildout:directory}/tmp

  [slapos.buildout-repository]
  recipe = slapos.recipe.build:gitclone
  repository = ${slapos.buildout-repository:location}
  git-executable = ${git:location}/bin/git
  shared = true

  [egg-paths]
  recipe = slapos.recipe.build
  eggs = ${egg-list:egg-list}
  init =
    import zc.buildout.easy_install
    eggs = options['eggs'].split()
    buildout = self.buildout['buildout']
    ws = zc.buildout.easy_install.working_set(
      eggs,
      [buildout['eggs-directory'], buildout['develop-eggs-directory']],
    )
    options['egg-paths'] = [
      d.location for d in ws
      if d.project_name not in ('zc.buildout', 'zc.recipe.egg')
    ]

  [runTestSuite]
  recipe = slapos.recipe.template:jinja2
  output = $${directory:bin}/$${:_buildout_section_name_}
  url = ${:_profile_base_location_}/$${:_buildout_section_name_}.in
  context =
    key slapparameter_dict slap-configuration:configuration
    key slapos_buildout slapos.buildout-repository:location
    key temp_directory directory:tmp
    key egg_paths egg-paths:egg-paths
    raw runTestSuite_py ${buildout:bin-directory}/${runTestSuite_py:interpreter}

[versions]
zope.exceptions = 4.6
zope.interface = 5.4.0
zope.testing = 4.7
zope.testrunner = 5.2

zc.zdaemonrecipe = 1.0.0
zc.recipe.deployment = 1.3.0
WebOb = 1.8.9
