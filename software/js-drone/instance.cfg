[buildout]
parts =
  cli-js
  demo-js
  publish-js

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[directory]
recipe = slapos.cookbook:mkdirectory
home = $${buildout:directory}
etc = $${:home}/etc
var = $${:home}/var
log = $${:var}/log

[slap-configuration]
recipe = slapos.cookbook:slapconfiguration
computer = $${slap_connection:computer_id}
partition = $${slap_connection:partition_id}
url = $${slap_connection:server_url}
key = $${slap_connection:key_file}
cert = $${slap_connection:cert_file}

[drone]
recipe = slapos.recipe.build
base-ipv6 = $${slap-configuration:ipv6-random}
slapparameter-dict = $${slap-configuration:configuration}
init =
  splitted_ipv6 = options['base-ipv6'].split(':')
  while len(splitted_ipv6[-2]) < 2:
    splitted_ipv6[-2] = "0" + splitted_ipv6[-2]
  options['multicast-ipv6'] = "ff02::1:ff%s:%s" % (
                                                   splitted_ipv6[-2][-2:],
                                                   splitted_ipv6[-1],
                                                  )
  options['autopilot-ip'] = options['slapparameter-dict'].get('autopilot_ip', '169.79.1.1')

[dynamic-template-base]
recipe = slapos.recipe.template:jinja2
rendered = $${directory:etc}/$${:filename}
extra-context =
context =
  key autopilot_ip drone:autopilot-ip
  key log_dir directory:log
  key publish_script publish-js:rendered
  raw qjs_wrapper ${qjs-wrapper:location}/lib/libqjswrapper.so
  $${:extra-context}

[cli-js]
< = dynamic-template-base
template = ${cli:location}/${cli:filename}
filename = ${cli:filename}

[demo-js]
< = dynamic-template-base
template = ${demo:location}/${demo:filename}
filename = ${demo:filename}

[publish-js]
< = dynamic-template-base
template = ${publish:location}/${publish:filename}
filename = ${publish:filename}
extra-context =
  key ipv6 drone:multicast-ipv6
