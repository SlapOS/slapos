{% set autopilot_ip = slapparameter_dict.get('autopilot-ip', '192.168.27.1') -%}
{% set flight_script = slapparameter_dict.get('flight-script', 'https://lab.nexedi.com/nexedi/flight-scripts/raw/master/default.js') -%}
{% set is_a_simulation = slapparameter_dict.get('is-a-simulation', 'false') -%}
{% set multicast_ip = slapparameter_dict.get('multicast-ip', 'ff15::1111') -%}
{% set net_if = slapparameter_dict.get('net-if', 'eth0') -%}

{% set drone_guid_list = slapparameter_dict.get('drone-guid-list', []) -%}
{% set subscriber_guid_list = slapparameter_dict.get('subscriber-guid-list', []) -%}
{% set guid_list = drone_guid_list + subscriber_guid_list -%}
{% set drone_id_list = list(range(1, len(guid_list) + 1)) %}

{% set part_list = [] -%}

{% for drone_id, guid in enumerate(guid_list) -%}
{%   set request_drone_section_title = 'request-drone' ~ drone_id -%}
{%   do part_list.append(request_drone_section_title) -%}
[{{ request_drone_section_title }}]
<= slap-connection
recipe = slapos.cookbook:request.serialised
name = Drone{{ drone_id }}
software-url = $${:software-release-url}
software-type = drone
sla-computer_guid = {{ guid }}
config-autopilot-ip = {{ autopilot_ip }}
config-drone-id-list = {{ dumps(drone_id_list) }}
config-id = {{ dumps(drone_id) }}
config-is-a-simulation = {{ dumps(is_a_simulation) }}
{% if guid in drone_guid_list %}
config-is-publisher = {{ dumps(True) }}
config-flight-script = {{ flight_script }}
{% else %}
config-is-publisher = {{ dumps(False) }}
config-flight-script = https://lab.nexedi.com/nexedi/flight-scripts/raw/master/subscribe.js
{% endif %}
config-multicast-ip = {{ multicast_ip }}
config-net-if = {{ net_if }}
{% endfor -%}

[buildout]
parts =
{% for part in part_list %}
  {{ part }}
{% endfor %}
