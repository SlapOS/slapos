[buildout]
parts =
  main

[directory]
recipe = slapos.cookbook:mkdirectory
home = $${buildout:directory}
etc = $${:home}/etc
var = $${:home}/var
log = $${:var}/log

[js-dynamic-template]
recipe = slapos.recipe.template:jinja2
rendered = $${directory:etc}/$${:_buildout_section_name_}.js
template = ${buildout:directory}/$${:_buildout_section_name_}.js
extra-context =
context =
  raw qjs_wrapper ${qjs-wrapper:location}/lib/libqjswrapper.so
  $${:extra-context}

[main]
<= js-dynamic-template
extra-context =
  raw autopilot_ip {{ slapparameter_dict['autopilot-ip'] }}
  raw id {{ slapparameter_dict['id'] }}
  raw is_a_simulation {{ slapparameter_dict['is-a-simulation'] }}
  raw is_publisher {{ slapparameter_dict['is-publisher'] }}
  key log_dir directory:log
  key pubsub_script pubsub:rendered
  key worker_script worker:rendered

[pubsub]
<= js-dynamic-template
extra-context =
  raw ipv6 {{ slapparameter_dict['multicast-ip'] }}
  raw net_if {{ slapparameter_dict['net-if'] }}

[worker]
<= js-dynamic-template
extra-context =
  raw drone_id_list {{ slapparameter_dict['drone-id-list'] }}
  raw id {{ slapparameter_dict['id'] }}
  raw is_publisher {{ slapparameter_dict['is-publisher'] }}
