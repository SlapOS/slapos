[buildout]
parts =
  instance
  publish-connection-parameter
## Monitoring part XXX whe should not have to specify all parts like this
## Parts to add for monitoring
  certificate-authority
  cron
  cron-entry-monitor
  cron-entry-rss
  deploy-index
  deploy-settings-cgi
  deploy-status-cgi
  deploy-status-history-cgi
  setup-static-files
  zero-parameters
  public-symlink
  cgi-httpd-wrapper
  cgi-httpd-graceful-wrapper
  monitor-promise
  monitor-instance-log-access
## Monitor for ipython
  monitor-current-log-access
  monitor-deploy-set-password-cgi
  erp5-kernel
  kernel-json
  custom-js

extends = {{ monitor_template }}

eggs-directory = {{ eggs_directory }}
develop-eggs-directory = {{ develop_eggs_directory }}
offline = true

[slapconfiguration]
recipe = slapos.cookbook:slapconfiguration
computer = ${slap-connection:computer-id}
partition = ${slap-connection:partition-id}
url = ${slap-connection:server-url}
key = ${slap-connection:key-file}
cert = ${slap-connection:cert-file}
configuration.erp5_url =

[instance-parameter]
port = 8888
host = ${slapconfiguration:ipv6-random}
cert_file = ${certificate-authority-jupyter:cert-file}
key_file = ${certificate-authority-jupyter:key-file}
logfile = ${directory:log}/ipython_notebook.log
notebook_dir = ${directory:notebook_dir}

[dynamic-jinja2-template-base]
recipe = slapos.recipe.template:jinja2
mode = 0644

[certificate-authority-jupyter]
<= certificate-authority
recipe = slapos.cookbook:certificate_authority.request
openssl-binary = {{ openssl_output }}
cert-file = ${directory:etc}/ipython_notebook_cert.crt
key-file = ${directory:etc}/ipython_notebook_cert.key
executable = ${instance:wrapper-path}

[instance]
recipe = slapos.cookbook:wrapper
command-line =
  {{ bin_directory }}/ipython notebook
  --no-browser
  --matplotlib=inline
  --ip=${instance-parameter:host}
  --port=${instance-parameter:port}
  --port-retries=0
  --certfile=${instance-parameter:cert_file}
  --keyfile=${instance-parameter:key_file}
  --notebook-dir=${instance-parameter:notebook_dir}
  --logfile=${instance-parameter:logfile}
  --config=${ipython_notebook_config:rendered}
## Adding log-level as parameter helps in checking error from ipython-notebook
## service.
  --log-level="DEBUG"
wrapper-path = ${directory:service}/ipython_notebook
parameters-extra = true
environment = IPYTHONDIR=${directory:ipython_dir}

[ipython_notebook_config]
<= dynamic-jinja2-template-base
template = {{ ipython_notebook_config_location }}/{{ ipython_notebook_config_filename }}
rendered = ${directory:etc}/ipython_notebook_config.py
context =
  raw config_cfg ${buildout:directory}/knowledge0.cfg
  raw ipython_dir ${directory:ipython_dir}

[monitor-current-log-access]
< = monitor-directory-access
source = ${instance-parameter:logfile}

[monitor-deploy-set-password-cgi]
<= dynamic-jinja2-template-base
template = {{ ipython_notebook_set_password_location }}/{{ ipython_notebook_set_password_filename }}
rendered = ${monitor-directory:knowledge0-cgi}/${:filename}
filename = ipython-notebook-password.cgi
context =
  raw config_cfg ${buildout:directory}/knowledge0.cfg
  raw python_executable {{ python_executable }}
  key pwd monitor-directory:knowledge0-cgi
  key this_file :filename
  key httpd_graceful cgi-httpd-graceful-wrapper:rendered

[directory]
recipe = slapos.cookbook:mkdirectory
home = ${buildout:directory}
etc = ${:home}/etc
var = ${:home}/var
script = ${:etc}/run/
service = ${:etc}/service
promise = ${:etc}/promise/
log = ${:var}/log
notebook_dir = ${:var}/notebooks
ipython_dir = ${:home}/ipython
ipython_kernel_dir = ${:ipython_dir}/kernels
erp5_kernel_dir = ${:ipython_kernel_dir}/ERP5

[publish-connection-parameter]
recipe = slapos.cookbook:publish.serialised
url = https://[${instance-parameter:host}]:${instance-parameter:port}
monitor_url = ${monitor-parameters:url}
erp5_url = ${slapconfiguration:configuration.erp5_url}

[erp5-kernel]
<= dynamic-jinja2-template-base
template = {{ erp5_kernel_location }}/{{ erp5_kernel_filename }}
rendered = ${directory:erp5_kernel_dir}/ERP5kernel.py
context =
  raw python_executable {{ bin_directory }}/python2.7
  key erp5_url slapconfiguration:configuration.erp5_url

[kernel-json]
<= dynamic-jinja2-template-base
template = {{ kernel_json_location }}/{{ kernel_json_filename }}
rendered = ${directory:erp5_kernel_dir}/kernel.json
context =
  raw python_executable {{ python_executable }}
  key kernel_dir erp5-kernel:rendered
  raw display_name ERP5
  raw language_name python

[custom-js]
<= dynamic-jinja2-template-base
template = {{ custom_js_location }}/{{ custom_js_filename }}
rendered = ${directory:ipython_dir}/profile_default/static/custom/custom.js
