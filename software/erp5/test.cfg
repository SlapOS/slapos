[buildout]
extends =
  ../../component/pytest/buildout.cfg
  software.cfg
parts +=
  template-test

# Pick ZODB version which is compatible with both erp5/py2 + WCFS
[ZODB]
major = 4-wc2

# Currently we need to use patched NEO to run WCFS + NEO tests.
[neoppod-repository]
repository = https://lab.nexedi.com/kirr/neo.git
branch = t

# We want to use master branch of wendelin.core with all
# recent commits.
[wendelin.core-repository]
revision =

# We use external standalone test program to verify WCFS is working
# as expected. We can't use the default erp5 test suite, because this
# test suite runs with py3. We need NEO for testing, but NEO doesn't
# support py3 yet.
[template-erp5-test]
<= download-base
url = ${:_profile_base_location_}/instance-erp5-test.cfg.in

[template]
output = ${buildout:directory}/_template.cfg

[template-test]
recipe = slapos.recipe.template:jinja2
url = ${:_profile_base_location_}/instance-test.cfg.in
output = ${buildout:directory}/template.cfg
md5sum = 92c7f13734c921bb27002579222268b1
context =
  key template template:output
  key template_erp5_test template-erp5-test:target
  key erp5_wcfs_test_bin erp5-wcfs-test:bin

[erp5-wcfs-test]
<= eggs
eggs =
  ${pytest:eggs}
  ${erp5-wcfs-test-egg:egg}
  ZODB3
script-name = ${:_buildout_section_name_}
entry-points = ${:script-name}=__main__:main
initialization =
  import os
  import sys
  import pytest
  # Explicitly turn on WCFS mode
  os.environ["WENDELIN_CORE_VIRTMEM"] = "r:wcfs+w:uvmm"
  # WCFS should already run!
  os.environ["WENDELIN_CORE_WCFS_AUTOSTART"] = "no"
  zurl = sys.argv[1]
  error_code = pytest.main(["--zurl", zurl, "${erp5-wcfs-test-egg:setup}"])
  sys.exit(error_code)
bin = ${buildout:bin-directory}/${:script-name}
scripts +=
  ${:script-name}

[erp5-wcfs-test-egg]
recipe = zc.recipe.egg:develop
egg = slapos.test.erp5_wcfs
setup = ${slapos-repository:location}/software/erp5/test_wcfs/

[slapos-repository]
recipe = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git
forbid-download-cache = true
repository = https://lab.nexedi.com/nexedi/slapos.git
branch = master
