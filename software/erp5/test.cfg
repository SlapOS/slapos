[buildout]
extends =
  ../../component/pytest/buildout.cfg
  software.cfg

# Pick ZODB version which is compatible with both erp5/py2 + WCFS
[ZODB]
major = 4-wc2

# Currently we need to use patched NEO to run WCFS + NEO tests.
[neoppod-repository]
repository = https://lab.nexedi.com/kirr/neo.git
branch = t

# We use external standalone test program to verify WCFS is working
# as expected. We can't use the default erp5 test suite, because this
# test suite runs with py3. We need NEO for testing, but this doesn't
# support py3 yet.
[template-erp5-wcfs-test]
<= download-base
filename = "instance-test.cfg.in"

[_template]
<= template
output = ${buildout:directory}/_template.cfg

[template]
url = ${:_profile_base_location_}/instance-test.cfg.in
context =
  key template _template:output
  key template_erp5_wcfs_test template-erp5-wcfs-test:target
  key erp5_wcfs_test_bin erp5-wcfs-test:bin

[erp5-wcfs-test]
recipe = zc.recipe.egg
eggs =
  ${pytest:eggs}
  ${ZODB4-wc2:egg}
  ${numpy:egg}
  ${wendelin.core:egg}
  ${neoppod:eggs}
  ${ZEO:egg}
  ${erp5-wcfs-test-egg:egg}
entry-points = ${:_buildout_section_name_}=__main__:main
initialization =
  import sys
  import pytest
  zurl = sys.argv[1]
  error_code = pytest.main(["--zurl", zurl, "${erp5-wcfs-test-egg:setup}"])
  sys.exit(error_code)
bin = ${:bin-directory}/${:_buildout_section_name_}

[erp5-wcfs-test-egg]
recipe = zc.recipe.egg:develop
egg = slapos.test.erp5_wcfs
setup = ${slapos-repository:location}/software/erp5/test_wcfs/

[slapos-repository]
<= git-clone-repository
repository = https://lab.nexedi.com/nexedi/slapos.git
branch = master
