<?php

$user = @$_REQUEST["user"]; // accept from both GET and POST
$token = @$_REQUEST["token"];
$newPassword = @$_POST["password"]; // password should only be sent in POST

if (!isset($user) || !isset($token) || !isset($newPassword)) {
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Password reset</title>
</head>
<body>
    <h1>Password reset</h1>
    <form method="POST" action="">
        <label for="user">User:</label><br>
        <input type="text" id="user" name="user" value="<?php echo htmlspecialchars($user ?? ''); ?>"><br><br>
        <label for="token">Token:</label><br>
        <input type="text" id="token" name="token" value="<?php echo htmlspecialchars($token ?? ''); ?>"><br><br>
        <label for="password">New Password:</label><br>
        <input type="password" id="password" name="password"><br><br>
        <input type="submit" value="Submit">
    </form>
    <p>Note: This URL can only be used to set the first password of an account.</p>
</body>
</html>
<?php
    exit(0);
}

$filePath = "{{ dovecot_passwd }}";

function readUsers() {
    global $filePath;
    $result = [];
    $keys = ['name', 'passwd', 'uid', 'gid', 'gecos', 'dir', 'shell', 'extra_fields'];
    $handle = fopen($filePath, 'r');
    if (!$handle) {
        throw new \RuntimeException(
            "Failed to open $filePath for reading! " . print_r(error_get_last(), true)
        );
    }
    while (($values = fgetcsv($handle, 1000, ':')) !== false) {
        $values = array_pad($values, count($keys), '');
        $result[] = array_combine($keys, $values);
    }
    fclose($handle);
    return $result;
}

function writeUsers($entries) {
    global $filePath;
    $handle = fopen($filePath, 'w');
    if (!$handle) {
        throw new \RuntimeException(
            "Failed to open $filePath for writing! " . print_r(error_get_last(), true)
        );
    }
    foreach ($entries as $entry) {
        fputcsv($handle, $entry, ':');
    }
    fclose($handle);
}

$content = readUsers();

foreach($content as &$entry) {
    if ($entry["name"] == $user) {
        if ($entry["extra_fields"] != "fail") {
            throw new \RuntimeException("User '$user' is already active. This URL can only be used to set the first password of an account.");
        }
        if (hash_equals($entry["passwd"], $token)) {
            $entry["extra_fields"] = "";
            $entry["passwd"] = "{BLF-CRYPT}". password_hash($newPassword, PASSWORD_BCRYPT);
            echo "Password updated successfully. You can now log in with your new password.<br>If this was a manual password reset, remember to remove the <code>reset-token</code> item from your shared instance's parameters.<br><br>";
            echo '<a href="./">Return to login page</a>';
            writeUsers($content);
            exit(0);
        } else {
            throw new \RuntimeException("Invalid token for user '$user'.");
        }
    }
}

throw new \RuntimeException("User '$user' not found.");

