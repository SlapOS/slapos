{% set part_list = [] -%}
{% macro section(name) %}{% do part_list.append(name) %}{{ name }}{% endmacro -%}

{%- for slave in slave_instance_list %}
{%   do slave.__setitem__('token', str(uuid_module.uuid4())) %}
{%- endfor %}

[directory]
recipe = slapos.cookbook:mkdirectory
home = ${buildout:directory}
etc = ${:home}/etc
var = ${:home}/var
bin = ${:home}/bin
usr = ${:home}/usr
tmp = ${:home}/tmp
run = ${:var}/run
libexec = ${:usr}/libexec
run-dovecot = ${:run}/dovecot
var-dovecot = ${:var}/dovecot
tmp-dovecot = ${:tmp}/dovecot
libexec-dovecot = ${:libexec}/dovecot
home-dovecot = ${:home}/dovecot-home
script = ${:etc}/run
service = ${:etc}/service
log = ${:var}/log
usr-postfix = ${:usr}/postfix
etc-postfix = ${:etc}/postfix
var-log = ${:var}/log
var-lib = ${:var}/lib
var-lib-postfix = ${:var-lib}/postfix
var-spool = ${:var}/spool
vhosts = ${:home}/vhosts
srv = ${buildout:directory}/srv
apache.d = ${:etc}/apache.d
httpd-log = ${:log}/apache
php-ini-dir = ${:etc}/php
srv-backup = ${:srv}/backup
tmp-php = ${:tmp}/php
tmp-upload = ${:tmp}/upload
www = ${:srv}/www/

[postfix-directory]
recipe = slapos.cookbook:mkdirectory
var-spool-postfix = ${directory:var-spool}/postfix
# Not used at buildout level, presence needed by postfix.
var-spool-postfix-active = ${:var-spool-postfix}/active
var-spool-postfix-bounce = ${:var-spool-postfix}/bounce
var-spool-postfix-corrupt = ${:var-spool-postfix}/corrupt
var-spool-postfix-defer = ${:var-spool-postfix}/defer
var-spool-postfix-deferred = ${:var-spool-postfix}/deferred
var-spool-postfix-flush = ${:var-spool-postfix}/flush
var-spool-postfix-hold = ${:var-spool-postfix}/hold
var-spool-postfix-incoming = ${:var-spool-postfix}/incoming
var-spool-postfix-maildrop = ${:var-spool-postfix}/maildrop
var-spool-postfix-pid = ${:var-spool-postfix}/pid
var-spool-postfix-private = ${:var-spool-postfix}/private
var-spool-postfix-public = ${:var-spool-postfix}/public
var-spool-postfix-saved = ${:var-spool-postfix}/saved
var-spool-postfix-trace = ${:var-spool-postfix}/trace

[ca-directory]
recipe = slapos.cookbook:mkdirectory
root = ${directory:srv}/ssl
requests = ${:root}/requests
private = ${:root}/private
certs = ${:root}/certs
newcerts = ${:root}/newcerts
crl = ${:root}/crl

[certificate-authority]
recipe = slapos.cookbook:certificate_authority
openssl-binary = {{ openssl_location }}/bin/openssl
ca-dir = ${ca-directory:root}
requests-directory = ${ca-directory:requests}
wrapper = ${directory:bin}/certificate_authority
ca-private = ${ca-directory:private}
ca-certs = ${ca-directory:certs}
ca-newcerts = ${ca-directory:newcerts}
ca-crl = ${ca-directory:crl}

[certificate-authority-service]
recipe = slapos.cookbook:wrapper
command-line = ${certificate-authority:wrapper}
wrapper-path = ${directory:services}/certificate_authority
hash-existing-files = ${buildout:directory}/software_release/buildout.cfg

[apache-network-configuration]
listening-ip = {{ ipv6 }}
listening-port = 9988

[dovecot-conf]
recipe = slapos.recipe.template:jinja2
url = {{ dovecot_conf_template }}
output = ${directory:etc}/dovecot.conf
context =
  section directory directory
  key dovecot_passwd dovecot-passwords:location
  raw user_name {{ user_name }}
  raw postfix_auth ${postfix-directory:var-spool-postfix-private}/auth
  raw postfix_dovecot_lmtp ${postfix-directory:var-spool-postfix-private}/dovecot-lmtp

#[dovecot-passwd]
#recipe = slapos.recipe.template:jinja2
#url = {{ dovecot_passwd }}
#output = ${directory:etc}/dovecot-passwd
#extensions = jinja2.ext.do
#context =
#  import json_module json
#  import builtins builtins
#  raw file_path ${:output}
#  raw instances {{ json_module.dumps(slave_instance_list) }}
#  raw mail_domains {{ slapparameter_dict['mail-domains'] |join(',') }}

[dovecot-passwords]
recipe = slapos.recipe.build
location = ${directory:etc}/dovecot-passwd
init =
  try:
    with open(options['location']) as fp:
      options['existing'] = fp.read()
  except:
    options['existing'] = ""
install =
  passwd = options['existing'].splitlines()
  existing_users = {row.split(":")[0] for row in passwd if row}
  result = passwd
  
  for slave in {{ json_module.dumps(slave_instance_list) }}:
    if slave['address'] not in existing_users:
      result.append(f"{slave['address']}:{slave['token']}::::::fail")
      existing_users.add(slave['address'])

  for domain in {{ repr(slapparameter_dict['mail-domains']) }}:
    test_mail = f"testmail@{domain}"
    if test_mail not in existing_users:
      result.append(f"{test_mail}:MotDePasseEmail::")

  with open(options['location'], 'w') as fp:
    for row in result:
      fp.write(f"{row}\n")

[password-php]
recipe = slapos.recipe.template:jinja2
url = {{ password_php }}
output = ${directory:www}/password.php
context =
  key dovecot_passwd dovecot-passwords:location

[userinfo]
recipe = slapos.cookbook:userinfo

[ethernet-ip]
recipe = slapos.recipe.build
init =
  import netifaces
  for i in netifaces.interfaces():
      if not (i.startswith("slaptun") or i.startswith("re6stnet") or i == "lo"):
          a = netifaces.ifaddresses(i)
          if netifaces.AF_INET in a:
              try:
                  options['ipv4'] = a[netifaces.AF_INET][0]['addr']
              except:
                  options['ipv4'] = "0.0.0.0"

[postfix-conf-main]
recipe = slapos.recipe.template:jinja2
url = {{ postfix_main_template }}
output = ${directory:etc-postfix}/main.cf
context =
  key dovecot_passwd dovecot-passwords:location
  key bin_directory directory:bin
  key usr_directory directory:usr-postfix
  key queue_directory postfix-directory:var-spool-postfix
  key data_directory directory:var-lib-postfix
  key spool_directory directory:var-spool
  key vhosts_directory directory:vhosts
  key log_directory directory:var-log
  key mail_owner userinfo:pw-name
  key setgid_group userinfo:gr-name
  raw server_fqdn {{ server_fqdn }}
  raw postfix_dovecot_lmtp ${postfix-directory:var-spool-postfix-private}/dovecot-lmtp
  raw xz_utils_location {{ xz_utils_location }}
  raw postfix_location {{ postfix_location }}
  raw relay_host {{ slapparameter_dict['relay-host'] }}
  raw relay_port {{ slapparameter_dict['relay-port'] }}
  raw mail_domains {{ slapparameter_dict['mail-domains'] |join(',') }}
  raw ipv6 {{ ipv6 }}

[postfix-conf-master]
recipe = slapos.recipe.template:jinja2
url = {{ postfix_master_template }}
output = ${directory:etc-postfix}/master.cf
context =
  key smtp_port publish-connection-information:smtp-port



[snappymail-conf]
recipe = slapos.recipe.template:jinja2
depends = ${copy-application:recipe}
url = {{ snappymail_conf }}
output = ${copy-application:target}/data/_data_/_default_/configs/application.ini
context =
  raw mail_domain {{ slapparameter_dict['mail-domains'][0] }}


[snappymail-domain]
recipe = slapos.recipe.template:jinja2
depends = ${copy-application:recipe}
url = {{ snappymail_domain }}
output = ${copy-application:target}/data/_data_/_default_/domains/default.json
context =
  raw mail_host [${apache-network-configuration:listening-ip}]
  key smtp_port publish-connection-information:smtp-port


[dovecot-wrapper]
recipe = slapos.recipe.template
output = ${directory:bin}/${:_buildout_section_name_}
inline =
  #!/bin/sh
  # If master.pid contains PID of any running process
  # dovecot will refuse to run. Only the pidfile provided
  # by wrapper recipe should be used
  rm -f var/run/dovecot/master.pid
  {{ dovecot_binary }} -F -c ${dovecot-conf:output}

[dovecot-service]
recipe = slapos.cookbook:wrapper
command-line = ${dovecot-wrapper:output}
wrapper-path = ${directory:service}/dovecot
mode = 0775
pidfile = ${directory:run}/dovecot.pid
hash-files =
  ${dovecot-conf:output}
  ${dovecot-wrapper:output}

[postfix-symlinks-libexec]
recipe = slapos.cookbook:symbolic.link
target-directory = ${directory:usr-postfix}
link-binary =
    {{ postfix_location }}/usr/libexec

[postfix-wrapper]
recipe = slapos.recipe.template
output = ${directory:bin}/${:_buildout_section_name_}
inline =
  #!/bin/sh
  rm -f var/spool/postfix/pid/master.pid
  ${directory:usr-postfix}/libexec/postfix/master -c ${directory:etc-postfix}


[ca-apache-php]
<= certificate-authority
recipe = slapos.cookbook:certificate_authority.request
key-file = ${apache-php-configuration:key-file}
cert-file = ${apache-php-configuration:cert-file}
executable = ${apache-php-wrapper:wrapper-path}
wrapper = ${directory:bin}/ca-apache-php

[postfix-service]
recipe = slapos.cookbook:wrapper
command-line = ${postfix-wrapper:output}
wrapper-path = ${directory:service}/postfix
mode = 0775
pidfile = ${directory:run}/postfix.pid
environment =
  MAIL_CONFIG=${directory:etc-postfix}
hash-files =
  ${postfix-conf-main:output}
  ${postfix-wrapper:output}

[apache-php-service]
recipe = slapos.cookbook:wrapper
command-line = ${ca-apache-php:wrapper}
wrapper-path = ${directory:service}/apache-php
hash-existing-files = ${buildout:directory}/software_release/buildout.cfg
depends =
 ${copy-application:recipe}
 ${apache-graceful:recipe}

[apache-graceful]
recipe = collective.recipe.template
output = ${directory:script}/apache-httpd-graceful
mode = 700
input = inline:
  #!/bin/sh
  kill -USR1 "$(cat '${apache-php-configuration:pid-file}')"


[copy-application]
recipe = plone.recipe.command
target = ${directory:www}
command = cp -ax {{ apache_parameter_dict['application-location'] }}/. ${:target}
update-command = ${:command}
stop-on-error = true

[apache-php-conf]
recipe = slapos.recipe.template:jinja2
url = {{ apache_parameter_dict['template-apache-conf'] }}
output = ${directory:etc}/apache.conf
context =
  section parameter_dict apache-php-configuration
extensions = jinja2.ext.do

[apache-php-wrapper]
recipe = slapos.cookbook:wrapper
wrapper-path = ${directory:bin}/apache-wrapper
command-line = "{{ apache_parameter_dict['apache-location'] }}/bin/httpd" -f "${apache-php-conf:output}" -DFOREGROUND
wait-for-files =
  ${ca-directory:certs}/httpd.crt
  ${ca-directory:certs}/httpd.key

[apache-php-configuration]
document-root = ${directory:www}
pid-file = ${directory:run}/apache.pid
lock-file = ${directory:run}/apache.lock
ip = ${apache-network-configuration:listening-ip}
port = ${apache-network-configuration:listening-port}
url = https://[${:ip}]:${:port}/
error-log = ${directory:httpd-log}/error.log
access-log = ${directory:httpd-log}/access.log
log-dir = ${directory:httpd-log}
php-ini-dir = ${directory:php-ini-dir}
cert-file = ${ca-directory:certs}/httpd.crt
key-file = ${ca-directory:certs}/httpd.key
apache-config-dir = ${directory:apache.d}

[publish-connection-information]
recipe = slapos.cookbook:publish.serialised
<= monitor-publish
imap-port = 10143
smtp-port = 10025
imap-smtp-ipv6 = ${apache-network-configuration:listening-ip}
webmail-url = ${lamp-frontend-promise:url}
password-url = ${:webmail-url}/password.php
{% set token_dict = {} -%}
{% for slave_instance in slave_instance_list -%}
{%  do token_dict.__setitem__(slave_instance["address"], slave_instance["token"]) -%}
{% endfor -%}
slaves = {{ json_module.dumps(token_dict) }}

[lamp-apache-httpd]
recipe = slapos.recipe.template:jinja2
url = {{ lamp_apache_httpd }}
output = ${directory:apache.d}/lamp.conf
context =
  section parameter_dict apache-php-configuration

[request-frontend]
<= monitor-frontend
name = Instance Frontend
config-url = ${apache-php-configuration:url}

[lamp-frontend-promise]
<= monitor-promise-base
promise = check_url_available
name = lamp-http-frontend.py
url = ${request-frontend:connection-secure_access}
config-url = ${:url}

[imap-listen-promise]
<= monitor-promise-base
promise = check_socket_listening
name = imap_listen.py
config-host = ${apache-network-configuration:listening-ip}
config-port = 10143

[smtp-listen-promise]
<= monitor-promise-base
promise = check_socket_listening
name = smtp_listen.py
config-host = ${apache-network-configuration:listening-ip}
config-port = ${publish-connection-information:smtp-port}

[promise]
# Check any apache port in ipv4, expect other ports and ipv6 to behave consistently
<= monitor-promise-base
promise = check_socket_listening
name = apache-httpd-port-listening.py
config-host = ${apache-php-configuration:ip}
config-port = ${apache-php-configuration:port}

[base-wrapper]
recipe = slapos.cookbook:wrapper
environment =
  MAIL_CONFIG=${directory:etc-postfix}

[base-bin-wrapper]
< = base-wrapper
command-line = ${:path}/${:basename}
wrapper-path = ${directory:bin}/${:basename}

[base-bin-bin-wrapper]
< = base-bin-wrapper
path = {{ postfix_location }}/usr/bin

[base-sbin-bin-wrapper]
< = base-bin-wrapper
path = {{ postfix_location }}/usr/sbin

{% for extend, basename_list in (
  (
    'base-bin-bin-wrapper',
    (
      'mailq',
      'newaliases',
    ),
  ),
  (
    'base-sbin-bin-wrapper',
    (
      'postcat',
      'postconf',
      'postdrop',
      'postfix',
      'postkick',
      'postlock',
      'postlog',
      'postmap',
      'postmulti',
      'postqueue',
      'postsuper',
      'sendmail',
    ),
  ),
) %}
{%   for basename in basename_list -%}
[{{ section('wrapper-' ~ basename) }}]
< = {{ extend }}
basename = {{ basename }}
{%   endfor %}
{% endfor %}

[{{ section('service-postfix-master') }}]
< = base-wrapper
command-line = ${directory:usr}/libexec/postfix/master -c ${directory:etc-postfix}
wrapper-path = ${directory:run}/postfix-master

{% for slave_instance in slave_instance_list -%}
{%   set orig_slave_reference = slave_instance.get('slave_reference') -%}
{%   set slave_reference = orig_slave_reference.replace(' ', '_') -%}

{%   set publish_section_title = 'publish-%s' % slave_reference -%}
{%   do part_list.append(publish_section_title) -%}
[{{ publish_section_title }}]

recipe = slapos.cookbook:publish
-slave-reference = {{ orig_slave_reference }}
password-url = "helloworld"

{% endfor -%}


[buildout]
extends =
  {{ template_monitor }}
parts =
  directory
  lamp-frontend-promise
  copy-application
  snappymail-conf
  snappymail-domain
  dovecot-conf
  dovecot-service
  password-php
  postfix-conf-main
  postfix-conf-master
  postfix-service
  postfix-symlinks-libexec
  monitor-base
  publish-connection-information
  certificate-authority
  imap-listen-promise
  smtp-listen-promise
  php.ini-conf
  lamp-apache-httpd
  apache-php-service
{% for part in part_list -%}
{{ '    %s' % part }}
{% endfor -%}

eggs-directory = {{ eggs_directory }}
develop-eggs-directory = {{ develop_eggs_directory }}
offline= true

[instance-parameter]
document-root = ${apache-php-configuration:document-root}
backend-url = ${apache-php-configuration:url}
php-bin = {{ apache_parameter_dict['apache-php-location'] }}/bin/php
php-ini = ${php.ini-conf:output}

[php.ini-configuration]
tmp-dir = ${directory:tmp-php}
php-upload-dir = ${directory:tmp-upload}

[php.ini-conf]
recipe = slapos.recipe.template:jinja2
url = {{ apache_parameter_dict['template-php-ini'] }}
output = ${directory:php-ini-dir}/php.ini
context =
  section apache_parameter_dict php.ini-configuration
  section instance_dict instance-parameter
extensions = jinja2.ext.do

[php-bin]
recipe = slapos.cookbook:wrapper
wrapper-path = ${directory:bin}/php
command-line = ${instance-parameter:php-bin} -c ${php.ini-conf:output}
