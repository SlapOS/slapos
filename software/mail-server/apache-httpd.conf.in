# HTTP VirtualHost for autoconfig only
<VirtualHost *:{{ parameter_dict['http-port'] }}>
  ServerAdmin admin@example.com
  DocumentRoot {{ parameter_dict['autoconfig-root'] }}

  <Directory {{ parameter_dict['autoconfig-root'] }}>
      Options -Indexes -FollowSymlinks
      AllowOverride None
      Require all denied
  </Directory>

  # Only allow access to the autoconfig XML file
  <Location /mail/config-v1.1.xml>
      Require all granted
      ForceType text/xml
  </Location>

  ErrorLog "{{ parameter_dict['log-dir'] }}/lamp-error.log"
  CustomLog "{{ parameter_dict['log-dir'] }}/lamp-access.log" combined
</VirtualHost>

# HTTPS VirtualHost for webmail and other services
<VirtualHost *:{{ parameter_dict['https-port'] }}>
  ServerAdmin admin@example.com
  DocumentRoot {{ parameter_dict['document-root'] }}

  SSLEngine on
  SSLCertificateFile {{ parameter_dict['cert-file'] }}
  SSLCertificateKeyFile {{ parameter_dict['key-file'] }}

  SetEnvIf Origin "^http(s)?://(.+\.)?(app\.officejs\.com)$" ORIGIN_DOMAIN=$0
  Header always set Access-Control-Allow-Origin "%{ORIGIN_DOMAIN}e" env=ORIGIN_DOMAIN
  Header always set Access-Control-Allow-Credentials "true" env=ORIGIN_DOMAIN
  Header always set Access-Control-Allow-Methods "PROPFIND, PROPPATCH, COPY, MOVE, DELETE, MKCOL, LOCK, UNLOCK, PUT, GETLIB, VERSION-CONTROL, CHECKIN, CHECKOUT, UNCHECKOUT, REPORT, UPDATE, CANCELUPLOAD, HEAD, OPTIONS, GET, POST" env=ORIGIN_DOMAIN
  Header always set Access-Control-Allow-Headers "Overwrite, Destination, Content-Type, Depth, User-Agent, X-File-Size, X-Requested-With, If-Modified-Since, X-File-Name, Cache-Control, Authorization" env=ORIGIN_DOMAIN
  Header always set Strict-Transport-Security "max-age=15552000; includeSubDomains"

  <Directory {{ parameter_dict['document-root'] }}>
      Options +FollowSymlinks
      AllowOverride All
      Require all granted
      SetEnv HOME {{ parameter_dict['document-root'] }}
      SetEnv HTTP_HOME {{ parameter_dict['document-root'] }}
      Dav off
  </Directory>

  ErrorLog "{{ parameter_dict['log-dir'] }}/lamp-error.log"
  CustomLog "{{ parameter_dict['log-dir'] }}/lamp-access.log" combined
</VirtualHost>
