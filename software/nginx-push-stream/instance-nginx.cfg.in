[buildout]
parts =
  nginx-service
  promises
  publish-connection-information

extends = ${monitor-template:rendered}

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[directory]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc
bin = $${buildout:directory}/bin
srv = $${buildout:directory}/srv
var = $${buildout:directory}/var
run = $${:var}/run
log = $${:var}/log
varnginx = $${:var}/nginx
services = $${:etc}/service
cron-entries = $${:etc}/cron.d
www = $${:srv}/www
ssl = $${:etc}/ssl

#################################
# Nginx service
#################################
[nginx-service]
recipe = slapos.cookbook:wrapper
wrapper-path = $${directory:services}/nginx
command-line =
  ${nginx-push-stream-output:nginx} -c $${nginx-configuration:output}

[nginx-configuration]
recipe = slapos.recipe.template
url = ${template-nginx-configuration:output}
output = $${directory:etc}/nginx.cfg
mode = 0600
access-log = $${directory:log}/nginx-access.log
error-log = $${directory:log}/nginx-error.log
ip = $${slap-network-information:global-ipv6}
local-ip = $${slap-network-information:local-ipv4}
port = 9443
publisher-location-prefix = /pub
publisher-push-stream-store-messages = off
publisher-client-max-body-size = 16k
publisher-client-body-buffer-size = 16k

subscriber-allow-origin = '*'
subscriber-location-prefix = /sub
# Prevent to use credential if origin is star
subscriber-allow-credential = 'false'
subscriber-allow-methods = 'GET, HEAD, OPTIONS'
subscriber-allow-headers = 'Authorization,Content-Type,Accept,Origin,User-Agent,DNT,Cache-Control,X-Mx-ReqToken,Keep-Alive,X-Requested-With,If-Modified-Since'
base-url = https://[$${nginx-configuration:ip}]:$${nginx-configuration:port}

# Generate a self-signed TLS certificate.
[nginx-certificate]
recipe = plone.recipe.command
command =
  if [ ! -e $${:key-file} ]
  then
    ${openssl:location}/bin/openssl req -x509 -nodes -days 3650 \
      -subj "/C=AA/ST=X/L=X/O=Dis/CN=$${nginx-configuration:ip}" \
      -newkey rsa:1024 -keyout $${:key-file} \
      -out $${:cert-file}
  fi
update-command = $${:command}
key-file = $${directory:ssl}/${:_buildout_section_name_}.key
cert-file = $${directory:ssl}/${:_buildout_section_name_}.cert
common-name = $${nginx-configuration:ip}
stop-on-error = true

[promises]
recipe =
promises =
  $${nginx-available-promise:recipe}

[nginx-available-promise]
<= monitor-promise-base
module = check_url_available
name = $${:_buildout_section_name_}.py
config-url = $${nginx-configuration:base-url}/status

[publish-connection-information]
recipe = slapos.cookbook:publish
publisher-url = $${nginx-configuration:base-url}$${nginx-configuration:publisher-location-prefix}
subscriber-url = $${nginx-configuration:base-url}$${nginx-configuration:subscriber-location-prefix}
