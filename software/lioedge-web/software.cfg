[buildout]
extends =
  ../../stack/monitor/buildout.cfg
  ../../stack/nodejs.cfg
  ../../component/nginx/buildout.cfg
  ../../component/openssl/buildout.cfg
  buildout.hash.cfg
  ../../stack/slapos.cfg

parts =
  slapos-cookbook
  nodejs-22.11.0
  lioedge-web-src
  lioedge-web-build
  template_nginx_conf
  template-cfg

[lioedge-web-src]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/Daetalus/lioedge-web.git
revision = ab23cbd45858abbd00e9fdce38397bc93a68558e
use-cache = true
# location defaults to ${buildout:parts-directory}/${:_buildout_section_name_}
# so it will be: ${buildout:parts-directory}/lioedge-web-src
# you need to create your own ~/.netrc with your access token

[lioedge-web-build]
recipe = slapos.recipe.build
dist = ${buildout:directory}/parts/${:_buildout_section_name_}/dist
install =
  import os, shutil, subprocess

  src = r"""${lioedge-web-src:location}"""
  env = os.environ.copy()
  env["PATH"] = r"""${nodejs-22.11.0:location}/bin""" + ":" + env.get("PATH", "")

  # Install dependencies from lockfile, then build
  subprocess.check_call(["npm", "ci", "--no-audit", "--fund=false"], cwd=src, env=env)
  subprocess.check_call(["npm", "run", "build"], cwd=src, env=env)

  # Export dist to a stable buildout location
  dist_src = os.path.join(src, "dist")
  dist_dst = os.path.join(location, "dist")

  if os.path.exists(location):
    shutil.rmtree(location)
  os.makedirs(location)
  shutil.copytree(dist_src, dist_dst)

  with open(os.path.join(location, "REVISION"), "w", encoding="utf-8") as f:
    f.write(r"""${lioedge-web-src:revision}""")

[template-cfg]
recipe = slapos.recipe.template:jinja2
url = ${:_profile_base_location_}/instance.cfg.in
output = ${buildout:directory}/template.cfg
context =
  raw monitor_template_cfg ${monitor-template:output}
  key nginx_location nginx:location
  key openssl_location openssl:location
  key nginx_conf_in template_nginx_conf:target
  key lioedge_web_dist lioedge-web-build:dist

  key eggs_directory buildout:eggs-directory
  key develop_eggs_directory buildout:develop-eggs-directory

[template_nginx_conf]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/templates/nginx.conf.in
destination = ${buildout:directory}/${:_buildout_section_name_}