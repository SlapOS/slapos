#!/bin/bash
#
# Create a backup of the disk image of the virtual machine
#
set -e
LC_ALL=C
export LC_ALL
BACKUP_DIR={{ directory['backup'] }}

log=$(mktemp)
trap "rm -f $log" EXIT TERM INT

set +e
qmpbackup="{{ qmpbackup }} --socket {{ socket_path }} backup --compress --target $BACKUP_DIR --include {{ device }}"
$qmpbackup --level auto > $log
RESULT=$?
cat $log
if [ $RESULT -ne 0 ] ; then
  if egrep -q 'Partial backup found in.*{{ device}}.*possible broken backup chain. Execute new full backup' $log ; then
    find $BACKUP_DIR/{{ device }} -name '*.qcow2.partial' -delete
    $qmpbackup --level auto || exit $?
    echo "Recovered from partial backup by removing partial"
  else
    exit $RESULT
  fi
fi
set -e


# as new style backup went find delete eventual old style backup
rm -f $BACKUP_DIR/virtual.qcow2{,.gz}

cd $BACKUP_DIR && find -type f ! -name backup.signature -print0 | xargs -0 sha256sum | LC_ALL=C sort -k 66 > backup.signature

