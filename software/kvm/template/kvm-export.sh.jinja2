#!/bin/bash
#
# Create a backup of the disk image of the virtual machine
#
set -e
LC_ALL=C
export LC_ALL
BACKUP_DIR={{ directory['backup'] }}

{{ qmpbackup }} --socket {{ socket_path }} backup --compress --level auto --target $BACKUP_DIR --include {{ device }}

# as new style backup went find delete eventual old style backup
rm -f $BACKUP_DIR/virtual.qcow2{,.gz}

cd $BACKUP_DIR && find -type f ! -name backup.signature -print0 | xargs -0 sha256sum | LC_ALL=C sort -k 66 > backup.signature

