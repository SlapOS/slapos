[buildout]
extends =
  ../../stack/slapos.cfg
  ../../component/java/buildout.cfg
  ../../component/embulk/buildout.cfg

parts =
  slapos-cookbook
  instance-profile
  java
  embulk
  embulkPlugins

[jinja-template]
recipe = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/${:filename}
mode = 0644

[instance-profile]
recipe = slapos.recipe.template:jinja2
md5sum = aa74da73dd13095098a6f15e2184cc2b
template = ${:_profile_base_location_}/instance.cfg.in
rendered = ${buildout:directory}/instance.cfg
mode = 0644
extensions = jinja2.ext.do
context =
  section buildout  buildout
  key embulk_location embulk:location
  key java_location java:location
  key embulkPlugins_location embulkPlugins:location

[java]
<= java-re-8

[embulkPlugins]
recipe = slapos.recipe.build
install =
  import os
  bin_dir = os.path.join(location, 'bin')
  os.makedirs(bin_dir)
  os.chdir("parts/embulkPlugins")
  call(["${java:location}/bin/java", "-jar", "${embulk:location}/embulk.jar",
          "mkbundle", "plugins"])
  os.chdir("plugins")
  f = open('Gemfile', 'w')
  f.write("source 'https://rubygems.org/'\n")
  f.write("gem 'embulk'\n")
  f.write("gem 'embulk-input-filename'\n")
  f.write("gem 'embulk-output-wendelin'\n")
  f.write("gem 'embulk-parser-none-bin'\n")
  f.write("gem 'embulk-formatter-single_value'\n")
  f.close()
  call(["${java:location}/bin/java", "-jar", "${embulk:location}/embulk.jar", "bundle"])

[versions]
slapos.recipe.template = 4.4
rubygemsrecipe  = 0.2.2
java = 8
