[buildout]
extends =
  ../../component/bash/buildout.cfg
  ../../component/openssl/buildout.cfg
  ../../component/curl/buildout.cfg
  ../../stack/slapos.cfg
  ../../stack/monitor/buildout.cfg
  ./buildout.hash.cfg

parts =
  slapos-cookbook
  eggs
  template-instance

allow-picked-versions = true

[eggs]
recipe = zc.recipe.egg
eggs =
  caucase
  kedifa
scripts =
  caucase
  caucase-probe
  caucase-updater
  caucase-rerequest
  caucase-key-id

[git-clone-base]
recipe = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git
branch = master

[dehydrated]
<= git-clone-base
repository = https://github.com/dehydrated-io/dehydrated.git
revision = v0.7.1

[kedifa]
<= git-clone-base
repository = https://lab.nexedi.com/nexedi/kedifa.git
revision = 7f6bdd71

[download-template]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/${:filename}

[template-instance]
recipe = slapos.recipe.template:jinja2
output = ${buildout:directory}/instance.cfg
url = ${:_profile_base_location_}/${:filename}
context =
    key bash_location bash:location
    key bin_directory buildout:bin-directory
    key buildout_egg_directory buildout:eggs-directory
    key buildout_develop_directory buildout:develop-eggs-directory
    key buildout_directory buildout:directory
    key curl_location bash:location
    key dehydrated_location dehydrated:location
    key kedifa_location kedifa:location
    key openssl_location openssl:location
    key template_monitor_cfg monitor2-template:output
    key template_autocert template-autocert:target
    key template_signcert template-sign-certificate.sh:target
    key template_dehydrated_config template-dehydrated-config:target

[template-autocert]
<= download-template
output = ${buildout:directory}/instance-autocert.cfg.jinja2

[template-dehydrated-config]
<= download-template

[template-sign-certificate.sh]
<= download-template

[versions]
caucase = 0.9.15
kedifa = 0.0.6
pem = 21.1.0
PyJWT = 2.7.0
