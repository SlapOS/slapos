{#- Package ru/aw2s/libinstance provides instance code for handling AW2S Radio Units. #}

{%- macro buildout_swallow(iru_dict, icell_dict)  %}

[swallow.xml]
<= config-base
url = {{ ru_aw2s_swallow_xml_template }}
output = ${directory:etc}/swallow.xml
extra-context =
  key iru_dict       :iru_dict
  key icell_dict     :icell_dict
  import json_module json
iru_dict       = {{ dumps(iru_dict) }}
icell_dict     = {{ dumps(icell_dict) }}
import-list =
  rawfile slaplte.jinja2 {{ slaplte_template }}

[rmu.xml]
<= config-base
url = {{ ru_aw2s_rmu_xml_template }}
output = ${directory:etc}/rmu.xml
extra-context =
  key iru_dict       :iru_dict
  key icell_dict     :icell_dict
iru_dict       = {{ dumps(iru_dict) }}
icell_dict     = {{ dumps(icell_dict) }}

{%- endmacro  %}

{%- macro buildout()  %}

[enb-sh-wrapper]
recipe = slapos.recipe.template
output = ${directory:bin}/${:_buildout_section_name_}
enb-log = ${directory:log}/enb-output.log
inline =
  #!/bin/sh
{% if not testing %}
  sudo -n /opt/amarisoft/rm-tmp-lte;
  sudo -n /opt/amarisoft/init-enb;
  (echo && echo && date "+[%Y/%m/%d %T.%N %Z] Starting eNB software..." && echo) >> ${:enb-log};
  tail -c 1M ${:enb-log} > ${:enb-log}.tmp;
  mv ${:enb-log}.tmp ${:enb-log};
  sudo -n {{ enb }}/lteenb ${directory:etc}/enb.cfg >> ${:enb-log} 2>> ${:enb-log};
{% endif %}

{%- endmacro  %}

{%- macro buildout_iru(iru, icell_list)  %}
{%- endmacro  %}
