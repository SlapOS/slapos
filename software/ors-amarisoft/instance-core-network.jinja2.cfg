{%- set dns_slave_instance_list = [] %}
{%- for slave in slave_instance_list %}
{%-   set slave_parameters = json_module.loads(slave['_']) %}
{%-   if slave_parameters.get('subdomain', '') != '' %}
{%-     do dns_slave_instance_list.append(slave) %}
{%-   endif %}
{%- endfor %}

{% set part_list = [] -%}

{%- for slave in dns_slave_instance_list %}
{%    set slave_reference = slave.get('slave_reference', '') %}
{%    set publish_section_title = 'publish-%s' % slave_reference %}
{%    do part_list.append(publish_section_title) %}
[{{ publish_section_title }}]
recipe = slapos.cookbook:publish.serialised
-slave-reference = {{ slave_reference }}
domain = nexedi.com
ip = xxx
info = XXX
{%- endfor %}

[buildout]
parts =
  directory
{% for part in part_list -%}
{{ '  %s' % part }}
{% endfor %}

eggs-directory = {{ eggs_directory }}
develop-eggs-directory = {{ develop_eggs_directory }}
offline = true

[slap-configuration]
recipe = slapos.cookbook:slapconfiguration.serialised
computer = {{ slap_connection['computer-id'] }}
partition = {{ slap_connection['partition-id'] }}
url = {{ slap_connection['server-url'] }}
key = {{ slap_connection['key-file'] }}
cert = {{ slap_connection['cert-file'] }}

[directory]
recipe = slapos.cookbook:mkdirectory
software = {{ buildout_directory }}
home = ${buildout:directory}
etc = ${:home}/etc
var = ${:home}/var
bin = ${:home}/bin
tmp = ${:home}/tmp
run = ${:var}/run
script = ${:etc}/run
service = ${:etc}/service
promise = ${:etc}/promise
log = ${:var}/log
