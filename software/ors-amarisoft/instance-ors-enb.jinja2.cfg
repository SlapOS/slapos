{#- XXX automatically load this from schema #}
{%- set ors_lte_defaults = {
  "bandwidth": "20 MHz",
  "n_antenna_dl": 2,
  "n_antenna_ul": 2,
  "rf_mode": "tdd",
  "tdd_ul_dl_config": "[Configuration 2] 5ms 2UL 6DL (default)",
  "pci": 1,
  "cell_id": "0x01",
  "tac": "0x0001",
  "root_sequence_index": 204,
  "enb_id": "0x1A2D0",
  "gtp_addr": "127.0.1.1",
  "lte_handover_a3_offset": 6,
  "lte_handover_a3_time_to_trigger": 480,
  "inactivity_timer": 10000,
  "disable_sdr": false
} %}

{%- for k,v in ors_lte_defaults|dictsort %}
{%-   do slapparameter_dict.setdefault(k, v) %}
{%- endfor %}

{# inject ru/cell shared instances synthesized from ORS-specific parameters
   make real ru/cell shared instances to be rejected #}
{%- set ishared_list = slap_configuration.setdefault('slave-instance-list', [])  %}
{%- for ishared in ishared_list %}
{%-   set _ = json_module.loads(ishared['_']) %}
{%-   if 'ru_type' in _  or  'cell_type' in _ %}
{%-     do ishared.update({'_': {'REJECT': 1}|tojson})  %}
{%-   endif %}
{%- endfor  %}

{%- do ishared_list.append({
    'slave_title':      '%s_RU' % slap_configuration['slap-computer-partition-id'],
    'slave_reference':  'XXX',
    '_': {
      'ru_type':      'sdr',
      'ru_link_type': 'sdr',
      'sdr_dev_list': [0],
      'n_antenna_dl': slapparameter_dict.n_antenna_dl,
      'n_antenna_ul': slapparameter_dict.n_antenna_ul,
      'tx_gain':      ors_version['current-tx-gain'],
      'rx_gain':      ors_version['current-rx-gain'],
      'txrx_active':  'ACTIVE',
    } |tojson
  })
%}

{%- do ishared_list.append({
    'slave_title':      '%s_CELL' % slap_configuration['slap-computer-partition-id'],
    'slave_reference':  'XXX',
    '_': {
      'cell_type':  'lte',
      'rf_mode':    slapparameter_dict.rf_mode,
      'pci':        slapparameter_dict.pci,
      'cell_id':    slapparameter_dict.cell_id,
      'root_sequence_index':  slapparameter_dict.root_sequence_index,
      'ru': {
        'ru_type':  'ru_ref',
        'ru_ref':   'RU',
      },
      'tdd_ul_dl_config': slapparameter_dict.tdd_ul_dl_config,
      'bandwidth':  slapparameter_dict.bandwidth,
      'dl_earfcn':  ors_version['current-earfcn'],
      'tac':        slapparameter_dict.tac,
      'inactivity_timer': slapparameter_dict.inactivity_timer,
    } |tojson
  })
%}

{%- include 'instance-enb-base.jinja2.cfg' %}


[enb-config]
extra-context +=
  json ors {{ ors_version | tojson }}

# XXX config-base +=
# XXX reenable/rethink
# raw nr_arfcn {{ ors_version['current-nr-arfcn'] }}
# raw nr_band {{ ors_version['current-nr-band'] }}


# add ORS-specific bits to published information
[publish-connection-information]
ors-version = {{ ors_version['ors-version'] }}
frequency-range-rating = {{ ors_version['range'] }}
current-tx-power-estimate = {{ ors_version['power-estimate'] }}
current-tx-gain = {{ ors_version['current-tx-gain'] }}
current-rx-gain = {{ ors_version['current-rx-gain'] }}

# XXX hide ru-list and cell-list ?

# XXX only enb
current-earfcn  = {{ ors_version['current-earfcn'] }}

# XXX only gnb
current-nr-arfcn = {{ ors_version['current-nr-arfcn'] }}
current-nr-band = {{ ors_version['current-nr-band'] }}
