[buildout]
parts =
  publish-connection-parameter

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true


[publish-connection-parameter]
recipe = slapos.cookbook:publish
url = https://[$${sfu-wrapper:ip}]:$${sfu-wrapper:port}
admin-user = $${admin-password:username}
admin-password = $${admin-password:passwd}

[slap-configuration]
recipe = slapos.cookbook:slapconfiguration
computer = $${slap-connection:computer-id}
partition = $${slap-connection:partition-id}
url = $${slap-connection:server-url}
key = $${slap-connection:key-file}
cert = $${slap-connection:cert-file}

[directory]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc
var = $${buildout:directory}/var
srv = $${buildout:directory}/srv
bin = $${buildout:directory}/bin
tmp = $${buildout:directory}/tmp
run = $${:var}/run

services   = $${:etc}/service
data       = $${:srv}/data
groups     = $${:srv}/groups
recordings = $${:srv}/recordings

[sfu-ssl]
recipe = plone.recipe.command
cert-file = $${directory:data}/cert.pem
key-file = $${directory:data}/key.pem
command = ${openssl:location}/bin/openssl req -newkey rsa:2048 -batch -new -x509  -days 3650 -nodes -keyout "$${:key-file}" -out "$${:cert-file}"
update-command =
stop-on-error = true

[admin-password]
recipe = slapos.cookbook:generate.password
storage-path = $${directory:data}/.passwd
username = admin

[ice-servers.json]
recipe = collective.recipe.template
input = inline:
  [{"urls":["stun:stun.l.google.com:19302"]}]
output = $${directory:data}/ice-servers.json

[groups-json]
recipe = collective.recipe.template
input = inline:{
    "public":true,
    "op":[{"username":"$${admin-password:username}","password":"$${admin-password:passwd}"}],
    "presenter":[{}],
    "max-users":100
  }
output = $${directory:groups}/public.json

[install-static]
recipe = plone.recipe.command
static = $${directory:srv}/static
command =
  cp -ax ${sfu-repository:location}/static $${:static}
  echo "$${admin-password:username}:$${admin-password:passwd}" > $${directory:data}/passwd
update-command = $${:command}
stop-on-error = true

[sfu-wrapper]
recipe = slapos.cookbook:wrapper
port = 8443
ip = $${slap-configuration:ipv6-random}
command-line = 
  ${sfu:location}/bin/sfu
    -static $${install-static:static}
    -recordings $${directory:recordings}
    -groups $${directory:groups}
    -data $${directory:data}
    -http [$${:ip}]:$${:port}
wrapper-path = $${directory:services}/sfu
depends =
  $${ice-servers.json:recipe}
  $${groups-json:recipe}
  $${sfu-ssl:recipe}

