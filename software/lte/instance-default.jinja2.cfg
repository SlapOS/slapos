#
# Deploy LTE instance
#
[buildout]
parts =
  directory
  lte-enb-request
  lte-epc-request
  lte-ims-request
  monitor-base
  publish-connection-information

extends = {{ monitor_template }}

eggs-directory = {{ eggs_directory }}
develop-eggs-directory = {{ develop_eggs_directory }}
offline = true

[instance]
recipe = slapos.cookbook:slapconfiguration.serialised
computer = {{ slap_connection['computer-id'] }}
partition = {{ slap_connection['partition-id'] }}
url = {{ slap_connection['server-url'] }}
key = {{ slap_connection['key-file'] }}
cert = {{ slap_connection['cert-file'] }}

[directory]
recipe = slapos.cookbook:mkdirectory
software = {{ buildout_directory }}
home = ${buildout:directory}
etc = ${:home}/etc
var = ${:home}/var
etc = ${:home}/etc
bin = ${:home}/bin
run = ${:var}/run
script = ${:etc}/run
service = ${:etc}/service
promise = ${:etc}/promise
log = ${:var}/log

[request-common-base]
recipe = slapos.cookbook:request.serialised
software-url = {{ slap_connection['software-release-url'] }}
server-url = {{ slap_connection['server-url'] }}
computer-id = {{ slap_connection['computer-id'] }}
partition-id = {{ slap_connection['partition-id'] }}
key-file = {{ slap_connection['key-file'] }}
cert-file = {{ slap_connection['cert-file'] }}

{% if slapparameter_dict.get("log", None) %}
config-log = {{ dumps(slapparameter_dict["log"]) }}
{% endif %}

{% if slapparameter_dict.get("license_key_path", None) %}
config-license_key_path = {{ dumps(slapparameter_dict["license_key_path"]) }}
{% endif %}

config-monitor-password = ${monitor-htpasswd:passwd}
return = monitor-base-url

[lte-epc-request]
<= request-common-base
name = EPC
software-type = epc
config-name = epc

[lte-enb-request]
<= request-common-base
name = eNB
software-type = enb
config-name = enb

{% if slapparameter_dict.get("gtp_addr", None) %}
config-gtp_addr = {{ dumps(slapparameter_dict["gtp_addr"]) }}
{% endif %}

{% if slapparameter_dict.get("rf_params", None) %}
config-rf_params = {{ dumps(slapparameter_dict["rf_params"]) }}
{% endif %}

{% if slapparameter_dict.get("cell_list", None) %}
config-cell_list = {{ dumps(slapparameter_dict["cell_list"]) }}
{% endif %}

{% if slapparameter_dict.get("ue_db_path", None) %}
config-ue_db_path = {{ dumps(slapparameter_dict["ue_db_path"]) }}
{% endif %}

[lte-ims-request]
<= request-common-base
name = IMS
software-type = ims
config-name = ims

{% if slapparameter_dict.get("ue_db_path", None) %}
config-ue_db_path = {{ dumps(slapparameter_dict["ue_db_path"]) }}
{% endif %}

[monitor-base-url-dict]
lte-epc-request =  ${lte-epc-request:connection-monitor-base-url}
lte-enb-request =  ${lte-enb-request:connection-monitor-base-url}
lte-ims-request =  ${lte-ims-request:connection-monitor-base-url}

[publish-connection-information]
recipe = slapos.cookbook:publish
monitor-setup-url = https://monitor.app.officejs.com/#page=settings_configurator&url=${monitor-publish-parameters:monitor-url}&username=${monitor-publish-parameters:monitor-user}&password=${monitor-publish-parameters:monitor-password}
