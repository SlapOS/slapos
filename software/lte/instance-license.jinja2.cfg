#
# Deploy LTE instance
#
[buildout]
parts =
  directory
  publish-connection-information
  lte-license-config
  lte-license-service
  monitor-base

extends = {{ monitor_template }}

eggs-directory = {{ eggs_directory }}
develop-eggs-directory = {{ develop_eggs_directory }}
offline = true

[instance]
recipe = slapos.cookbook:slapconfiguration
computer = {{ slap_connection['computer-id'] }}
partition = {{ slap_connection['partition-id'] }}
url = {{ slap_connection['server-url'] }}
key = {{ slap_connection['key-file'] }}
cert = {{ slap_connection['cert-file'] }}
configuration.licenses =


[lte-config]
# use configuration for current instance
#mme_ws_port = ${instance:port_1}
#mbms_ws_port = ${instance:port_2}
#enb_ws_port = ${instance:port_3}
#ims_ws_port = ${instance:port_4}

#mme_addr = ${instance:ipv4_local_1}
#ims_addr = ${instance:ipv4_local_2}
#ims_bind = ${instance:ipv4_local_3}
#mbms_addr = ${instance:ipv4_local_4}
#mbms_bind = ${instance:ipv4_local_5}
#enb_addr = ${instance:ipv4_local_6}

#mbms_multicast_addr = ${instance:ipv4_multicast_1}
#mbms_multicast_port = ${instance:port_5}


[directory]
recipe = slapos.cookbook:mkdirectory
software = {{ buildout_directory }}
home = ${buildout:directory}
etc = ${:home}/etc
var = ${:home}/var
etc = ${:home}/etc
run = ${:var}/run
script = ${:etc}/run
service = ${:etc}/service
promise = ${:etc}/promise
log = ${:var}/log


### LICENSE
[lte-license-service]
recipe = slapos.cookbook:wrapper
command-line = {{ license }}/ltelicense_server ${directory:etc}/license.cfg
input = ${directory:run}/license.sock
wrapper-path = ${directory:service}/lte-license
mode = 0775
pidfile = ${directory:run}/license.pid

[lte-license-config]
recipe = slapos.recipe.template:jinja2
template = ${directory:software}/config/license.jinja2.cfg
rendered = ${directory:etc}/license.cfg
mode = 0664
extensions = jinja2.ext.do
context =
  section directory directory
  section instance instance

[publish-connection-information]
recipe = slapos.cookbook:publish
url = ${instance:ipv6-random}:9050
monitor-setup-url = https://monitor.app.officejs.com/#page=settings_configurator&url=${monitor-publish-parameters:monitor-url}&username=${monitor-publish-parameters:monitor-user}&password=${monitor-publish-parameters:monitor-password}
