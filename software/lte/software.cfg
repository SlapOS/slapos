[buildout]
extends =
  buildout.hash.cfg
  ../../stack/slapos.cfg
  ../../stack/monitor/buildout.cfg
  ../../component/logrotate/buildout.cfg
  ../../component/gzip/buildout.cfg
  ../../component/msgpack-python/buildout.cfg
  ../../component/cython-zstd/buildout.cfg
  ../../component/python-mysqlclient/buildout.cfg
  ../../component/python-mysqlclient/buildout.cfg
  ../../component/nghttp2/buildout.cfg

parts +=
  template
  slapos-cookbook
  python-with-eggs
  monitor2-template
  ltelogs.jinja2.sh
# copy all configs by default
  mme.jinja2.cfg
  ims.jinja2.cfg
  enb.jinja2.cfg
# sdr driver is dependent on ENB thus should be added explicitely by software.cfg
  sdr-driver
# unimplemented parts - the http monitor and better log handling using logrotate
#  apache-php
#  logrotate
  gzip

[ue_db.py.in]
recipe = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/${:filename}
rendered = ${buildout:directory}/bin/neouedb
mode = 0755
context = 
  key python python-with-eggs:interpreter
  key directory buildout:directory

[template]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/template.cfg
mode = 0644

[download-base]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:_update_hash_filename_}
mode = 0644

[template-lte-default]
<= download-base

[template-lte-enb]
<= download-base

[template-lte-mme]
<= download-base

[template-lte-ims]
<= download-base

[neoppod-repository]
recipe = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/nexedi/neoppod.git
git-executable = ${git:location}/bin/git

[neoppod-setup-env]
PATH = ${git:location}/bin:%(PATH)s

[neoppod-develop]
recipe = zc.recipe.egg:develop
setup = ${neoppod-repository:location}
environment = neoppod-setup-env

[python-with-eggs]
recipe = zc.recipe.egg
interpreter = ${:_buildout_section_name_}
eggs =
  neoppod[client]
  BTrees
  ZODB

[amarisoft]
recipe = slapos.recipe.build
path = /opt/amarisoft/
init = 
  import os
  options['lte-version'] = os.readlink("%(path)s/lte" % options)[:-1]

[copy-to-instance]
recipe  = slapos.recipe.build:download
url     = ${:_profile_base_location_}/${:_buildout_section_name_}

[copy-config-to-instance]
recipe  = slapos.recipe.build:download
url     = ${:_profile_base_location_}/config/${:_buildout_section_name_}

[unpack-to-instance]
recipe = slapos.recipe.build:download-unpacked
url = ${amarisoft:path}/${amarisoft:lte-version}/lte${:_buildout_section_name_}-linux-${amarisoft:lte-version}.tar.gz
destination = ${buildout:directory}/${:_buildout_section_name_}
strip-top-level-dir = true
ignore-existing = true
on-update = true

[enb]
<= unpack-to-instance
md5sum = ${lteenb-linux:md5sum}

[mme]
<= unpack-to-instance
md5sum = ${ltemme-linux:md5sum}

[enb.jinja2.cfg]
<= copy-config-to-instance
filename = enb.jinja2.cfg
[ltelogs.jinja2.sh]
<= copy-to-instance
filename = ltelogs.jinja2.sh
[mme.jinja2.cfg]
<= copy-config-to-instance
filename = mme.jinja2.cfg
[ims.jinja2.cfg]
<= copy-config-to-instance
filename = ims.jinja2.cfg

[md5sum]
enb = ${enb.jinja2.cfg:md5sum}
mme = ${mme.jinja2.cfg:md5sum}
ims = ${ims.jinja2.cfg:md5sum}

[sdr]
<= unpack-to-instance
url = ${amarisoft:path}/${amarisoft:lte-version}/trx_${:_buildout_section_name_}-linux-${amarisoft:lte-version}.tar.gz
destination = ${enb:destination}/x86_64
md5sum = ${trx_sdr-linux:md5sum}

[lms]
<= unpack-to-instance
url = ${amarisoft:path}/${amarisoft:lte-version}/trx_${:_buildout_section_name_}-linux-${amarisoft:lte-version}.tar.gz
destination = ${enb:destination}/x86_64
md5sum = ${trx_lms-linux:md5sum}

[sdr-driver]
# move trx_sdr.so next to lteenb binary
recipe  = slapos.recipe.build:download
url = ${sdr:destination}/trx_sdr.so
destination = ${enb:destination}/trx_sdr.so
#md5sum = 16cd39307bc85c17dcb7ff05157e2cff

[enb]
<= unpack-to-instance
md5sum = ${lteenb-linux:md5sum}
[mme]
<= unpack-to-instance
md5sum = ${ltemme-linux:md5sum}

[lteenb-linux]
filename = ${amarisoft:lte-version}/lteenb-linux-${amarisoft:lte-version}.tar.gz
md5sum = 842b1526073472a30cb0b286d3b1528c
[ltemme-linux]
filename = ${amarisoft:lte-version}/ltemme-linux-${amarisoft:lte-version}.tar.gz
md5sum = 9d7917f90c7c7b2a8ba624d874595351
[ltewww-linux]
filename = ${amarisoft:lte-version}/ltewww-linux-${amarisoft:lte-version}.tar.gz
md5sum = 416b6167f70b12910fbbb9293038554c
[trx_sdr-linux]
filename = ${amarisoft:lte-version}/trx_sdr-linux-${amarisoft:lte-version}.tar.gz
md5sum = e6960e3460f1a32c2436f36b2082995d

# this archive contains symbolic links
#[www]
#<= unpack-to-instance
#url = ${amarisoft:path}/ltewww-linux-${amarisoft:lte-version}.tar.gz

[versions]
apache-libcloud = 2.2.1
gitdb2 = 2.0.3
slapos.recipe.template = 4.2
smmap2 = 2.0.3
BTrees = 4.5.0:whl
ZODB = 5.4.0
cython-zstd = 0.2
msgpack-python = 0.5.6
mysqlclient = 1.3.12
neoppod = 1.9
persistent = 4.2.4.2
transaction = 2.2.1
zeodbpickle = 1.0.1
ZODB3 = 3.11.0
zodbpickle = 1.0.4
ZEO = 5.2.2


# Required by:
# ZODB==5.4.0
ZConfig = 3.2.0

# Required by:
# neoppod==1.9
python-dateutil = 2.7.3:whl

# Required by:
# ZODB==5.4.0
zc.lockfile = 1.3.0

# Required by:
# ZEO==5.2.2
# trollius==2.2.post1
futures = 3.3.0

# Required by:
# ZEO==5.2.2
trollius = 2.2.post1

