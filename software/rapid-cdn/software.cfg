[buildout]
extends =
  buildout.hash.cfg
  ../../stack/caucase/buildout.cfg
  ../../stack/slapos.cfg
  ../../component/haproxy/buildout.cfg
  ../../component/nginx/buildout.cfg
  ../../component/python3/buildout.cfg
  ../../component/rsyslogd/buildout.cfg
  ../../component/trafficserver/buildout.cfg

parts +=
  template

[python]
part = python3

# HACK STARTs
#Traceback (most recent call last):
#  File "<SLAPOS>/parts/python2.7/lib/python2.7/multiprocessing/process.py", line 267, in _bootstrap
#    self.run()
#  File "<SLAPOS>/eggs/slapos.core-1.6.19-py2.7.egg/slapos/grid/promise/__init__.py", line 177, in run
#    promise_module = self._loadPromiseModule()
#  File "<SLAPOS>/eggs/slapos.core-1.6.19-py2.7.egg/slapos/grid/promise/__init__.py", line 213, in _loadPromiseModule
#    promise_module = importlib.import_module(os.path.splitext(self.name)[0])
#  File "<SLAPOS>/parts/python2.7/lib/python2.7/importlib/__init__.py", line 37, in import_module
#    __import__(name)
#  File "<PARTITION>/etc/plugin/<PLUGIN<.py", line 78, in <module>
#    from slapos.promise.plugin.check_url_available import RunPromise
#  File "<SOFTWARE>/eggs/slapos.toolbox-0.126-py3.7.egg/slapos/promise/plugin/check_url_available.py", line 19, in <module>
#    from slapos.grid.promise import interface
#  File "<SOFTWARE>/eggs/slapos.core-1.7.1-py3.7.egg/slapos/grid/promise/__init__.py", line 47, in <module>
#    from slapos.util import str2bytes, mkdir_p, chownDirectory, listifdir
#  File "<SOFTWARE>/eggs/slapos.core-1.7.1-py3.7.egg/slapos/util.py", line 42, in <module>
#    import jsonschema
#  File "<SOFTWARE>/eggs/jsonschema-3.0.2-py3.7.egg/jsonschema/__init__.py", line 12, in <module>
#    from jsonschema.exceptions import (
#  File "<SOFTWARE>/eggs/jsonschema-3.0.2-py3.7.egg/jsonschema/exceptions.py", line 8, in <module>
#    from jsonschema import _utils
#  File "<SOFTWARE>/eggs/jsonschema-3.0.2-py3.7.egg/jsonschema/_utils.py", line 6, in <module>
#    from jsonschema.compat import MutableMapping, str_types, urlsplit
#  File "<SOFTWARE>/eggs/jsonschema-3.0.2-py3.7.egg/jsonschema/compat.py", line 44, in <module>
#    from functools32 import lru_cache
#ImportError: No module named functools32
[slapos-cookbook-dependencies]
eggs += functools32
# HACK ENDs
[template-render-base]
recipe = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/${:_update_hash_filename_}
rendered = ${buildout:directory}/${:_buildout_section_name_}.cfg
mode = 0644
context =
  section software_parameter_dict software-parameter-section
  ${:extra-context}
extra-context =

[template]
<= template-render-base

[template-common]
<= template-render-base

[template-download-base]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:_update_hash_filename_}

[template-rapid-cdn-frontend]
<= template-download-base

[template-rapid-cdn-human]
<= template-download-base

[template-rapid-cdn-pop]
<= template-download-base

[template-rapid-cdn-kedifa]
<= template-download-base

[template-rapid-cdn-log-aggregator]
<= template-download-base

[template-front-haproxy]
<= template-download-base

[template-front-rsyslogd]
<= template-download-base

[kedifa]
recipe = zc.recipe.egg
eggs =
  ${python-cryptography:egg}
  kedifa

[software-parameter-section]
# This section passes binaries and other software provided outputs to all
# profiles. In the same time allows to gather all parameters in one place.

# Buildout parameters
bin-directory = ${buildout:bin-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
eggs-directory = ${buildout:eggs-directory}

# Software
caucase = ${caucase-eggs:bin-directory}/caucase
caucase-probe = ${caucase-eggs:bin-directory}/caucase-probe
caucase-updater = ${caucase-eggs:bin-directory}/caucase-updater
caucased = ${caucase-eggs:bin-directory}/caucased
dash = ${dash-output:dash}
haproxy = ${haproxy:location}/sbin/haproxy
kedifa = ${kedifa:bin-directory}/kedifa
kedifa-updater = ${kedifa:bin-directory}/kedifa-updater
nginx = ${nginx-output:nginx}
nginx_mime = ${nginx-output:mime}
openssl = ${openssl:location}/bin/openssl
openssl-cnf = ${openssl:location}/etc/ssl/openssl.cnf
rsyslogd = ${rsyslogd:location}/sbin/rsyslogd
trafficserver = ${trafficserver:location} {#- XXX: Fix to expose exact binaries #}

# Libraries
caucase-jinja2-library = ${caucase-jinja2-library:target}

# Templates
template-common = ${template-common:rendered}
template-front-haproxy = ${template-front-haproxy:target}
template-front-rsyslogd = ${template-front-rsyslogd:target}
template-monitor2 = ${monitor2-template:rendered}
template-rapid-cdn-frontend = ${template-rapid-cdn-frontend:target}
template-rapid-cdn-human = ${template-rapid-cdn-human:target}
template-rapid-cdn-kedifa = ${template-rapid-cdn-kedifa:target}
template-rapid-cdn-log-aggregator = ${template-rapid-cdn-log-aggregator:target}
template-rapid-cdn-pop = ${template-rapid-cdn-pop:target}

[versions]
kedifa = 0.0.6
# modernish zc.lockfile is required by kedifa
zc.lockfile = 1.4
