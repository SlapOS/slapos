# Trafficserver introspection configuration
daemon off;
pid {{ parameter_dict['pid'] }};
error_log {{ parameter_dict['error-log'] }};

events {
}

http {
  include {{ parameter_dict['nginx-mime'] }};
  auth_basic "TrafficServer Introspection Index {{ parameter_dict['introspection-identification'] }}";
  auth_basic_user_file {{ parameter_dict['htpasswd-path'] }};
  server {
    server_name_in_redirect off;
    port_in_redirect off;
    error_log {{ parameter_dict['error-log'] }};
    access_log {{ parameter_dict['access-log'] }};
    listen [{{ parameter_dict['global-ipv6'] }}]:{{ parameter_dict['https-port'] }} ssl;
    listen {{ parameter_dict['local-ipv4'] }}:{{ parameter_dict['https-port'] }} ssl;
    ssl_certificate {{ parameter_dict['ip-access-certificate'] }};
    ssl_certificate_key {{ parameter_dict['ip-access-certificate'] }};
    default_type application/octet-stream;
    client_body_temp_path {{ parameter_dict['var'] }} 1 2;
    proxy_temp_path {{ parameter_dict['var'] }} 1 2;
    fastcgi_temp_path {{ parameter_dict['var'] }} 1 2;
    uwsgi_temp_path {{ parameter_dict['var'] }} 1 2;
    scgi_temp_path {{ parameter_dict['var'] }} 1 2;
    location / {
      alias {{ root }}/;
      autoindex on;
    }
{%- for location in parameter_dict['inspect-list'].splitlines() %}
    location {{ location }} {
      proxy_pass {{ parameter_dict['trafficserver-url-root'] }}{{ location }};
      proxy_ssl_verify on;
      proxy_ssl_trusted_certificate {{ parameter_dict['ca-certificate'] }};
      proxy_ssl_name {{ parameter_dict['trafficserver-certificate-common-name'] }};
      proxy_ssl_crl {{ parameter_dict['crl-list'] }};
    }
{%- endfor %}
  }
}
