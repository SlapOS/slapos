[directory]
recipe = slapos.cookbook:mkdirectory
home = ${buildout:directory}
etc = ${:home}/etc
var = ${:home}/var
script = ${:etc}/run
service = ${:etc}/service
promise = ${:etc}/promise
log = ${:var}/log
data = ${:var}/lib

[slap-configuration]
recipe = slapos.cookbook:slapconfiguration
computer = ${slap-connection:computer-id}
partition = ${slap-connection:partition-id}
url = ${slap-connection:server-url}
key = ${slap-connection:key-file}
cert = ${slap-connection:cert-file}

[instance-parameter]
<= slap-configuration
# repman monitor seems to use a fixed port
repman-port = 10005


[repman]
recipe   = slapos.cookbook:mkdirectory
etc      = ${directory:etc}/repman
data-dir = ${directory:var}/lib
root-dir = ${directory:srv}/repman

[repman-password]
recipe = slapos.cookbook:generate.password
bytes = 12

[repman-parameter]
log = ${directory:log}/repman.log
http-root = ${repman:root-dir}/dashboard
share-dir = ${repman:root-dir}/share
port = ${instance-parameter:repman-port}
ipv6 = ${instance-parameter:ipv6-random}
username = admin
password = ${repman-password:passwd}

[repman-config-folder]
recipe = plone.recipe.command
repman-location = {{ repman_src_location }}
command = 
  cd ${:repman-location}
  cp -r share ${repman-parameter:share-dir}
  cp -r dashboard ${repman-parameter:http-root}

# XXX - this need to be checked/optimized in case of upgrade.
update-command =
  

[replication-manager]
recipe = slapos.cookbook:wrapper
command-line =
   {{ gowork_bin }}/replication-manager
   --monitoring-basedir=${repman:root-dir}
   --monitoring-sharedir=${repman-parameter:share-dir}
   --http-root=${repman-parameter:http-root}
   --monitoring-datadir=${repman:data-dir}
   --config=${repman-config.toml:rendered}
   --log-file=${repman-parameter:log}
   monitor

wrapper-path = ${directory:service}/replication-manager
# setup repman instance folder
depends =
  ${repman-config-folder:recipe}


[repman-config.toml]
recipe = slapos.recipe.template:jinja2
template = {{ config_toml_in }}
rendered = ${repman:etc}/config.toml
extra-context =
context =
  section parameter_dict repman-parameter


[repman-listen-promise]
<= monitor-promise-base
module = check_port_listening
name = repman_service_listen.py
config-hostname = ${repman-parameter:ipv6}
config-port = ${repman-parameter:port}


[publish-connection-parameter]
<= monitor-publish
recipe = slapos.cookbook:publish
url = https://[${repman-parameter:ipv6}]:${repman-parameter:port}
username = ${repman-parameter:username}
password = ${repman-parameter:password}


#############################
#
# Deploy replication-manager instance
#
#############################
[buildout]
extends =
  {{ template_monitor_cfg }}
parts =
  replication-manager
  repman-listen-promise
  monitor-base
  publish-connection-parameter


eggs-directory = {{ eggs_directory }}
develop-eggs-directory = {{ develop_eggs_directory }}
offline = true
