#!/bin/bash

set -e

curl () {
  {{ curl_bin }} -k --silent -H "Accept: application/json" "$@"
}

get_token () {
  curl -s -X POST --data '{"username":"{{ username }}","password":"{{ password}}"}' {{ secure_url }}/api/login
}

run_mysql () {
  {{ mysql_bin }} --defaults-file="{{ mysql_conf }}" --protocol=socket "$@"
}

TOKEN=$(get_token | {{ jq_bin }} -r '.token')
DATADIR=$(curl -H "Authorization: Bearer ${TOKEN}" \   {{ secure_url }}/api/clusters/{{ cluster_name }}/topology/master | {{ jq_bin }}  -r '.slaposDatadir')

revoke_user () {
  DB=$1
  UNAME=$2
  if [ ! -z "$UNAME" ]; then
    echo "Revoking all grants for user '$USER'";
    run_mysql -Be "
    REVOKE ALL PRIVILEGES, GRANT OPTION FROM '$UNAME';
    DROP USER IF EXISTS '$UNAME'@'%';
    DROP USER IF EXISTS '$UNAME'@'localhost';
    DROP USER IF EXISTS '$UNAME'@'::';
    FLUSH PRIVILEGES;
    "
  fi
}

# Only write or delete on master database else, we break replication.
if [ "$DATADIR" = "{{ partition_dir }}" ]; then

  cat << EOF > {{ tmp_dir }}/.script.sql
use repman_slave_definition;

CREATE TABLE IF NOT EXISTS \`slave\` (
  \`name\` varchar(80) NOT NULL,
  \`state\` tinyint(1) DEFAULT NULL,
  \`user\` varchar(80) NOT NULL,
  PRIMARY KEY (\`name\`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

UPDATE \`slave\` set \`state\`=false;
{% for name, user in database_name_list -%}
{%  if name -%}
REPLACE INTO \`slave\` VALUES ('{{ name }}', true, '{{ user }}');
{%  endif -%}
{% endfor -%}

EOF

  # Update requested slaves database
  OUTPUT="{{ tmp_dir }}/removed_db.txt"
  run_mysql < {{ tmp_dir }}/.script.sql
  rm -f {{ tmp_dir }}/.script.sql
  run_mysql -NBe "SELECT name, user FROM repman_slave_definition.slave WHERE state=false" > $OUTPUT

  DBNAME=$(run_mysql --skip-column-names -Be "SELECT name FROM repman_slave_definition.slave WHERE state=false");
  RET=$?

  if [ ! "$RET" = "0" ]; then
    echo "Mysql command failed: $DBNAME"
    exit $RET
  fi

  if [ -z "$DBNAME" ]; then
    echo "No database for slave to remove.";
  fi

  for NAME in $DBNAME; do
    if [ ! -z "$NAME" ]; then
      USER=$(grep -oP "$NAME\s*\K\w+" $OUTPUT);
      if [ ! -z "$USER" ]; then
        revoke_user $NAME $USER;
      fi
      echo "Deleting database $NAME..."
      run_mysql -e "DROP DATABASE IF EXISTS $NAME";
      run_mysql -e "DELETE FROM repman_slave_definition.slave WHERE name='$NAME'";
      echo "Done."
    fi
  done
fi
