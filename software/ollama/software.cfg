[buildout]
extends =
  ../../stack/slapos.cfg
  ../../stack/monitor/buildout.cfg
  ../../component/cmake/buildout.cfg
  ../../component/git/buildout.cfg
  ../../component/golang/buildout.cfg
  ../../component/ninja/buildout.cfg
  ../../component/gcc/buildout.cfg


# buildout.hash.cfg

parts =
  cmake
  git
  gcc-12.3
  ninja

  ollama

  instance.cfg
  slapos-cookbook

[ollama-repository]
recipe = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git
repository = https://github.com/ollama/ollama.git
revision = v0.6.8
init-submodules = true

[ollama-build]
recipe = slapos.recipe.cmmi
path = ${ollama-repository:location}
configure-command = ${cmake:location}/bin/cmake
configure-options = -B build
make-binary =
make-targets = ${cmake:location}/bin/cmake --build build --config Release && cd ${:path} && . ${gowork:env.sh} && go build .
environment =
  PATH=${cmake:location}/bin:${git:location}/bin:${gcc-12.3:location}/bin:${ninja:location}/bin:${buildout:bin-directory}:%(PATH)s
  CC=${gcc-12.3:location}/bin/gcc
  CXX=${gcc-12.3:location}/bin/g++
  CGO_ENABLED=1

[ollama]
recipe = plone.recipe.command
pre-command =
  if pgrep -f "ollama serve"; then
    echo "Stopping Ollama service..."
    pkill -f "ollama serve" || true
    sleep 2
  fi
command =
  mkdir -p ${buildout:parts-directory}/ollama
  cp ${ollama-repository:location}/ollama ${buildout:parts-directory}/ollama/
update-command = ${:command}
stop-on-error = true
depends = ${ollama-build:recipe}
location = ${buildout:parts-directory}/ollama

[default_model]
model = deepseek-r1:14b

[instance.cfg]
recipe = slapos.recipe.template:jinja2
url = ${:_profile_base_location_}/instance.cfg.in
output = ${buildout:directory}/instance.cfg
context =
  section buildout buildout
  key cmake_location cmake:location
  key git_location git:location
  key gcc_location gcc-12.3:location
  key ninja_location ninja:location
  key ollama_location ollama:location
  key model default_model:model
  raw download_script_template ${:_profile_base_location_}/ollama-download-model.py.in
  raw check_script_template ${:_profile_base_location_}/ollama-check-download.py.in
