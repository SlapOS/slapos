[buildout]
extends =
  buildout.hash.cfg
  ../../stack/slapos.cfg
  ../../stack/monitor/buildout.cfg
  ../../component/cmake/buildout.cfg
  ../../component/git/buildout.cfg
  ../../component/golang/buildout.cfg
  ../../component/ninja/buildout.cfg
  ../../component/gcc/buildout.cfg
  ../../component/nginx/buildout.cfg
  ../../component/openssl/buildout.cfg

# buildout.hash.cfg

parts =
  cmake
  git
  gcc-12.3
  ninja
  openssl

  ollama
  instance.cfg
  slapos-cookbook

[ollama-repository]
recipe = slapos.recipe.build:download-unpacked
url = https://github.com/ollama/ollama/archive/refs/tags/v0.9.6.tar.gz
md5sum = a47e9bd4a0248a4c190b6790d18dba3e

[ollama]
recipe = slapos.recipe.cmmi
path = ${ollama-repository:location}
configure-command = ${cmake:location}/bin/cmake
configure-options =
  -S ${ollama-repository:location}
  -B build
make-binary =
make-targets = ${cmake:location}/bin/cmake --build build --config Release && cd ${:path} && . ${gowork:env.sh} && go build .
environment =
  PATH=/usr/local/cuda/bin:${cmake:location}/bin:${git:location}/bin:${gcc-12.3:location}/bin:${ninja:location}/bin:${buildout:bin-directory}:%(PATH)s
  CC=${gcc-12.3:location}/bin/gcc
  CXX=${gcc-12.3:location}/bin/g++
  CGO_ENABLED=1
  LD_LIBRARY_PATH=/usr/local/cuda/lib64:$(LD_LIBRARY_PATH)s

[ollama-download-model-script-template]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/ollama-download-model.py.in
output = ${buildout:directory}/bin/ollama-download-model-script-template
mode = 0755

[ollama-run-script-template]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/ollama-run.py.in
output = ${buildout:directory}/bin/ollama-run-script-template
mode = 0755

[download-file]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:_update_hash_filename_}
destination = ${buildout:directory}/${:_buildout_section_name_}

[nginx.conf.in]
<= download-file
_update_hash_filename_ = templates/nginx.conf.in

[default_model]
# model = steamdj/llama3.1-cpu-only
model = deepseek-r1:14b
# model = qwen3:0.6b

[instance.cfg]
recipe = slapos.recipe.template:jinja2
url = ${:_profile_base_location_}/instance.cfg.in
output = ${buildout:directory}/instance.cfg
context =
  section buildout buildout
  key cmake_location cmake:location
  key git_location git:location
  key gcc_location gcc-12.3:location
  key ninja_location ninja:location
  key ollama_path ollama:path
  key model default_model:model
  key nginx_conf_in nginx.conf.in:target
  key nginx_location nginx:location
  key openssl_location openssl:location
  key buildout_directory buildout:directory
  raw monitor_template_cfg ${monitor-template:output}
  key download_script_template ollama-download-model-script-template:output
  key ollama_run_template ollama-run-script-template:output
