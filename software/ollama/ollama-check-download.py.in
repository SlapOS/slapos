#!/usr/bin/env python3
import os
import sys
import time
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    filename='${directory:log}/ollama-service.log'
)
logger = logging.getLogger('ollama-service')

status_file = "${directory:var}/model-download-complete"
max_wait_time = 3600

start_time = time.time()
while not os.path.exists(status_file):
    elapsed = time.time() - start_time
    if elapsed > max_wait_time:
        logger.error(f"Max wait time exceeded（{max_wait_time} s）")
        print(f"Max wait time exceeded（{max_wait_time}s），please check the log: ${directory:log}/ollama-model-download.log")
        sys.exit(1)

    # Check every 10s
    if int(elapsed) % 10 == 0:
        logger.info(f"Wait for model downloading... {int(elapsed)} 秒")
        print(f"Wait for model downloading... {int(elapsed)} 秒")

    time.sleep(1)

# Read status file
with open(status_file, 'r') as f:
    status = f.read().strip()

logger.info(f"Model download status: {status}")
print(f"Model download status: {status}")
print("Ready to start ollama service...")

# Exit successfully, we can start ollama now
sys.exit(0)
