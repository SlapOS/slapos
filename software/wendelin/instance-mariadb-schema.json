{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "tcpv4-port": {
      "allOf": [
        {
          "$ref": "./schemas-definitions.json#/tcpv4port"
        },
        {
          "description": "Start allocating ports at this value, going downward"
        }
      ]
    },
    "replication": {
      "description": "Setup this mariadb as a replica of another mariadb",
      "type": "object",
      "default": {},
      "properties": {
        "upstream-mariadb-url": {
          "description": "URL of the primary mariadb to replicate from",
          "type": "string"
        },
        "upstream-bootstrap-url": {
          "description": "URL of a recent mariadb backup to bootstrap replication from",
          "type": "string"
        },
        "upstream-caucased-url": {
          "description": "URL of the caucased server of the primary mariadb to request certificates from",
          "type": "string"
        },
        "replicate-with-tls": {
          "description": "Setup the replica to connect upstream with mTLS using the certificate signed by caucase",
          "type": "string",
          "default": true
        },
        "seconds-behind-master-threshold": {
          "description": "Monitoring threshold for Seconds_Behind_Master in the replica, in seconds, -1 meaning no threshold",
          "type": "integer",
          "minimum": -1,
          "default": -1
        },
        "allow-tcp-connections-on-replica": {
          "description": "Whether a replica should allow TCP connections",
          "type": "boolean",
          "default": true
        }
      },
      "oneOf": [
        {
          "required": [
            "primary-url"
          ]
        },
        {
          "enum": [
            {}
          ]
        }
      ],
      "examples": [
        {
          "upstream-mariadb-url": "mysql://<replication_user>:<password>@[<ipv6>]:<port>",
          "upstream-mariabackup-url": "https://[<ipv6>]:<port-1>/mariabackup",
          "upstream-caucased-url": "http://[<ipv6>]:<port-3>"
        },
        {
          "upstream-mariadb-url": "mysql://<replication_user>:<password>@[<ipv6>]:<port>",
          "upstream-bootstrap-url": "https://[<ipv6>]:<port-1>/mariadb-full/most-recent.sql.gz",
          "upstream-caucased-url": "http://[<ipv6>]:<port-3>"
        },
        {
          "upstream-mariadb-url": "mysql://<replication_user>:<password>@[<ipv6>]:<port>",
          "upstream-caucased-url": "http://[<ipv6>]:<port-3>"
        },
        {
          "upstream-mariadb-url": "mysql://<replication_user>:<password>@ipv4:<port>",
          "upstream-mariabackup-url": "http://ipv4:<port-1>/mariabackup"
        },
        {
          "upstream-mariadb-url": "mysql://<replication_user>:<password>@ipv4:<port>"
        }
      ]
    },
    "caucased": {
      "description": "Use a caucased server to obtain certificates for mTLS. Remote services can obtain certificates by pasting their CSRs here.",
      "type": "object",
      "default": {},
      "properties": {
        "enable": {
          "description": "Enable an embedded caucased server running inside the mariadb partition",
          "type": "boolean",
          "default": true
        },
        "csr-to-sign": {
          "description": "PEM-encoded string representing one or more CSRs to be signed by this caucased server",
          "type": "string"
        },
        "external-caucased-url": {
          "description": "Provide the URL of an external caucased server to be used in place of an embedded one",
          "type": "string"
        }
      }
    },
    "ipv6-reverse-proxy": {
      "description": "Grant IPv6 access to mariadb via a reverse-proxy. Requires caucase for mTLS.",
      "type": "object",
      "default": {},
      "properties": {
        "enable": {
          "description": "Enable IPv6 reverse-proxy. Always disabled when no (embedded or external) caucased server is provided.",
          "type": "boolean",
          "default": true
        }
      }
    },
    "database-list": {
      "description": "Databases to create and respective user credentials getting all privileges on it",
      "default": [
        {
          "name": "erp5",
          "user": "user",
          "password": "insecure"
        }
      ],
      "minItems": 1,
      "items": {
        "required": [
          "name",
          "user",
          "password"
        ],
        "properties": {
          "name": {
            "description": "Database name",
            "type": "string"
          },
          "user": {
            "description": "User name",
            "type": "string"
          },
          "password": {
            "description": "User password",
            "type": "string"
          }
        },
        "type": "object"
      },
      "type": "array"
    },
    "backup": {
      "description": "Backup control knobs",
      "properties": {
        "periodicity": {
          "description": "When to backup, specified in the same format as for systemd.time(7) calendar events (years & seconds not supported, DoW & DoM cannot be combined).",
          "default": "daily",
          "type": "string"
        },
        "retention-days": {
          "description": "How many day backups must be retained, 0 meaning forever",
          "default": 7,
          "minimum": 0,
          "type": "integer"
        },
        "logical": {
          "description": "Logical backup (SQL dump) control knobs",
          "properties": {
            "enable": {
              "description": "Enable logical backups",
              "type": "boolean",
              "default": true
            },
            "periodicity": {
              "description": "When to SQL-dump, overriding the global backup periodicity",
              "type": "string"
            },
            "retention-days": {
              "description": "How many days SQL dumps must be retained, overriding the global backup retention value",
              "minimum": 0,
              "type": "integer"
            }
          },
          "default": {},
          "type": "object"
        },
        "physical": {
          "description": "Physical backup (Mariabackup) control knobs",
          "properties": {
            "enable": {
              "description": "Enable physical backups",
              "type": "boolean",
              "default": true
            },
            "periodicity": {
              "description": "When to mariabackup, overriding the global backup periodicity",
              "type": "string"
            },
            "retention-days": {
              "description": "How many days mariabackups must be retained, overriding the global backup retention value",
              "minimum": 0,
              "type": "integer"
            }
          },
          "default": {},
          "type": "object"
        },
        "incremental": {
          "description": "Incremental backup (binlogs) control knobs",
          "properties": {
            "enable": {
              "description": "Enable incremental backups",
              "type": "boolean",
              "default": true
            },
            "retention-days": {
              "description": "How many days binlogs must be retained, overriding the global backup retention value",
              "minimum": 0,
              "type": "integer"
            }
          },
          "default": {},
          "type": "object"
        }
      },
      "type": "object"
    },
    "innodb-buffer-pool-size": {
      "description": "See MariaDB documentation on innodb_buffer_pool_size",
      "minimum": 0,
      "type": "integer"
    },
    "innodb-buffer-pool-instances": {
      "description": "See MariaDB documentation on innodb_buffer_pool_instances",
      "minimum": 1,
      "type": "integer"
    },
    "innodb-log-file-size": {
      "description": "See MariaDB documentation on innodb_log_file_size",
      "minimum": 0,
      "type": "integer"
    },
    "innodb-log-buffer-size": {
      "description": "See MariaDB documentation on innodb_log_buffer_size",
      "minimum": 0,
      "type": "integer"
    },
    "long-query-time": {
      "description": "Number of seconds above which long queries are logged",
      "minimum": 0,
      "default": 1,
      "type": "number"
    },
    "max-connection-count": {
      "description": "See MariaDB documentation on max_connections. If not provided, a value suitable for the number of request Zope processes is chosen.",
      "minimum": 0,
      "type": "integer"
    },
    "relaxed-writes": {
      "description": "When enabled, sets innodb_flush_log_at_trx_commit = 0, innodb_flush_method = nosync, innodb_doublewrite = 0 and sync_frm = 0 - RTFM, those options are dangerous",
      "default": false,
      "type": "boolean"
    },
    "character-set-server": {
      "description": "The server default character set",
      "default": "utf8mb4",
      "type": "string"
    },
    "collation-server": {
      "description": "The server default collation",
      "default": "utf8mb4_general_ci",
      "type": "string"
    },
    "ssl": {
      "description": "Enable and define SSL support for network connections",
      "default": {},
      "properties": {
        "ca-crt": {
          "description": "Certificate Authority's certificate, in PEM format",
          "type": "string"
        },
        "crt": {
          "description": "Server's certificate, in PEM format (mandatory to enable SSL support)",
          "type": "string"
        },
        "key": {
          "description": "Server's key, in PEM format (mandatory to enable SSL support)",
          "type": "string"
        },
        "crl": {
          "description": "Server's certificate revocation list, in PEM format",
          "type": "string"
        },
        "cipher": {
          "description": "Permissible cipher specifications, separated by colons",
          "type": "string"
        }
      },
      "type": "object"
    },
    "odbc-ini": {
      "description": "Contents of odbc.ini file, see unixodbc document",
      "default": "",
      "type": "string"
    },
    "environment-variables": {
      "description": "Extra environment variables for mysqld may be required to use third party ODBC libraries for CONNECT storage engine.",
      "items": {
        "type": "string"
      },
      "type": "array"
    }
  }
}
