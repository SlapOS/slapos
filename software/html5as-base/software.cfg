[buildout]
extends =
# buildout.hash.cfg is used for automated hash calculation of managed
# instance files by calling update-hash
  buildout.hash.cfg
# "slapos" stack describes basic things needed for 99.9% of SlapOS Software
# Releases
  ../../stack/slapos.cfg
# Extend monitoring stack to provide necessary tools for monitoring
  ../../stack/monitor/buildout.cfg
# Extend here component profiles, like openssl, apache, mariadb, curl...
# Or/and extend a stack (lamp, tomcat) that does most of the work for you
# In this example we extend needed components for html5as.
  ../../component/nginx/buildout.cfg
  ../../component/dash/buildout.cfg

parts =
# Call installation of slapos.cookbook egg defined in stack/slapos.cfg (needed
# in 99,9% of Slapos Software Releases)
    slapos-cookbook
# Call creation of instance.cfg file that will be called for deployment of
# instance
    template-cfg
# Add extra egg
    extra-eggs
# Install custom promises egg
    custom-promises-egg

# Download instance.cfg.in (buildout profile used to deployment of instance),
# replace all {{ foo_bar }} parameters by real values
# The recipe, template and mode are fetched from jijna-template
[template-cfg]
recipe = slapos.recipe.template:jinja2
rendered = ${buildout:directory}/template.cfg
template = ${:_profile_base_location_}/${:filename}
mode = 0644
context =
  section buildout buildout
  key nginx_location nginx:location
  key dash_location dash:location
  key template_nginx_conf_target template_nginx_conf:target
  key template_mime_types_target template_mime_types:target
  key template_launcher_target template_launcher:target
  key template_instance_html5as_target instance_html5as:target
  key template_index_html_target template_index_html:target
  key template_graceful_target template_graceful:target
  key template_instance_replicate template_instance_replicate:target
  key template_monitor monitor2-template:rendered

[download-base]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:_update_hash_filename_}
mode = 0644

# Download instance_html5as.cfg.in
[instance_html5as]
# This section inherit from download-base
<= download-base

[template_nginx_conf]
<= download-base

[template_launcher]
<= download-base

[template_mime_types]
<= download-base

[template_index_html]
<= download-base

[template_graceful]
<= download-base

[template_instance_replicate]
<= download-base

[extra-eggs]
recipe  = zc.recipe.egg
eggs    =
    plone.recipe.command

# Download the custom promise sources
# The files option is the output of running md5sum * in the promise directory
[custom-promises]
recipe = slapos.recipe.build
location = ${buildout:parts-directory}/custom-promises
src = ${:_profile_base_location_}/promise
install =
  import os
  import shutil
  os.makedirs(location)
  for x in options['files'].splitlines():
    md5sum, name = x.split()
    path = self.download(
      os.path.join(options['src'], name),
      md5sum)
    shutil.copy(path, os.path.join(location, name))
files =
  a98d598136629e667e7e43e1d3746b53  promise.py
  b55d452332a6fce08a0388bc7e1d34ad  setup.py

# Install the custom promises from downloaded sources
[custom-promises-egg]
recipe = zc.recipe.egg:develop
egg = slapos.promise.html5as
setup = ${custom-promises:location}
