[buildout]
extends =
    buildout.hash.cfg
    ../../stack/slapos.cfg
    ../../component/rina-tools/buildout.cfg
parts =
    slapos-cookbook
    template

[file]
# For old GCC like 4.9.2 on Debian 8.
# XXX: This should be moved to component/rina-tools/buildout.cfg, next to where
#      we force use of system GCC. However, our buildout patches are still not
#      perfect concerning the processing of +=
environment +=
  CFLAGS=-std=c99 -g -O2

[template]
recipe = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/${:filename}
# XXX: "template.cfg" is hardcoded in instanciation recipe
rendered = ${buildout:directory}/template.cfg
context =
    key develop_eggs_directory buildout:develop-eggs-directory
    key eggs_directory buildout:eggs-directory
    key rina_tools_location rina-tools:location
    key instance_root instance-root:target
    key instance_server instance-server:target
    key rina_proxy proxy:location

[download-base]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:filename}

[instance-root]
<= download-base

[instance-server]
<= download-base

[proxy]
recipe = slapos.recipe.build
location = ${buildout:bin-directory}/${:_buildout_section_name_}
url = ${:_profile_base_location_}/${:filename}
install =
  import os, sys
  with open(self.download(options['url'], options['md5sum'])) as src, \
       open(options['location'], 'w') as dst:
    os.fchmod(dst.fileno(), 0o755)
    src.readline()
    dst.write('#!%s\n' % sys.executable)
    dst.write(src.read())
