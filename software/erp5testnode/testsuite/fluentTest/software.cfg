[buildout]

extends =
  ../../../../stack/slapos.cfg
  ../../../../software/caddy/software.cfg
  ../../../../software/fluentd/software.cfg
  buildout.hash.cfg

index = https://pypi.python.org/simple/

parts =
  slapos-cookbook
  eggs
  caddy
  fluentd
  fluentd-plugin-dev-repository
  instance-profile
  template-fluentd-config

[setup-develop-egg]
recipe = zc.recipe.egg:develop

[slapos.test.fluentTest-setup]
<= setup-develop-egg
egg = slapos.test.fluentTest
setup = ${slapos-repository:location}/software/erp5testnode/testsuite/fluentTest/tests/

[erp5.util-setup]
<= setup-develop-egg
egg = erp5.util[testnode]
setup = ${erp5.util-repository:location}

[eggs]
recipe = zc.recipe.egg
eggs =
  ${slapos.test.fluentTest-setup:egg}
  ${erp5.util-setup:egg}
  slapos.core
entry-points =
  runTestSuite=erp5.util.testsuite:runTestSuite
scripts =
  runTestSuite
  slapos
interpreter=
  python_for_test

[git-clone-repository]
recipe = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git
forbid-download-cache = true
branch = master

[slapos-repository]
<= git-clone-repository
#repository = https://lab.nexedi.com/nexedi/slapos.git
repository = https://lab.nexedi.com/Sokhoyan/slapos.git
branch = FluentTest_withFixUtil

# XXX we need an unreleased ( 0.4.51 ) version of erp5.util runTestSuite 
# later we can stop fetching it from git and just use egg
[erp5.util-repository]
<= git-clone-repository
repository = https://lab.nexedi.com/nexedi/erp5.git
revision = 3b9d23bff23cfba208131b004ae4a0e7484e9aff

[versions]
# clear the version of tested eggs, to make sure we installed the developped ones
slapos.test.fluentTest =
erp5.util =
#erp5.util = 0.4.51

[instance-profile]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/instance.cfg
mode = 0644

[template-fluentd-config]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/fluentd-conf.cnf.in
mode = 0644

[fluentd-plugin-dev-repository]
recipe  = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/nexedi/fluent-plugin-wendelin.git
# dir is pretty name as top-level -dev recipe
git-executable = ${git:location}/bin/git

[fluentd]
gems =
  fluentd==0.14.14
  fluent-plugin-td
  bundler
  fluent-plugin-bin

[template-caddy-service]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/template-caddy-service.sh.in
mode = 0644

[template-caddyfile]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/Caddyfile.in
mode = 0644

[template-caddy-fluentd]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:filename}
output = ${buildout:directory}/instance-caddy-fluentd.cfg.in
mode = 0644

[caddy]
recipe  = slapos.recipe.cmmi
path    = ${go_github.com_mholt_caddy:location}
go      = ${gowork:golang}/bin/go
configure-command = :
make-targets =
make-binary = cd ${:path}/caddy  && ${:go} install -v
environment =
  PATH=${pkgconfig:location}/bin:${gowork:golang}/bin:${buildout:bin-directory}:%(PATH)s
  GOPATH=${gowork:directory}
output =  ${gowork:bin}/caddy