[buildout]

extends =
  ../../../../stack/slapos.cfg
  ../../../../software/caddy/software.cfg
  ../../../../software/fluentd/software.cfg

index = https://pypi.python.org/simple/

parts =
  slapos-cookbook
  eggs
  caddy
  fluentd
  fluentd-plugin-dev-repository
  instance-profile
  template-fluentdConfig

[setup-develop-egg]
recipe = zc.recipe.egg:develop

[slapos.test.fluentTest-setup]
<= setup-develop-egg
egg = slapos.test.fluentTest
setup = ${slapos-repository:location}/software/erp5testnode/testsuite/fluentTest/tests/
#setup = ${:_profile_base_location_}/tests/

[erp5.util-setup]
<= setup-develop-egg
egg = erp5.util[testnode]
setup = ${erp5.util-repository:location}

[eggs]
recipe = zc.recipe.egg
eggs =
  ${slapos.test.fluentTest-setup:egg}
  ${erp5.util-setup:egg}
  slapos.core
entry-points =
  runTestSuite=erp5.util.testsuite:runTestSuite
scripts =
  runTestSuite
  slapos
interpreter=
  python_for_test

[git-clone-repository]
recipe = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git
forbid-download-cache = true
branch = testForFleuntdClean

[slapos-repository]
<= git-clone-repository
repository = https://lab.nexedi.com/Sokhoyan/slapos.git

# XXX we need an unreleased ( 0.4.51 ) version of erp5.util runTestSuite 
# later we can stop fetching it from git and just use egg
[erp5.util-repository]
<= git-clone-repository
repository = https://lab.nexedi.com/nexedi/erp5.git
revision = 69013fa0fb67501089c776ab5e75d7bbf2e0e3bc

[versions]
# clear the version of tested eggs, to make sure we installed the developped ones
slapos.test.fluentTest =
erp5.util =
#erp5.util = 0.4.51




#[eggs]
#recipe = zc.recipe.egg
#eggs =
#  erp5.util
#  ${lxml-python:egg}
#  requests
#interpreter = pythonwitheggs

[instance-profile]
recipe = slapos.recipe.template
md5sum = 45c4adaae557bed5c25c24f4c4506b3d
url = ${:_profile_base_location_}/instance.cfg.in
output = ${buildout:directory}/instance.cfg
mode = 0644

[template-test]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/tests/test.py
#md5sum = ff66d13f73982e8257eb5535cdb541c7
output = ${buildout:directory}/test.py
mode = 0644

[template-fluentdConfig]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/templates/fluentd-conf.cnf.in
#md5sum = 63b8bea7fcc18af68e8bdf2afc33a92d
filename = fluentd-conf.cnf.in
location = ${buildout:parts-directory}/${:_buildout_section_name_}
mode = 0644

[fluentd-plugin-dev-repository]
recipe  = slapos.recipe.build:gitclone
repository = https://lab.nexedi.com/Sokhoyan/fluent-plugin-wendelin.git
branch = add-keep-alive
# dir is pretty name as top-level -dev recipe
git-executable = ${git:location}/bin/git

[fluentd]
gems =
  fluentd
  fluent-plugin-td
  bundler
  fluent-plugin-bin

[template-caddy-service]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/templates/template-caddy-service.sh.in
md5sum = 3e09969c479931ca4df6546abbd1a117
output = ${buildout:directory}/template-caddy-service.sh.in
mode = 0644

[template-caddyfile]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/templates/Caddyfile.in
md5sum = 8644e98038ab76a8e5a499e22f92660a
output = ${buildout:directory}/Caddyfile.in
mode = 0644

[template-caddy-fluentd]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/instance-caddy-fluentd.cfg.in
#md5sum = 0faafb57e55c6e1a310433c11e781133
output = ${buildout:directory}/instance-caddy-fluentd.cfg.in
mode = 0644

[caddy]
recipe  = slapos.recipe.cmmi
path    = ${go_github.com_mholt_caddy:location}
go      = ${gowork:golang}/bin/go
configure-command = :
make-targets =
make-binary = cd ${:path}/caddy  && ${:go} install -v
environment =
  PATH=${pkgconfig:location}/bin:${gowork:golang}/bin:${buildout:bin-directory}:%(PATH)s
  GOPATH=${gowork:directory}
output =  ${gowork:bin}/caddy

#versions]
#slapos.recipe.template = 4.3
#erp5.util = 0.4.50
