[buildout]
parts =
  slapos-test-runner
  directory
  fluentdConfig
  fluentd-service
  caddy-service
  publish-connection-information
  runTest-instance

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[directory]
recipe = slapos.cookbook:mkdirectory
etc = $${buildout:directory}/etc
bin = $${buildout:directory}/bin
srv = $${buildout:directory}/srv
var = $${buildout:directory}/var
run = $${:var}/run
log = $${:var}/log
scripts = $${:etc}/run
services = $${:etc}/service
promise = $${:etc}/promise/
www = $${:srv}/www
home = $${:etc}/home
ssl = $${:etc}/ssl
working-dir = $${buildout:directory}/tmp/


[runTest-instance]
recipe = slapos.recipe.template
url = ${template-test:output}
output = $${directory:bin}/test.py
buildout-directory = $${buildout:directory}
mode = 0700

#################################
# fluentd service
#################################

[fluentdConfig]
recipe = slapos.recipe.template:jinja2
template = ${template-fluentdConfig:output}
rendered = $${directory:etc}/fluentd-conf.cnf
mode = 0600
context =
  key local_ip caddy-configuration:local_ip

[fluentd-service]
recipe  = slapos.cookbook:wrapper
wrapper-path = $${directory:services}/fluentd-service
path = ${fluentd:location}
command-line    =  ${fluentd:location}/bin/fluentd -vv
    -c $${directory:etc}/fluentd-conf.cnf  -p ${fluentd-plugin-dev-repository:location}/lib/fluent/plugin/ -o $${directory:etc}/fluent.log
environment =
  GEM_PATH= ${fluentd:location}/lib/ruby/gems/1.8/
output = $${:wrapper-path}  

#################################
# caddy service
#################################

[caddy-service]
recipe = slapos.recipe.template:jinja2
template = ${template-caddy-service:output}
rendered = $${directory:services}/caddy
mode = 0700
context =
  key caddy_exec caddy-exec-dict:caddy-exec-file
  key caddy_file caddy-configuration:rendered
  key pidfile_dir directory:etc

[caddy-exec-dict]
caddy-exec-file = ${gowork:bin}/caddy
  
[caddy-configuration]
recipe = slapos.recipe.template:jinja2
template = ${template-caddyfile:output}
rendered = $${directory:etc}/Caddyfile
mode = 0600
access_log = $${directory:log}/caddy-access.log
error_log = $${directory:log}/caddy-error.log
local_ip = $${slap-network-information:local-ipv4}
context = 
  key local_ip caddy-configuration:local_ip

[publish-connection-information]
recipe = slapos.cookbook:publish
secure_access = http://$${caddy-configuration:local_ip}:4443}


[download-source]
recipe = slapos.recipe.build:gitclone
git-executable = ${git:location}/bin/git

[slapos]
<= download-source
repository = ${slapos-repository:location}

[create-directory]
recipe = slapos.cookbook:mkdirectory
bin = $${buildout:directory}/bin

[slapos-test-runner]
recipe = slapos.cookbook:wrapper
wrapper-path = $${directory:bin}/runTestSuite
command-line =
  ${buildout:bin-directory}/runTestSuite
  --python_interpreter=${buildout:bin-directory}/${eggs:interpreter}
  --source_code_path_list=$${slapos:location}/software/erp5testnode/testsuite/fluentTest/tests/
environment =
  PATH=${buildout:bin-directory}:/usr/bin/:/bin/
  LOCAL_IPV4=$${slap-network-information:local-ipv4}
  GLOBAL_IPV6=$${slap-network-information:global-ipv6}
  FLUENT_SERVICE = $${fluentd-service:path}
  SLAPOS_TEST_WORKING_DIR=$${directory:working-dir}
  CADDY_DIR = $${directory:etc}/caddy_pidfile
  DEBUG=1