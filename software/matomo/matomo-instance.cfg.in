# parameters required by the configuration instance
[instance-parameter]
matomo = ${:document-root}
dir-backup = ${directory:backup}
find-bin = {{ findutils_location }}
diff-bin = {{ diffutils_location }}

[matomo-backup-cron]
recipe = slapos.cookbook:cron.d
cron-entries = ${cron:cron-entries}
name = matomo-backup
frequency = * * * * *
log-file = ${directory:log}/matomo-backup.log
command = ${matomo-backup.sh:output} 2>&1 | ${xxx.sh:output} > ${:log-file}

[matomo-backup.sh]
recipe = slapos.recipe.template:jinja2
url = {{ matomo_backup_sh }}
output = ${directory:scripts}/matomo-backup
context =
  section parameter_dict instance-parameter
  key php_bin php-bin:wrapper-path

[xxx.sh]
recipe = slapos.recipe.template:jinja2
url = {{ xxx_sh }}
output = ${directory:scripts}/xxx

[promise-cron]
<= monitor-promise-base
promise = check_cron_service
name = promise-cron.py
config-cron_log = ${cron-simplelogger:log}

# Add the custom promise to check that the index file exists
[check-cron-promise]
recipe = slapos.cookbook:promise.plugin
eggs = slapos.core
file = {{ custom_promise }}
output = ${directory:plugins}/check-cron-service.py
config-cron_log = ${cron-simplelogger:log}
config-partition_path = ${directory:etc}
config-cron_name = ${matomo-backup-cron:name}
config-log_file = ${matomo-backup-cron:log-file}

[apache-php-service]
environment=
  MATOMO_DATABASE_HOST=${mariadb-urlparse:host}:${mariadb-urlparse:port}
  MATOMO_DATABASE_ADAPTER=mysql
  MATOMO_DATABASE_TABLES_PREFIX=matomo_
  MATOMO_DATABASE_USERNAME=${mariadb-urlparse:username}
  MATOMO_DATABASE_PASSWORD=${mariadb-urlparse:password}
  MATOMO_DATABASE_DBNAME=${mariadb-urlparse:path}
