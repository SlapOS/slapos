[buildout]
extends =
   ../../component/python3/buildout.cfg
   ../../component/python-2.7/buildout.cfg
   ../../component/nodejs/buildout.cfg
   ../../component/caddy/buildout.cfg
   ../../component/git/buildout.cfg
   ../../component/bash/buildout.cfg
   ../../stack/slapos.cfg
   ./buildout.hash.cfg

parts =
  python-language-server
  theia-wrapper
  slapos-cookbook
  instance


[nodejs]
<= nodejs-8.9.4

[python3]
<= python3.6.6


[yarn]
# this could become a component, but it needs to be invoked from nodejs explicitly,
# otherwise it uses system's nodejs
# XXX why don't we build a wrapper ?
version = 1.11.0
recipe = slapos.recipe.build:download-unpacked
url = https://github.com/yarnpkg/yarn/releases/download/v${:version}/yarn-v${:version}.tar.gz
md5sum = d4f05075f534dd9a0a8c18c650b55f0d


[python-language-server]
version = 0.19.0

recipe = plone.recipe.command
command =
  bash -c "${python3:executable} -m venv ${:location} && \
    . ${:location}/bin/activate && \
    pip install 'python-language-server[all]==${:version}' flake8 autopep8"
location = ${buildout:parts-directory}/${:_buildout_section_name_}
stop-on-error = true

[theia]
recipe = plone.recipe.command
command = ${bash:location}/bin/bash -c "
  export PATH=${nodejs:location}/bin/:${python2.7:location}/bin/:$PATH &&
  mkdir -p ${:location} && \
  cd ${:location} && \
  cp ${package.json:rendered} . &&
  ${yarn:location}/bin/yarn && \
  ${yarn:location}/bin/yarn theia build"
location = ${buildout:parts-directory}/${:_buildout_section_name_}
stop-on-error = true

[package.json]
recipe = slapos.recipe.template:jinja2
template =
  inline:
  {
    "private": true,
    "dependencies": {
      "typescript": "latest",
      "@theia/typescript": "next",
      "@theia/navigator": "next",
      "@theia/terminal": "next",
      "@theia/outline-view": "next",
      "@theia/preferences": "next",
      "@theia/messages": "next",
      "@theia/git": "next",
      "@theia/file-search": "next",
      "@theia/markers": "next",
      "@theia/python": "next",
      "@theia/preview": "next",
      "@theia/callhierarchy": "next",
      "@theia/merge-conflicts": "next",
      "@theia/search-in-workspace": "next",
      "@theia/json": "next",
      "@theia/textmate-grammars": "next",
      "@theia/mini-browser": "next"
    },
    "devDependencies": {
      "@theia/cli": "next"
    }
  }
rendered = ${buildout:directory}/${:_buildout_section_name_}
mode = 0644


[theia-wrapper]
recipe = slapos.recipe.template:jinja2
rendered = ${buildout:bin-directory}/${:_buildout_section_name_}
mode = 0777
template =
  inline:
  #!/bin/sh
  # arguments:
  #  env -i .. $0 workspace_directory --hostname (ipv4 url) --port (port)
  export PATH=${nodejs:location}/bin/:${python-language-server:location}/bin/:${bash:location}/bin/:${git:location}/bin/:$PATH
  export SHELL=bash
  cd ${theia:location}
  exec ${yarn:location}/bin/yarn theia start $@


[instance]
recipe = slapos.recipe.template
url = ${:_profile_base_location_}/${:filename}
mode = 0644
output = ${buildout:directory}/instance.cfg

[versions]
slapos.recipe.template = 4.3
