[buildout]
parts =
  switch-softwaretype

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[switch-softwaretype]
recipe = slapos.cookbook:switch-softwaretype
default = dynamic-template-fluentd:output
gateway = dynamic-template-fluentd-gateway:output
RootSoftwareInstance = $${:default}

[directory]
recipe = slapos.cookbook:mkdirectory
home = $${buildout:directory}
bin = $${:home}/bin
etc = $${:home}/etc
var = $${:home}/var
service = $${:etc}/service
fluentd-buffer = $${:var}/fluentd-buffer

[slap-configuration]
recipe = slapos.cookbook:slapconfiguration
computer = $${slap_connection:computer_id}
partition = $${slap_connection:partition_id}
url = $${slap_connection:server_url}
key = $${slap_connection:key_file}
cert = $${slap_connection:cert_file}

[jinja2-template-base]
recipe = slapos.recipe.template:jinja2
extra-context =
context =
    section directory directory
    key fluentd_agent_conf fluentd-agent-conf:output
    key port_list fluentd-conf:port-list
    $${:extra-context}

[dynamic-template-fluentd]
<= jinja2-template-base
url = ${template-fluentd:output}
output = instance-fluentd.cfg
extensions = jinja2.ext.do
extra-context =

[dynamic-template-fluentd-gateway]
<= jinja2-template-base
url = ${template-fluentd-gateway:output}
output = instance-fluentd-gateway.cfg
extensions = jinja2.ext.do
extra-context =

[fluentd-conf]
recipe = slapos.recipe.build
slapparameter-dict = $${slap-configuration:configuration}
software-type = $${slap-configuration:slap-software-type}
buffer-file-dir = $${directory:fluentd-buffer}
init =
  import re

  software_type = options['software-type'] or 'RootSoftwareInstance'

  if software_type in ['RootSoftwareInstance', 'default']:
    options['conf-text'] = options['slapparameter-dict'].get('conf-text') or ' '

  elif software_type == 'gateway':
    port = options['slapparameter-dict'].get('port')
    shared_key = options['slapparameter-dict'].get('fluentd-shared-key')
    ors_wendelin_url = options['slapparameter-dict'].get('ors-wendelin-frontend-url')
    inituser_login = options['slapparameter-dict'].get('inituser-login')
    inituser_password = options['slapparameter-dict'].get('inituser-password')
    buffer_file_dir = options['buffer-file-dir']

    options['conf-text'] = (
      "<source>\n"
      "  @type forward\n"
      "  port %s\n"
      "  bind ::0\n"
      "  add_tag_prefix ors\n"
      "  <security>\n"
      "    self_hostname ors-wendelin-gateway\n"
      "    shared_key %s\n"
      "  </security>\n"
      "</source>\n"
      "<match ors.**>\n"
      "  @type wendelin\n"
      "  streamtool_uri %s/erp5/portal_ingestion_policies/ors_ingestion\n"
      "  user %s\n"
      "  password %s\n"
      "  <buffer>\n"
      "    flush_mode interval\n"
      "    flush_interval 1m\n"
      "    @type file\n"
      "    path %s/\n"
      "  </buffer>\n"
      "</match>"
    ) % (port, shared_key, ors_wendelin_url, inituser_login, inituser_password, buffer_file_dir)

  options['port-list'] = re.findall(r'<source>.*port (\d+).*<\/source>', options['conf-text'], re.DOTALL)

[fluentd-agent-conf]
recipe = slapos.recipe.template
inline = $${fluentd-conf:conf-text}
output = $${directory:etc}/fluentd-agent.conf
