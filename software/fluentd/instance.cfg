[buildout]
parts =
  switch-softwaretype

eggs-directory = ${buildout:eggs-directory}
develop-eggs-directory = ${buildout:develop-eggs-directory}
offline = true

[switch-softwaretype]
recipe = slapos.cookbook:switch-softwaretype
default = dynamic-template-fluentd:output
expert = dynamic-template-fluentd-expert:output

[directory]
recipe = slapos.cookbook:mkdirectory
home = $${buildout:directory}
bin = $${:home}/bin
etc = $${:home}/etc
var = $${:home}/var
service = $${:etc}/service
fluentd-buffer = $${:var}/fluentd-buffer

[slap-configuration]
recipe = slapos.cookbook:slapconfiguration
computer = $${slap_connection:computer_id}
partition = $${slap_connection:partition_id}
url = $${slap_connection:server_url}
key = $${slap_connection:key_file}
cert = $${slap_connection:cert_file}

[jinja2-template-base]
recipe = slapos.recipe.template:jinja2
extra-context =
context =
    section directory directory
    key slapparameter_dict slap-configuration:configuration
    key fluentd_agent_conf fluentd-agent-conf:output
    key port_list fluentd-conf:port-list
    $${:extra-context}

[dynamic-template-fluentd]
<= jinja2-template-base
url = ${template-fluentd:output}
output = instance-fluentd.cfg
extensions = jinja2.ext.do
extra-context =
  raw ipv6_random $${slap-configuration:ipv6-random}

[dynamic-template-fluentd-expert]
<= jinja2-template-base
url = ${template-fluentd-expert:output}
output = instance-fluentd-expert.cfg
extensions = jinja2.ext.do

[fluentd-conf]
recipe = slapos.recipe.build
slapparameter-dict = $${slap-configuration:configuration}
software-type = $${slap-configuration:slap-software-type}
buffer-file-dir = $${directory:fluentd-buffer}
init =
  import re

  software_type = options['software-type'] or 'RootSoftwareInstance'

  if software_type in ['RootSoftwareInstance', 'default']:
    bind = options['slapparameter-dict'].get('bind') or '::0'
    port = options['slapparameter-dict'].get('port') or '24224'
    tag_prefix = options['slapparameter-dict'].get('tag-prefix')
    tag_match_pattern = options['slapparameter-dict'].get('tag-match-pattern')
    wendelin_ingestion_url = options['slapparameter-dict'].get('wendelin-ingestion-url')
    username = options['slapparameter-dict'].get('username')
    password = options['slapparameter-dict'].get('password')
    flush_interval = options['slapparameter-dict'].get('flush-interval') or '1m'
    buffer_file_dir = options['buffer-file-dir']

    conf_text = (
      "<source>\n"
      "  @type forward\n"
      "  bind %s\n"
      "  port %s\n"
    ) % (bind, port)

    if tag_prefix:
      conf_text += (
        "  add_tag_prefix %s\n"
        "</source>\n"
      ) % (tag_prefix)
    else:
      conf_text += (
        "</source>\n"
      )

    # Match directive: setting an explicit match pattern overrides the tag prefix + catchall default
    if tag_match_pattern:
      conf_text += (
        "<match %s>\n"
      ) % tag_match_pattern
    else:
      if tag_prefix:
        conf_text += (
          "<match %s.**>\n"
        ) % (tag_prefix)
      else:
        # Default case
        conf_text += (
          "<match **>\n"
        )

    conf_text += (
      "  @type wendelin\n"
      "  streamtool_uri %s\n"
      "  user %s\n"
      "  password %s\n"
      "  <buffer tag,time>\n"
      "    timekey 1m\n"
      "    flush_mode interval\n"
      "    flush_interval %s\n"
      "    flush_thread_count 4\n"
      "    @type file\n"
      "    path %s/\n"
      "  </buffer>\n"
      "</match>"
    ) % (wendelin_ingestion_url, username, password, flush_interval, buffer_file_dir)

    options['conf-text'] = conf_text

  elif software_type == 'expert':
    options['conf-text'] = options['slapparameter-dict'].get('conf-text') or ' '

  options['port-list'] = re.findall(r'<source>.*port (\d+).*<\/source>', options['conf-text'], re.DOTALL)

[fluentd-agent-conf]
recipe = slapos.recipe.template
inline = $${fluentd-conf:conf-text}
output = $${directory:etc}/fluentd-agent.conf
