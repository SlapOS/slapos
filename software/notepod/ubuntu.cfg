[buildout]
extends =
  ../../component/vm-img/ubuntu.cfg
parts =
  vm-ubuntu

[vm-ubuntu]
# Comment the following to debug.
vm.run = false
dists = ubuntu-desktop-2510
mem = 4096
# TODO: Pick an absurdly large value (it's sparse anyway) and minimize the size
#       at the end of the install, mainly using 'btrfs filesystem resize'.
#       Not easy because the later does not « balance » automatically and
#       'btrfs balance' provides no way to pack data as much as possible.
size = 9Gi
autoinstall.storage.config = json:[{
    "id": "disk",
    "type": "disk",
    "ptable": "gpt",
    "grub_device": true
  }, {
    "id": "legacy",
    "type": "partition",
    "device": "disk",
    "size": "1M",
    "flag": "bios_grub"
  }, {
    "id": "efi",
    "type": "partition",
    "device": "disk",
    "size": "40M",
    "partition_type": "uefi"
  }, {
    "id": "root",
    "type": "partition",
    "device": "disk",
    "size": -1
  }, {
    "id": "format",
    "type": "format",
    "fstype": "btrfs",
    "extra_options": [
       "-m", "single",
       "-r", "/slapos",
       "-u", "default:@"
    ],
    "volume": "root"
  }, {
    "id": "mount",
    "type": "mount",
    "path": "/",
    "device": "format",
    "options": "noatime,compress=zstd"
  }]

autoinstall.apt.geoip = json:false
autoinstall.source.id = ubuntu-desktop
-packages =
  cryptsetup-initramfs expect fido2-tools libpwquality-tools lvm2
  python3-dev python3-fido2 python3-pydbus python3-venv
  aptitude btrfs-compsize debsums etckeeper git lm-sensors powertop socat sshfs
  fonts-recommended ttf-mscorefonts-installer task-english
  audacity gedit gimp inkscape keepassxc-full qpwgraph vim vlc
  va-driver-all
# TODO: Automatic upgrade of Chromium, which currently can't be done with
#       unattended-upgrades due to lack of configurability.
  ungoogled-chromium-l10n
  slapos-node re6st-node

locales =
  bg_BG
  de_DE
  el_GR
  es_ES
  fr_FR
  ja_JP
  pl_PL
  pt_BR
  zh_CN

early-command =
  pkgs=apt-utils
# For debugging. There's no such file if vm.run is false.
  [ -s /root/.ssh/authorized_keys ] && pkgs="$pkgs openssh-server"
  apt-get install -y --no-install-recommends $pkgs
# It must match slapos.package.git/playbook/roles/repository/tasks/deb822.yml
  set apt.conf.d keyrings sources.list.d obs-vifibnexedi \
    https://download.opensuse.org/repositories/home:/ VIFIBnexedi/xUbuntu_`
      echo 24.10 ||
      lsb_release -sr`
  cd /slapos/@/etc/apt
  mkdir $1 $2 $3
# XXX: Automatic upgrade of re6st-node & slapos-node - NOT TESTED
  echo Unattended-Upgrade::Origins-Pattern:: \"o=obs://build.opensuse.org/home:$6'";' >$1/80$4
  wget -O $2/$4.asc $5$6/Release.key
  cat <<EOF >$3/$4.sources
  Types: deb
  URIs: $5$6
  Suites: ./
  Signed-By: /etc/apt/$2/$4.asc
  EOF

link.etc/systemd/system/multi-user.target.wants/post-install.service =
  ../post-install.service

late-command =
  mkdir /boot/efi
  mkfs.vfat /dev/sda2
  mount /dev/sda2 /boot/efi
  APT_GET='/usr/bin/apt-get -yo Dpkg::options::=--force-unsafe-io'
  $APT_GET purge cloud-init libpam-sss rsyslog ubuntu-insights
  ln -s /dev/null /etc/systemd/user/gnome-initial-setup-first-login.service
# Remove old kernel if any.
  echo '#clear APT::VersionedKernelPackages;' |$APT_GET -c /dev/stdin autopurge
  rm -r /etc/machine-id /etc/cloud /etc/apt/preferences.d.save
  dpkg -P grub-pc grub-pc-bin grub-gfxpayload-lists
  $APT_GET upgrade
  add-apt-repository ppa:xtradeb/apps
# Using installer 'packages' is too slow because apt-get is run once per
# package, the main consequence being that it updates initrd too often.
  set /etc/opt/language-support "${:-packages}" "${:locales}"
  $APT_GET install $2
  /installer/language-support en $3 >$1
  btrfs sub create /aptcache
  $APT_GET -o Dir::Cache::Archives=/aptcache -o Debug::NoLocking=1 install -d `
    while read x; do echo $${x##*:}; done <$1`
  set /etc/grub.d/00_header /usr/sbin/grub-install
  dpkg-divert --divert $1.dpkg-dist --rename $1
  mv $1.dpkg-new $1
  $APT_GET install --no-install-recommends grub-efi-amd64
  cp -a /usr/share/grub/default/grub /etc/default/grub
  update-grub
  rm /etc/default/grub.ucf-dist /etc/default/grub.d/50-installer.cfg
  dpkg-divert --rename $2
  cat <<EOF >$2
  #!/bin/sh -e
  # Unless securing boot (and systemd-boot looks better than grub for that),
  # better stay as far away as possible from UEFI. However for fwupd,
  # we don't blacklist efivarfs/efi_pstore modules.
  exec "\$0.distrib" --no-nvram --removable "\$@"
  EOF
  chmod +x $2
  grub-install --target=x86_64-efi /dev/sda
  $APT_GET -o Dir::Etc::sourcelist=/dev/null -o Dir::Etc::SourceParts= update
  $APT_GET clean
# TODO: Update snaps (snap refresh). This is impossible because snaps don't
#       work in container (tried systemd-nspawn):
#       - it needs apparmor but apparmor.service won't start
#       - snapd failed to start if I bind mount the host securityfs
#       - I managed to trick aa_is_enabled but it fails later
#       - I couldn't find a way to disable confinement
#       I seems possible to have fully-working snaps with systemd-vmspawn
#       but the later is not available yet on 25.10. Maybe doable with
#       qemu + virtio-9p-pci but at that point, better wait for 26.04.
#       Note that the use of systemd-nspawn would be done inside the recipe
#       (replacing 'curtin in-target') with something like the following arg:
#         systemd.unit=late-command.service

exec.language-support =
  inline:#!/usr/bin/python3
  import apt, sys
  from language_support_pkgs import LanguageSupport
  from LanguageSelector.LocaleInfo import LocaleInfo
  from LanguageSelector.LangCache import LanguageSelectorPkgCache
  datadir = "/usr/share/language-selector"
  li = LocaleInfo("languagelist", datadir)
  cache = LanguageSelectorPkgCache(li, apt.progress.base.OpProgress())
  ls = LanguageSupport(cache, datadir + "/data/pkg_depends")
  ls.available_languages = lambda: (langcode,)
  for locale in sys.argv[1:]:
    langcode = ls._langcode_from_locale(locale)
    missing = ls.missing()
    missing.discard('language-pack-' + langcode)
# Normally, for the widest audience, the first thing that the user would be
# asked is to choose the language+country, possibly not even knowing how it's
# translated in English. We could translate "<language> (<country>)" with
# native=True but unless we translate all other steps of the installer, we're
# far from this use case. This would also require fbterm because the linux
# console does not support wide characters. A drawback with fbterm is that box
# drawings characters are ugly (tested with 'fbterm -s 16' under Ubuntu 25.10).
    print('%s:%s:' % (locale, li.translate(locale, False, True)),
          *sorted(missing))

file.etc/systemd/system/reboot.target.d/no-timeout.conf =
  inline:[Unit]
  JobTimeoutSec=infinity

file.etc/systemd/system/post-install.service =
  inline:[Unit]
  Before=snap.ubuntu-desktop-bootstrap.subiquity-server.service
  After=ssh.service
  [Service]
  Type=oneshot
  RemainAfterExit=yes
  ExecStop=/etc/opt/post-install
  TimeoutStopSec=infinity
  StandardOutput=tty
  StandardError=inherit

exec.etc/opt/post-install = inline:#!/bin/sh
  ( set -e -- --no-md5 --no-sha1 --no-sha256 .
    mount -o noatime,subvol=/ /dev/sda3 /target
    cd /target/@/aptcache
    apt-ftparchive packages $* >Packages
    release=`apt-ftparchive release $*`
    echo "$release" >Release
    cd ..
    find run tmp -mindepth 1 -delete
    >etc/fstab
    rm -r etc/dracut.conf.d/installer.conf \
      usr/lib/dracut/modules.d/80installer
    cd ..
    btrfs sub set-default .
    btrfs sub snap -r @/aptcache @aptcache
    mv @ @rootfs
    btrfs sub snap -r @rootfs @
    btrfs sub delete -R @rootfs
    btrfs send @ |wc -c >send-size
    fstrim -v .
    cd ..
    umount target
  )
  [ $? = 0 ] || sleep infinity

exec.slapos/@/etc/grub.d/00_header.dpkg-new =
  inline:#!/bin/sh -e
  eval `grep ^quick_boot= $0.dpkg-dist`
  [ "$quick_boot" = 1 ] || {
    echo $0 patch is out-of-date >&2
    exit 1
  }
  sed 's/^quick_boot=.*/echo "function recordfail {\n  true\n}"/' $0.dpkg-dist |
    /bin/sh
file.slapos/@/etc/default/grub.d/00-notepod.cfg =
# Editing commands in graphical GRUB is terribly slow on Thinkpad,
# especially at native resolution. It also breaks initrd display on qemu.
# By default, users have no reason to use the menu anyway.
  inline:GRUB_TIMEOUT=0.1
  GRUB_TERMINAL=console
file.slapos/@/etc/default/grub.d/50-installer.cfg =
  inline:unset GRUB_TIMEOUT GRUB_TIMEOUT_STYLE
  GRUB_DISTRIBUTOR="NotePOD Installer - $GRUB_DISTRIBUTOR"
# snap obviously takes a lot of resources to start - see dracut-mount.sh for
# mounts. 'systemd-analyze blame' reports that apparmor is also slow to start.
# We also disable anything that would download things for nothing.
# Disabling cron is mainly to disable slapos.
  GRUB_CMDLINE_LINUX=$GRUB_CMDLINE_LINUX$(find `
    dpkg -L apparmor packagekit snapd unattended-upgrades
  ` -maxdepth 0 -type f \( -path '/lib/systemd/system/*' \
    -o -path '/usr/lib/systemd/system/*' \) -printf ' systemd.mask=%f')
  for x in cron.service display-manager.service update-notifier-download.timer
  do GRUB_CMDLINE_LINUX="$GRUB_CMDLINE_LINUX systemd.mask=$x"
  done
  GRUB_DISABLE_RECOVERY=true

file.slapos/@/etc/dracut.conf.d/installer.conf =
  inline:add_drivers+=" overlay "
  add_dracutmodules+=" installer "

# WKRD: Seriously, why can't dracut be customized in /etc ?
file.slapos/@/usr/lib/dracut/modules.d/80installer/module-setup.sh =
  inline:check() {
    return 255
  }
  install() (
# WKRD: Is there a way to disable this auto sysroot.mount thing so we could
#       just do what we want in a mount hook ?
    cd $initdir/etc/systemd/system
    set dracut-mount.service.d sysroot.mount.d
    mkdir "$@"
# WKRD: It would be simpler if Where= could be changed but systemd would
#       complain that it does not match the unit name...
    cat <<EOF >$2/installer.conf
  [Mount]
  Options=ro,subvol=/
  EOF
# WKRD: dracut-mount uses a buggy usable_root function but even without this
#       bug, it would just umount /sysroot before invoking hooks... the usual
#       recipe to hide bugs and waste everyone's time. Let's override it with
#       ours.
# WKRD: I first tried inst_script and it just resulted in a silent failure.
#       If all dracut is programmed this way, let's say it's beyond repair.
    cp $moddir/dracut-mount.sh $initdir/usr/bin/dracut-mount
    cat <<EOF >$1/installer.conf
  [Unit]
  ConditionDirectoryNotEmpty=
  EOF
  )

exec.slapos/@/usr/lib/dracut/modules.d/80installer/dracut-mount.sh =
  inline:#!/bin/sh
  . /lib/dracut-lib.sh
  getargs rd.break=mount &&
  emergency_shell -n mount "Break before mount"
  ( set -e
    mount -t tmpfs tmpfs /tmp
    cd /tmp
    mkdir rootfs up work merged
# WKRD: Make --move work. (Why does dracut bother us with shared mounts ?)
    mount --make-rprivate /
    mount --move /sysroot rootfs
    mount -t overlay -o lowerdir=rootfs/@,upperdir=up,workdir=work \
      overlay merged
    mount --bind merged /sysroot; umount merged
    cd /sysroot
    mkdir mnt/overlay
    mount --move /tmp mnt/overlay
    mount --make-rshared /
# initrd has just generated a new machine-id automatically. Copy it so that
# it's not considered a first boot, mainly to avoid systemd.preset(5).
    cp -a /etc/machine-id etc
    cd etc/systemd/system
    rm multi-user.target.wants/snap-*.mount
    tty () {
      mkdir getty@tty$1.service.d
      cat >getty@tty$1.service.d/installer.conf
    }
    tty 1 <<END
  ${:tty-common}/etc/opt/installer.sh
  UnsetEnvironment=
  UnsetEnvironment=LANGUAGE
  END
      tty 2 <<END
  ${:tty-common}-/sbin/agetty --autologin root --noclear %I \$TERM
  END
  )
  [ $? = 0 ] || emergency_shell -n mount ERROR

tty-common = [Service]
  TTYVTDisallocate=no
  ExecStart=
  ExecStart=

file.slapos/@/etc/systemd/system/rescue.service.d/force.conf =
  inline:[Service]
  Environment=SYSTEMD_SULOGIN_FORCE=1

exec.slapos/@/etc/opt/installer.sh =
  inline:#!/bin/sh
  ( set -e /dev/mapper/*_crypt
    [ ! -e "$1" ]
    # dummy print to initialize tty,
    # else the dpkg-reconfigure below starts with wrong columns/lines
    # (that would be useless with fbterm)
    printf '\33[30m.\33[39m\r' # use black fg because nbsp does not work
    trap 'echo Exit shell to restart.' 0
    chmod -x /usr/sbin/update-initramfs
    dpkg-reconfigure -p high keyboard-configuration
    setupcon

    SELECTED_LOCALES=$(IFS=':
  '; whiptail --title 'Languages to install' --notags --checklist \
    'You will be asked later which one to use.' 0 0 0 `
      while read a b c; do [ $a = en ] || echo $a:$b:off
      done </etc/opt/language-support` 3>&1 1>&2 2>&3)
    export SELECTED_LOCALES

    title='Where to install?'
    src=`lsblk -Q "MOUNTPOINT && TYPE == \"part\"" -no PKNAME |sort -u`
    disks=`lsblk -Q "TYPE == \"disk\" && NAME != \"$src\"" -no NAME,MODEL`
    [ "$disks" ] || {
      NEWT_COLORS=root=,red whiptail --title "$title" --ok-button Cancel \
        --msgbox 'ERROR: No disk detected.' 0 0
      exit 1
    }
    ifs=$IFS
    IFS='
  '
    set $disks
    IFS=$ifs
# Excluding loop devices was required before we disable snaps in the installer.
    [ $# = 1 ] && [ ! "$(
      lsblk -nQ "TYPE != \"disk\" && TYPE != \"loop\" && PKNAME != \"$src\""
    )" ] && set on || set off
    dst=$(echo "$disks" |while read tag item; do
        echo $tag
        echo $item
        echo $1
      done |xargs -d '\n' whiptail --title "$title" --radiolist \
    "Current block devices excluding $src, which is this installer:\n\n$(
      lsblk -T -Q "TYPE != \"loop\" && PKNAME != \"$src\" && NAME != \"$src\"" \
        -o NAME,SIZE,RM,RO,TYPE,PARTTYPENAME,FSTYPE,LABEL
    )\n\nThe chosen device will be erased completely." 0 0 $# -- 3>&1 1>&2 2>&3)
    [ "$dst" ]

    [ "$(lsblk -nQ "PKNAME == \"$dst\"")" ] && {
      whiptail --title "$title" --defaultno --yesno "\
    WARNING: $dst contains partitions and all the data they contain will be lost.
             Are you sure you want to continue?" 0 0
      force=-f
    }

    while :; do
      method=`python3 <<EOF 3>&1 1>&2 2>&3
  import os
  from fido2.hid import list_descriptors
  args = ['whiptail', '--title', 'Encryption method', '--notags', '--radiolist',
          '', '0', '0', '0', 'passwd', 'Password', 'off']
  status = 'on'
  for x in list_descriptors():
    args += x.path, x.product_name, status
    status = 'off'
  args += 'retry', 'Refresh FIDO2 hardware keys', status
  os.execvp(args[0], args)
  EOF
  `
      case $method in
        retry) ;;
        passwd)
          title='Encryption passphrase'
          pwdbox () {
            whiptail --title "$title" --passwordbox "\\n$1" 9 77 3>&1 1>&2 2>&3
          }
          pass=`pwdbox 'Enter passphrase to set up disk encryption:'`
          msg=`echo "$pass" |pwscore 2>&1` && {
            unset luksFormat crypttab
            [ "$pass" = "`pwdbox 'Re-enter passphrase to verify:'`" ] && break
            msg='Passphrases do not match.'
          }
          whiptail --title "$title" --msgbox "$msg" 0 0 ;;
        *)
          crypttab=,fido2-device=auto
          luksFormat='-i 1 -S 1'
          pass=dummy
          fido2-token -I $method |grep -q '^options:.*\bclientPin\b' && break
          msg=`fido2-token -S $method 3>&1 1>&2 2>&3` && break
          whiptail --title 'FIDO2 - Setting PIN' --msgbox "$msg" 0 0 ;;
      esac
    done

# /boot size (900MiB): Unfortunately, initrd images have become huge due to
#                      graphics firmwares.
# EFI size (~100MiB): - grub needs <1M
#                     - Lenovo UEFI needs standard FAT32 (>32M)
#                     - fwupd wants something >50M
# swap size: ~ RAM size
# The first 4MiB are: - 1MiB unpartitioned (GPT table at the beginning)
#                     - 2MiB LUKS (why is the default much bigger and what
#                                  would be the point of so many key slots?)
#                     - 1MiB LVM (default)
# Overall, all FS are 4MiB-aligned/sized (except for EFI size)
    set 900 `blockdev --getsz /dev/$dst`
    M=$(( ($2 >> 13 << 2) - $1 - 100 ))
    printf ",$${M}M,L\n,$1M,L\n,+,U\n" |sfdisk -X gpt /dev/$dst
    set `sfdisk -ql /dev/$dst -o Device`

    udevadm wait $2
    echo -n "$pass" |cryptsetup luksFormat -qo 4096 $luksFormat $2 -
    dm=vg-crypt

    [ $method = passwd ] || {
      expect /dev/fd/3 3<<EOF
  set timeout -1
  while 1 {
    spawn systemd-cryptenroll --fido2-device=$method --fido2-credential-algorithm=eddsa $2
    expect {
# Don't send the password unconditionally because it is cached for a while
# and it might not be requested when retrying.
      passphrase {
        send "\t"
        expect "(no echo)" { send "$pass\r" }
        exp_continue
      }
      PIN { interact }
    }
    lassign [wait] pid spawnid os_error_flag value
    if { !\$value } break
  }
  EOF
# systemd-cryptenroll exits with 0 on ^C. Rather than trying to catch all the
# ways it could go wrong, let's just check that everything went as expected.
      cryptsetup luksDump --dump-json-metadata $2 |
          jq -e '.tokens["0"]["fido2-clientPin-required"]' >/dev/null || {
        echo "ERROR setting up encryption: no FIDO2 token enrolled or PIN not required."
        false
      }
    }

    trap 'echo Unrecoverable error.' 0
    echo -n "$pass" |cryptsetup open --allow-discards -d - $2 $dm
    [ $method = passwd ] || cryptsetup luksKillSlot -q $2 1
    unset pass

    read m m kb </proc/meminfo
    pvcreate /dev/mapper/$dm
    vgcreate vg /dev/mapper/$dm
    lvcreate -L $(( M - (m >> 12 << 2) - 4 ))M -n root vg
    lvcreate -l 100%FREE -n swap vg

    cd /tmp
    mkdir aptcache dst fs
    setup_btrfs () {
      udevadm wait $1
      mkfs.btrfs $force -K $1
      mount -o noatime $1 fs
      cd fs
      eval "$4"
      cd ..
      mount -o noatime,subvol=$2 $1 $3
      umount fs
    }
    progress () {
      printf '\rCopying... %s%%' $1
    }
    setup_btrfs /dev/mapper/vg-root @rootfs dst '
      read end </mnt/overlay/rootfs/send-size
      btrfs send /mnt/overlay/rootfs/@ |btrfs receive . &
      while sleep 1; read rchar pos </proc/$!/io; do
        progress $(( pos * 100 / end ))
      done 2>/dev/null
      wait
      progress 100
      echo
      btrfs sub snap @ $2
      btrfs sub delete @
      btrfs sub create @home'
    mount -o noatime,subvol=@home /dev/mapper/vg-root dst/home
    rm -r dst/boot/grub dst/boot/initrd*
    setup_btrfs $3 @ dst/boot '
      btrfs sub create $2
      btrfs sub set-default $2
      mv ../dst/boot/* $2
      [ ! "`find ../dst/boot -mindepth 1 2>&1`" ]' # assert no hidden file/dir
    rmdir fs

    cd dst
    mkfs.vfat $4
    mount -o noatime $4 boot/efi
    for x in dev dev/pts proc run sys tmp; do
      mount --bind /$x $x
      u="$x $u"
    done
    mount --bind /mnt/overlay/rootfs/@aptcache tmp/aptcache
# And keep propagating (see dracut-mount.sh).
    cp -a /etc/machine-id etc
    cp -a /etc/default/keyboard etc/default
    echo $dm UUID=`cryptsetup luksUUID $2` none luks,discard,x-initrd.attach$crypttab \
      >etc/crypttab
    chroot . /etc/opt/target.sh /dev/$dst
    umount tmp/aptcache $u boot/efi boot home
    . etc/locale.conf
    systemctl import-environment LANG
    cd ..
    umount dst
    whiptail --title "Installation complete" --msgbox "\
  Installation is complete, so it is time to boot into your new system. Once off,
  make sure to remove the installation media before turning on your new system.
  Then, you'll be invited to create & configure your user account.

  Press ENTER to power off." 0 0
    exec poweroff
  )
  exec bash

exec.slapos/@/etc/opt/target.sh =
  inline:#!/bin/sh -e
  rm /etc/opt/installer.sh /etc/opt/target.sh
  mp () {
    x=`findmnt -no UUID $1`
    echo UUID=$x "$@"
  }
  sw=/dev/mapper/vg-swap
  { mp / btrfs noatime,subvol=@rootfs
    mp /home btrfs noatime,subvol=@home
    mp /boot btrfs noatime,nofail
    mp /boot/efi vfat noatime,nofail,umask=0077
    echo $sw none swap nofail
  } >etc/fstab
  mkswap $sw
# echo RESUME=$sw >etc/initramfs-tools/conf.d/resume
  vgcfgbackup vg
  update-initramfs -ck all
  grub-install --target=x86_64-efi $1
  update-grub
  echo 'deb [trusted=yes] file:/tmp/aptcache ./' >/tmp/sources.list
  APT="/usr/bin/apt -yo Dpkg::options::=--force-unsafe-io \
    -o Dir::Etc::sourcelist=/tmp/sources.list -o Dir::Etc::sourceparts=-"
  $APT update
  $APT install `eval set en $SELECTED_LOCALES
    IFS=\|
    eval "f() { case \\\$1 in $*) echo \\\$2;; esac; }"
    IFS=:
    set /etc/opt/language-support
    while read a b c
    do f $a $c
    done <$1
    rm $1`

# XtraDeb also packages firefox, with a higher version number,
# so keep official repo higher priority than the default 500.
file.slapos/@/etc/apt/preferences.d/ubuntu =
  inline:Package: *
  Pin: release o=Ubuntu
  Pin-Priority: 510

exec.slapos/@/etc/opt/notepod-initial-user =
  inline:#!/usr/bin/python3
  import os
  from pydbus import SystemBus
  from gi.repository import GLib
  bus = SystemBus()
  addr = 'org.freedesktop.Accounts'
  accounts = bus.get(addr, '/org/freedesktop/Accounts')
  if accounts.HasNoUsers:
    loop = GLib.MainLoop()
    @accounts.UserAdded.connect
    def _(user):
      user = bus.get(addr, user)
      def changed(*_):
        if not user.Locked:
          user.SetAutomaticLogin(True)
          loop.quit()
      user.PropertiesChanged.connect(changed)
      changed()
    loop.run()
  x = '/etc/systemd/system/gdm.service.d'
  os.remove(x + '/notepod-initial-user.conf')
  os.rmdir(x)
  os.remove(__file__)

file.slapos/@/etc/systemd/system/gdm.service.d/notepod-initial-user.conf =
  inline:[Service]
  ExecStartPre=-/usr/bin/systemd-run /etc/opt/notepod-initial-user
