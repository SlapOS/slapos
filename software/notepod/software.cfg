[buildout]
extends =
  ../../stack/slapos.cfg
  ../../stack/monitor/buildout.cfg
  ubuntu.cfg
parts =
  slapos-cookbook
  monitor-eggs
  template

[installer]
recipe = slapos.recipe.build
init =
  import os
  vm = self.buildout['vm-ubuntu']
  img = options['img'] = vm['dists'] + '.img'
  self.img = os.path.join(vm['location'], img)
install =
  import gzip, hashlib, os, shutil
  from functools import partial
  img = options['img']
  h = hashlib.sha512()
  os.mkdir(location)
  with (open(self.img, 'rb') as src,
        gzip.open(os.path.join(location, img + '.gz'), 'wb') as dst):
    read = partial(src.read, shutil.COPY_BUFSIZE)
    write = dst.write
    update = h.update
    while buf := read():
        write(buf)
        update(buf)
  with open(os.path.join(location, 'SHA512SUMS'), 'w') as sums:
    print(h.hexdigest(), img, file=sums)
update =
  import os
  if os.path.getmtime(location) < os.path.getmtime(self.img):
    self.install()

[template]
recipe = slapos.recipe.template
output = ${buildout:directory}/template.cfg
inline =
  [buildout]
  extends = ${monitor2-template:output}
  parts = publish
  eggs-directory = ${buildout:eggs-directory}
  develop-eggs-directory = ${buildout:develop-eggs-directory}

  [slap-configuration]
  <= slap-connection
  recipe = slapos.cookbook:slapconfiguration.serialised

  [publish]
  <= monitor-publish
  recipe = slapos.cookbook:publish.serialised
  backend-url = $${installer-frontend:config-url}
  url = $${installer-frontend:connection-secure_access}

  [installer-frontend]
  <= monitor-frontend
  name = Installer Download Page Frontend
  config-url = $${monitor-httpd-conf-parameter:url}/notepod/

  [info]
  recipe = slapos.recipe.build
  init =
    import os
    options['size'] = str(os.path.getsize(options['img']))
  img = ${vm-ubuntu:location}/${vm-ubuntu:dists}.img

  [installer-conf]
  recipe = slapos.recipe.template
  output = ${buildout:directory}/etc/httpd-installer.conf
  inline =
    Alias /notepod ${installer:location}
    <Directory ${installer:location}>
      Options Indexes FollowSymLinks
      IndexOptions FancyIndexing NameWidth=* DescriptionWidth=*
      IndexIgnore ..
      AddDescription "uncompressed size: $${info:size}" *.gz
      AllowOverride None
      Order allow,deny
      Allow from all
    </Directory>

  [monitor-httpd-conf-parameter]
  httpd-include-file = $${installer-conf:output}
