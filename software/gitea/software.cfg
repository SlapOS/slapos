[buildout]
extends =
  ../../stack/slapos.cfg
  ../../stack/nodejs.cfg
  ../../stack/monitor/buildout.cfg
  ../../component/make/buildout.cfg
  ../../component/golang/buildout.cfg
  ../../component/openssl/buildout.cfg
  ../../component/curl/buildout.cfg
  ../../component/dash/buildout.cfg
  ../../component/postgresql/buildout.cfg
  ../../component/sqlite3/buildout.cfg
  buildout.hash.cfg
  gowork.cfg

versions = versions
parts =
  slapos-cookbook
  instance-profile
  gowork
  git
  postgresql
  gitea-config-file
;  gitea


[nodejs]
<= nodejs-10.6.0

[yarn]
# this could become a component, but it needs to be invoked from nodejs explicitly,
# otherwise it uses system's nodejs
recipe = slapos.recipe.build:download-unpacked
url = https://github.com/yarnpkg/yarn/releases/download/v1.16.0/yarn-v1.16.0.tar.gz
md5sum = 46790033c23803387890f545e4040690

[gitea]
recipe = slapos.recipe.cmmi
url = https://github.com/go-gitea/gitea/releases/download/v1.11.5/gitea-src-1.11.5.tar.gz
md5sum = a589686f187822fdd16ed3e1f7a57b14
environment = 
   PATH=${nodejs:location}/bin/:${golang1.12:location}/bin/:%(PATH)s
configure-command = false
make-targets = build


[gowork]
install = github.com/go-gitea/gitea
#github.com/gogs/gogs

# use recent go
golang  = ${golang1.12:location}

[gowork.goinstall]
command = :
depends =
  ${gitea-install:recipe}


[gitea-install]
<= gowork.goinstall
command = bash -c "
  export PATH=${nodejs:location}/bin:$PATH && \
  . ${gowork:env.sh} && \
  cd ${:gitea-src-dir} && \
  make build install"
update-command =
gitea-src-dir = ${gowork:directory}/src/${go_github.com_go-gitea_gitea:go.importpath}
gitea-bin = ${gowork:directory}/bin/gitea


[download-file-base]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:filename}
mode = 0644

[gitea-config-file]
<= download-file-base

[instance-profile]
recipe = slapos.recipe.template:jinja2
template = ${:_profile_base_location_}/${:filename}
rendered = ${buildout:directory}/instance.cfg
mode = 0644
extensions = jinja2.ext.do
context =
  section buildout buildout
  key openssl_bin openssl-output:openssl
  key curl_bin :curl-bin
  key dash_bin :dash-bin
  key gitea_bin :gitea-bin
  key gitea_static_root_path :gitea-static-root-path
  key git_bin :git-bin
  key gitea_environment_path :gitea-environment-path
  key postgresql_bin :postgresql-bin
  key monitor_template :monitor-template
curl-bin = ${curl:location}/bin/curl
dash-bin = ${dash:location}/bin/dash
gitea-bin = ${gitea-install:gitea-bin}
gitea-static-root-path = ${gitea-install:gitea-src-dir}
git-bin = ${git:location}/bin/git
postgresql-bin = ${postgresql10:location}/bin
monitor-template = ${monitor2-template:rendered}
gitea-environment-path = ${git:location}/bin/

[versions]
slapos.recipe.template = 4.2
inotifyx = 0.2.2
