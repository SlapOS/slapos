{% set parameter_dict = dict(default_parameter_dict, **slapparameter_dict) %}

[buildout]
parts =
    hugo-server
    port-listening-promise
    publish-connection-information
    hugo-server-graceful

eggs-directory = {{ buildout['eggs-directory'] }}
develop-eggs-directory = {{ buildout['develop-eggs-directory'] }}
local-directory = {{buildout['directory']}}
offline = true

extends = {{ parameter_list['template_monitor'] }}

# Create all needed directories, depending on your needs
[directory]
recipe = slapos.cookbook:mkdirectory
home = ${buildout:directory}
etc = ${:home}/etc
var = ${:home}/var
srv = ${:home}/srv

[basedirectory]
recipe = slapos.cookbook:mkdirectory
script = ${directory:etc}/run
service = ${directory:etc}/service
log = ${directory:var}/log
run = ${directory:var}/run
backup = ${directory:srv}/backup
data = ${directory:srv}/hugo

[tempdirectory]
recipe = slapos.cookbook:mkdirectory
tmp = ${directory:home}/tmp

[hugo]
nb-workers = 2

ip = {{ partition_ipv6 }}
port = {{ parameter_dict['port'] }}
access_url = http://[${:ip}]:${:port}

path_shell = {{ parameter_list['dash_location'] }}/bin/dash
go_environment = {{ parameter_list['go_environment'] }}

[hugo-server-graceful]
recipe = slapos.recipe.template:jinja2
template = {{ parameter_list['template_hugo_graceful'] }}
rendered = ${basedirectory:script}/hugo-graceful
mode = 0700
context =
    section param_hugo hugo

[hugo-server]
recipe = slapos.recipe.template:jinja2
template = {{ parameter_list['template_server'] }}
rendered = ${basedirectory:script}/hugo-server
mode = 0700
context =
    section param_hugo hugo
    key go_environment hugo:go_environment
    key base_url hugo-frontend:connection-secure_access

[port-listening-promise]
<= monitor-promise-base
module = check_socket_listening
name = hugo-port-listening.py
config-host = ${hugo:ip}
config-port = ${hugo:port}

[monitor-instance-parameter]
monitor-httpd-port = 8197

[publish-connection-information]
recipe = slapos.cookbook:publish
<= monitor-publish
server_url = ${hugo:access_url}
server-cdn-url = ${hugo-frontend-promise:url}

[hugo-frontend]
<= slap-connection
recipe = slapos.cookbook:requestoptional
name = Hugo frontend
software-url = http://git.erp5.org/gitweb/slapos.git/blob_plain/HEAD:/software/apache-frontend/software.cfg
slave = true
config-url = ${hugo:access_url}
config-https-only = true
return = domain secure_access

[hugo-frontend-promise]
<= monitor-promise-base
module = check_url_available
name = hugo-http-frontend.py
url = ${hugo-frontend:connection-secure_access}
config-url = ${:url}
config-check-secure = 1
