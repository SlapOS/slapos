[buildout]
parts =
    hugo-server
    publish-connection-information
    hugo-server-graceful
    nginx_conf
    mime_types
    nginx-launcher
    nginx-graceful
    port-listening-promise
    nginx-port-listening-promise
    logrotate-entry-nginx
    default_index_html
    default_config_toml
    
eggs-directory = {{ buildout['eggs-directory'] }}
develop-eggs-directory = {{ buildout['develop-eggs-directory'] }}
offline = true

extends = {{ parameter_list['template_monitor'] }}

[slap-configuration]
recipe = slapos.cookbook:slapconfiguration
computer = ${slap-connection:computer-id}
partition = ${slap-connection:partition-id}
url = ${slap-connection:server-url}
key = ${slap-connection:key-file}
cert = ${slap-connection:cert-file}
configuration.port = 8080
configuration.nginx-port = 8081
configuration.monitor-httpd-port = 8196
configuration.nginx-monitor-httpd-port =8197
configuration.site = default

# Create all needed directories, depending on your needs
[directory]
recipe = slapos.cookbook:mkdirectory
home = ${buildout:directory}
etc = ${:home}/etc
var = ${:home}/var
srv = ${:home}/srv

[basedirectory]
recipe = slapos.cookbook:mkdirectory
script = ${directory:etc}/run
service = ${directory:etc}/service
log = ${directory:var}/log
run = ${directory:var}/run
backup = ${directory:srv}/backup
data = ${directory:srv}/hugo
default-site = ${:data}/default
default-public = ${:default-site}/public

[tempdirectory]
recipe = slapos.cookbook:mkdirectory
tmp = ${directory:home}/tmp
client_body_temp_path = ${:tmp}/client_body_temp_path
proxy_temp_path = ${:tmp}/proxy_temp_path
fastcgi_temp_path = ${:tmp}/fastcgi_temp_path
uwsgi_temp_path = ${:tmp}/uwsgi_temp_path
scgi_temp_path = ${:tmp}/scgi_temp_path

[hugo]
nb-workers = 2

ip = ${slap-configuration:ipv6-random}
port = ${slap-configuration:configuration.port}
nginx-port = ${slap-configuration:configuration.nginx-port}

access_url = http://[${:ip}]:${:port}
nginx_access_url = http://[${:ip}]:${:nginx-port}

path_shell = {{ parameter_list['dash_location'] }}/bin/dash
go_environment = {{ parameter_list['go_environment'] }}

path_pid = ${basedirectory:run}/nginx.pid
path_log = ${basedirectory:log}/nginx.log
path_access_log = ${basedirectory:log}/nginx.access.log
path_error_log = ${basedirectory:log}/nginx.error.log
path_tmp = ${tempdirectory:tmp}

path_nginx_conf = ${directory:etc}/nginx.conf
path_mime_types = ${directory:etc}/mime_types
path_shell = {{ parameter_list['dash_location'] }}/bin/dash
path_nginx = {{ parameter_list['nginx_location'] }}/sbin/nginx

# Docroot
docroot = ${basedirectory:data}/${slap-configuration:configuration.site}/public

[hugo-server-graceful]
recipe = slapos.recipe.template:jinja2
template = {{ parameter_list['template_hugo_graceful'] }}
rendered = ${basedirectory:script}/hugo-graceful
mode = 0700
context =
    section param_hugo hugo

[hugo-server]
recipe = slapos.recipe.template:jinja2
template = {{ parameter_list['template_server'] }}
rendered = ${basedirectory:script}/hugo-server
mode = 0700
context =
    section param_hugo hugo
    key go_environment hugo:go_environment
    key base_url hugo-frontend:connection-secure_access
    key data basedirectory:data
    key ip hugo:ip
    key port hugo:port
    key site slap-configuration:configuration.site

[port-listening-promise]
<= monitor-promise-base
module = check_socket_listening
name = hugo-port-listening.py
config-host = ${hugo:ip}
config-port = ${hugo:port}

[monitor-instance-parameter]
monitor-httpd-port = ${slap-configuration:configuration.monitor-httpd-port}

[hugo-frontend]
<= slap-connection
recipe = slapos.cookbook:requestoptional
name = Hugo frontend
software-url = http://git.erp5.org/gitweb/slapos.git/blob_plain/HEAD:/software/apache-frontend/software.cfg
slave = true
config-url = ${hugo:access_url}
config-https-only = true
return = domain secure_access

[hugo-frontend-promise]
<= monitor-promise-base
module = check_url_available
name = hugo-http-frontend.py
url = ${hugo-frontend:connection-secure_access}
config-url = ${:url}
config-check-secure = 1

[nginx_conf]
recipe = slapos.recipe.template:jinja2
template = {{ parameter_list['template_nginx_conf'] }}
rendered = ${hugo:path_nginx_conf}
context = 
    section param_hugo hugo
    section param_tempdir tempdirectory

[mime_types]
recipe = slapos.recipe.template:jinja2
template = {{ parameter_list['template_mime_types'] }}
rendered = ${hugo:path_mime_types}

[nginx-launcher]
recipe = slapos.cookbook:wrapper
command-line = {{ parameter_list['nginx_location'] }}/sbin/nginx -c ${hugo:path_nginx_conf}
wrapper-path = ${basedirectory:service}/nginx

[default_index_html]
recipe = slapos.recipe.template:jinja2
template = {{ parameter_list['template_index_html'] }}
rendered = ${basedirectory:default-public}/index.html
context =
  key go_environment hugo:go_environment
  key data basedirectory:data

[default_config_toml]
recipe = slapos.recipe.template:jinja2
template = {{ parameter_list['template_config_toml'] }}
rendered = ${basedirectory:data}/config.toml
context =
    key base_url hugo-frontend:connection-secure_access

[nginx-graceful]
recipe = slapos.recipe.template:jinja2
template = {{ parameter_list['template_graceful'] }}
rendered = ${basedirectory:script}/nginx-graceful
mode = 0700
context =
    section param_hugo hugo

[nginx-port-listening-promise]
<= monitor-promise-base
module = check_socket_listening
name = nginx-port-listening.py
config-host = ${hugo:ip}
config-port = ${hugo:nginx-port}

[monitor-instance-parameter]
monitor-httpd-port = ${slap-configuration:configuration.nginx-monitor-httpd-port}

[logrotate-entry-nginx]
<= logrotate-entry-base
name = nginx
log = ${hugo:path_access_log} ${hugo:path_error_log}
post = kill -USR1 $(cat ${hugo:path_pid})

[nginx-frontend]
<= slap-connection
recipe = slapos.cookbook:requestoptional
name = Hugo Nginx frontend
software-url = http://git.erp5.org/gitweb/slapos.git/blob_plain/HEAD:/software/apache-frontend/software.cfg
slave = true
config-url = ${hugo:nginx_access_url}
config-https-only = true
return = domain secure_access

[nginx-frontend-promise]
<= monitor-promise-base
module = check_url_available
name = nginx-http-frontend.py
url = ${nginx-frontend:connection-secure_access}
config-url = ${:url}
config-check-secure = 1

[publish-connection-information]
recipe = slapos.cookbook:publish
<= monitor-publish
go_environment = ${hugo:go_environment}
data = ${basedirectory:data}
hugo_server_url = ${hugo:access_url}
nginx_server_url = ${hugo:nginx_access_url}
hugo-server-cdn-url = ${hugo-frontend-promise:url}
nginx-server-cdn-url = ${nginx-frontend-promise:url}
