[buildout]
parts =
  directory
  development-yaml
  production-yaml
  config-yaml
  service

eggs-directory = {{ buildout['eggs-directory'] }}
develop-eggs-directory = {{ buildout['develop-eggs-directory'] }}
offline = true

extends = {{ parameter_list['template_monitor'] }}

[directory]
recipe = slapos.cookbook:mkdirectory
var = ${buildout:directory}/var
log = ${buildout:directory}/var/log
etc = ${buildout:directory}/etc
cfg = ${buildout:directory}/etc/qdrant/config

[qdrant-config]
path-development-yaml = ${directory:cfg}/development.yaml
path-production-yaml = ${directory:cfg}/production.yaml
path-config-yaml = ${directory:cfg}/config.yaml

[development-yaml]
recipe = slapos.recipe.template:jinja2
url = {{ parameter_list['template_development_yaml'] }}
output = ${qdrant-config:path-development-yaml}
context =
  key http_port {{ parameter_list['http_port'] }}
  key grpc_port {{ parameter_list['grpc_port'] }}

[production-yaml]
recipe = slapos.recipe.template:jinja2
url = {{ parameter_list['template_production_yaml'] }}
output = ${qdrant-config:path-production-yaml}
context =
  key http_port {{ parameter_list['http_port'] }}
  key grpc_port {{ parameter_list['grpc_port'] }}

[config-yaml]
recipe = slapos.recipe.template:jinja2
url = {{ parameter_list['template_config_yaml'] }}
output = ${qdrant-config:path-config-yaml}
context =
  key http_port {{ parameter_list['http_port'] }}
  key grpc_port {{ parameter_list['grpc_port'] }}

[service]
recipe = slapos.cookbook:wrapper
command-line =
  {{ parameter_list['qdrant_bin'] }} \
    --config-path ${directory:cfg}/config.yaml \
    > ${directory:log}/qdrant.log 2>&1
wrapper-path = ${directory:etc}/run_qdrant