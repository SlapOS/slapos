[buildout]
extends =
  buildout.hash.cfg
  ../../stack/slapos.cfg
  ../../stack/monitor/buildout.cfg
  ../../component/rust/buildout.cfg
  ../../component/protobuf/buildout.cfg
  ../../component/llvm/buildout.cfg

parts =
  slapos-cookbook
  qdrant
  template-cfg

[qdrant]
<= protobuf-21.12
recipe = slapos.recipe.cmmi
shared = true
url = https://github.com/qdrant/qdrant/archive/refs/tags/v1.11.5.tar.gz
md5sum = c72147a13cf01615720697eac81265e9
configure-command = :
make-binary = cargo install --root=%(location)s --path . --locked
make-targets =
environment =
  PATH=${rustc:location}/bin:%(PATH)s
  LIBCLANG_PATH=${llvm:location}/lib
  LLVM_CONFIG_PATH=${llvm:location}/bin
  BINDGEN_EXTRA_CLANG_ARGS="-I${llvm:location}/lib/clang/19/include"
  PROTOC=${protobuf-21.12:location}/bin/protoc

[profile-common]
qdrant_bin = ${qdrant:location}/bin/qdrant
template_development_yaml = ${template_development_yaml:target}
template_production_yaml = ${template_production_yaml:target}
template_config_yaml = ${template_config_yaml:target}
template_monitor = ${monitor-template:output}
http_port = 6333
grpc_port = 6334

[template-cfg]
recipe = slapos.recipe.template:jinja2
output = ${buildout:directory}/template.cfg
url = ${:_profile_base_location_}/${:filename}
context =
  section buildout buildout
  section parameter_list profile-common

[download-base]
recipe = slapos.recipe.build:download
url = ${:_profile_base_location_}/${:_update_hash_filename_}

[template_development_yaml]
<= download-base

[template_production_yaml]
<= download-base

[template_config_yaml]
<= download-base
